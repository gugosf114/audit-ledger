<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Newton - AI Governance Platform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-hover: #1a1a25;
      --bg-active: #252535;
      --border: rgba(255,255,255,0.08);
      --border-hover: rgba(255,255,255,0.15);
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --safe: #10b981;
      --watch: #f59e0b;
      --action: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* ===== NAVIGATION ===== */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: rgba(10, 10, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 100;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      text-decoration: none;
      cursor: pointer;
    }

    .nav-brand-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-link {
      padding: 10px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-link:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .nav-link.active {
      color: var(--text-primary);
      background: var(--bg-active);
    }

    .nav-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border-radius: 20px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--safe);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ===== HERO PULSE BAR ===== */
    .pulse-bar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 24px;
      z-index: 99;
    }

    .pulse-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pulse-section.center {
      justify-content: center;
    }

    .pulse-section.right {
      justify-content: flex-end;
    }

    .chain-visualizer {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chain-block {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--safe);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      transition: all 0.3s;
    }

    .chain-connector {
      width: 8px;
      height: 2px;
      background: var(--safe);
    }

    .pulse-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pulse-value {
      font-size: 14px;
      font-weight: 600;
    }

    .pulse-value.verified { color: var(--safe); }
    .pulse-value.broken { color: var(--action); }

    .pulse-subtext {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pulse-counter {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .pulse-counter-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
    }

    .pulse-counter-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .pulse-alert {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      max-width: 350px;
    }

    .pulse-alert-icon {
      font-size: 18px;
    }

    .pulse-alert-text {
      font-size: 13px;
      flex: 1;
    }

    .economic-impact {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 8px;
    }

    .economic-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--safe);
    }

    .economic-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* ===== ROLE SELECTOR ===== */
    .role-bar {
      position: fixed;
      top: 140px;
      left: 0;
      right: 0;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
      padding: 12px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      z-index: 98;
    }

    .role-selector {
      display: flex;
      gap: 4px;
      background: var(--bg-dark);
      padding: 4px;
      border-radius: 8px;
    }

    .role-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-btn:hover {
      color: var(--text-secondary);
    }

    .role-btn.active {
      background: var(--accent);
      color: white;
    }

    .role-filters {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .role-filter-select {
      padding: 8px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 12px;
    }

    .role-identity {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ===== MAIN CONTENT ===== */
    .main {
      padding-top: 100px;
      min-height: 100vh;
    }

    /* Hide the pulse-bar and role-bar - causing overlap issues */
    .pulse-bar, .role-bar {
      display: none;
    }

    .page {
      display: none;
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== HOME PAGE ===== */
    .hero {
      text-align: center;
      padding: 60px 0;
    }

    .hero-title {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #fff, #a0a0b0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle {
      font-size: 20px;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto 40px;
    }

    .hero-stats {
      display: flex;
      justify-content: center;
      gap: 48px;
      margin-bottom: 60px;
    }

    .hero-stat {
      text-align: center;
    }

    .hero-stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
    }

    .hero-stat-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ===== SECTION TITLE ===== */
    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    /* ===== CAPABILITY CARDS ===== */
    .capabilities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 60px;
    }

    .capability-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .capability-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .capability-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .capability-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      background: var(--bg-hover);
    }

    .capability-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .capability-status.active {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .capability-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .capability-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .capability-features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .capability-feature {
      padding: 6px 12px;
      background: var(--bg-hover);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .capability-action {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .capability-action-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .capability-action-btn:hover {
      background: var(--accent-hover);
    }

    /* ===== TABLES ===== */
    .ledger-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .ledger-filters {
      display: flex;
      gap: 12px;
    }

    .filter-select {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .ledger-search {
      display: flex;
      gap: 8px;
    }

    .ledger-search input {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      width: 280px;
    }

    .ledger-table {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .ledger-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .ledger-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
    }

    .ledger-table td {
      padding: 16px 20px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    .ledger-table tr:last-child td {
      border-bottom: none;
    }

    .ledger-table tr:hover td {
      background: var(--bg-hover);
    }

    .ledger-uuid {
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }

    .ledger-event-type {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      background: var(--bg-hover);
    }

    .ledger-confidence {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .confidence-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .confidence-dot.known-known { background: var(--safe); }
    .confidence-dot.known-unknown { background: var(--watch); }
    .confidence-dot.unknown-unknown { background: var(--action); }

    /* ===== WORKFLOWS PAGE ===== */
    .workflows-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .workflow-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .workflow-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }

    .workflow-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .workflow-card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .workflow-card-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .workflow-card-status.active {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .workflow-card-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .workflow-card-meta {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .workflow-card-progress {
      height: 6px;
      background: var(--bg-hover);
      border-radius: 3px;
      overflow: hidden;
    }

    .workflow-card-progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .workflow-card-stats {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ===== WORKFLOW DETAIL ===== */
    .workflow-header {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .workflow-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .workflow-client-name {
      font-size: 24px;
      font-weight: 700;
    }

    .workflow-header-meta {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .workflow-meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .workflow-meta-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .workflow-meta-value {
      font-size: 14px;
      font-weight: 500;
    }

    .checklist-category {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .checklist-category-header {
      padding: 16px 20px;
      background: var(--bg-hover);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .checklist-category-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checklist-category-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .checklist-category-body {
      padding: 0;
    }

    .checklist-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checklist-item-name {
      font-size: 14px;
    }

    .checklist-item-status {
      width: 140px;
    }

    .checklist-item-confidence {
      width: 180px;
    }

    .checklist-item-actions {
      display: flex;
      gap: 8px;
    }

    .checklist-select {
      padding: 8px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 12px;
      width: 100%;
      cursor: pointer;
    }

    .checklist-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .checklist-btn {
      padding: 8px 12px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checklist-btn:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }

    .checklist-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* ===== TOOLTIP ===== */
    .tooltip-container {
      position: relative;
    }

    .tooltip-container:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-dark);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 50;
      margin-bottom: 8px;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--bg-hover);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-hint {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-hover);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    /* ===== LOADING ===== */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== TOAST ===== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      padding: 16px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-color: var(--safe); }
    .toast.error { border-color: var(--action); }
    .toast.warning { border-color: var(--watch); }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 14px;
      margin-bottom: 24px;
    }

    /* ===== DAY COUNTER ===== */
    .day-counter-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .day-counter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .day-counter-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .day-counter-title-icon {
      font-size: 24px;
    }

    .day-counter-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .day-stat-card {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .day-stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .day-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .day-stat-value.safe { color: var(--safe); }
    .day-stat-value.caution { color: var(--watch); }
    .day-stat-value.warning { color: #f97316; }
    .day-stat-value.danger { color: var(--action); }

    .day-progress-container {
      margin-bottom: 24px;
    }

    .day-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .day-progress-label {
      font-size: 14px;
      font-weight: 600;
    }

    .day-progress-value {
      font-size: 14px;
      font-family: 'SF Mono', 'Consolas', monospace;
    }

    .day-progress-bar {
      height: 24px;
      background: var(--bg-dark);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .day-progress-fill {
      height: 100%;
      border-radius: 12px;
      transition: width 0.5s ease, background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .day-progress-fill.safe { background: linear-gradient(90deg, #059669, var(--safe)); }
    .day-progress-fill.caution { background: linear-gradient(90deg, #d97706, var(--watch)); }
    .day-progress-fill.warning { background: linear-gradient(90deg, #ea580c, #f97316); }
    .day-progress-fill.danger { background: linear-gradient(90deg, #dc2626, var(--action)); }

    .day-progress-markers {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .day-progress-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .day-progress-marker-line {
      width: 1px;
      height: 6px;
      background: var(--text-muted);
      margin-bottom: 2px;
    }

    .day-alert-banner {
      padding: 12px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .day-alert-banner.safe {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--safe);
    }

    .day-alert-banner.caution {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--watch);
    }

    .day-alert-banner.warning {
      background: rgba(249, 115, 22, 0.1);
      border: 1px solid rgba(249, 115, 22, 0.3);
      color: #f97316;
    }

    .day-alert-banner.danger {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--action);
    }

    .day-alert-icon {
      font-size: 20px;
    }

    .day-entry-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
    }

    .day-entry-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .day-entry-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .day-entry-input {
      padding: 10px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 14px;
    }

    .day-entry-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .day-entry-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .day-entry-btn:hover {
      background: var(--accent-hover);
    }

    .day-entries-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .day-entries-header {
      display: grid;
      grid-template-columns: 120px 80px 120px 1fr 60px;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-hover);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .day-entry-row {
      display: grid;
      grid-template-columns: 120px 80px 120px 1fr 60px;
      gap: 12px;
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .day-entry-row:last-child {
      border-bottom: none;
    }

    .day-entry-row:hover {
      background: var(--bg-hover);
    }

    .day-entry-location {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .day-entry-location.ca {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .day-entry-location.other {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .day-entry-delete {
      padding: 6px 10px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-entry-delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--action);
      color: var(--action);
    }

    .day-bulk-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .day-bulk-toggle input {
      accent-color: var(--accent);
    }

    .day-bulk-form {
      display: none;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .day-bulk-form.active {
      display: block;
    }

    .day-bulk-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 13px;
      font-family: 'SF Mono', 'Consolas', monospace;
      resize: vertical;
      margin-bottom: 12px;
    }

    .day-bulk-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* ===== WORKFLOW TABS ===== */
    .workflow-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-hover);
      padding: 4px;
      border-radius: 10px;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .workflow-tab {
      padding: 10px 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .workflow-tab:hover {
      color: var(--text-secondary);
      background: var(--bg-active);
    }

    .workflow-tab.active {
      background: var(--accent);
      color: white;
    }

    .workflow-tab-content {
      display: none;
    }

    .workflow-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* ===== SAFE HARBOR SECTION ===== */
    .safe-harbor-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .safe-harbor-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .safe-harbor-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .safe-harbor-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .safe-harbor-badge.eligible {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .safe-harbor-badge.ineligible {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .safe-harbor-badge.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .safe-harbor-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .safe-harbor-metric {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
    }

    .safe-harbor-metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .safe-harbor-metric-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .safe-harbor-metric-status {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .safe-harbor-metric-status.pass {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .safe-harbor-metric-status.fail {
      background: rgba(239, 68, 68, 0.2);
      color: var(--action);
    }

    .safe-harbor-metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .safe-harbor-metric-target {
      font-size: 12px;
      color: var(--text-muted);
    }

    .safe-harbor-progress {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      margin-top: 12px;
      overflow: hidden;
    }

    .safe-harbor-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .safe-harbor-contract {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .safe-harbor-contract-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .safe-harbor-contract-title {
      font-size: 14px;
      font-weight: 600;
    }

    .safe-harbor-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .safe-harbor-form-full {
      grid-column: 1 / -1;
    }

    .safe-harbor-requirements {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .safe-harbor-requirement {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: var(--bg-hover);
      border-radius: 8px;
    }

    .safe-harbor-requirement-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .safe-harbor-requirement-icon.pass {
      background: var(--safe);
      color: white;
    }

    .safe-harbor-requirement-icon.fail {
      background: var(--action);
      color: white;
    }

    .safe-harbor-requirement-icon.pending {
      background: var(--watch);
      color: white;
    }

    .safe-harbor-requirement-text {
      font-size: 13px;
    }

    .safe-harbor-requirement-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .safe-harbor-requirement-desc {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* ===== EVIDENCE REPOSITORY ===== */
    .evidence-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .evidence-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .evidence-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .evidence-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
    }

    .evidence-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
    }

    .evidence-stat-count {
      font-weight: 600;
      color: var(--text-primary);
    }

    .evidence-categories {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .evidence-category {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .evidence-category:hover {
      border-color: var(--border-hover);
    }

    .evidence-category.active {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .evidence-category-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .evidence-category-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .evidence-category-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .evidence-upload-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .evidence-upload-zone:hover {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.05);
    }

    .evidence-upload-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .evidence-upload-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .evidence-upload-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .evidence-list {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .evidence-item {
      display: grid;
      grid-template-columns: 40px 1fr auto auto auto;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .evidence-item:last-child {
      border-bottom: none;
    }

    .evidence-item-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-hover);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .evidence-item-info {
      min-width: 0;
    }

    .evidence-item-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .evidence-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .evidence-item-category {
      padding: 4px 10px;
      background: var(--bg-hover);
      border-radius: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .evidence-item-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .evidence-item-status.verified {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .evidence-item-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    /* ===== REALIZATION EVENTS TIMELINE ===== */
    .timeline-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .timeline-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timeline-info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--info);
    }

    .timeline-form {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 12px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
      align-items: end;
    }

    .timeline-events {
      position: relative;
      padding-left: 30px;
    }

    .timeline-events::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-event {
      position: relative;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -24px;
      top: 20px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid var(--bg-dark);
    }

    .timeline-event.realized::before {
      background: var(--action);
    }

    .timeline-event.pending::before {
      background: var(--watch);
    }

    .timeline-event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .timeline-event-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .timeline-event-type {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .timeline-event-type.stock {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .timeline-event-type.rsu {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .timeline-event-type.sale {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .timeline-event-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .timeline-event-amount {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .timeline-event-details {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ===== ADDRESS TIMELINE ===== */
    .address-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .address-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
      align-items: end;
    }

    .address-timeline {
      position: relative;
    }

    .address-entry {
      display: grid;
      grid-template-columns: 120px 1fr 100px 60px;
      gap: 16px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .address-entry-dates {
      font-size: 12px;
      color: var(--text-muted);
    }

    .address-entry-current {
      font-weight: 600;
      color: var(--safe);
    }

    .address-entry-info {
      font-size: 14px;
    }

    .address-entry-street {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .address-entry-city {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .address-entry-type {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }

    .address-entry-type.primary {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .address-entry-type.secondary {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .address-entry-type.business {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    /* ===== THIRD PARTY REQUESTS ===== */
    .requests-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .requests-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .requests-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .requests-info {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--watch);
    }

    .requests-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
      align-items: end;
    }

    .requests-list {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .request-item {
      display: grid;
      grid-template-columns: 1fr 120px 120px 100px 60px;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .request-item:last-child {
      border-bottom: none;
    }

    .request-item-entity {
      font-size: 14px;
      font-weight: 600;
    }

    .request-item-type {
      font-size: 12px;
      color: var(--text-muted);
    }

    .request-item-date {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .request-item-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }

    .request-item-status.sent {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .request-item-status.received {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .request-item-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .request-item-status.overdue {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    /* ===== BRAGG FRAMEWORK SECTION ===== */
    .framework-section {
      margin-bottom: 48px;
    }

    .framework-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .framework-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .framework-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 600px;
    }

    .framework-source {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .framework-source strong {
      color: var(--text-secondary);
    }

    .bragg-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .bragg-factor {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      transition: all 0.2s;
    }

    .bragg-factor:hover {
      border-color: var(--border-hover);
    }

    .bragg-factor-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .bragg-factor-number {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .bragg-factor-number.highest {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .bragg-factor-number.moderate {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .bragg-factor-number.least {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .bragg-factor-number.corroborative {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .bragg-factor-name {
      font-size: 14px;
      font-weight: 600;
      flex: 1;
    }

    .bragg-factor-weight {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .bragg-factor-weight.highest {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .bragg-factor-weight.moderate {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .bragg-factor-weight.least {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .bragg-factor-weight.corroborative {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .bragg-factor-desc {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* ===== FEATURE MAP (BAYCOMPLY STYLE) ===== */
    .feature-map {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 48px;
    }

    .feature-map-header {
      padding: 20px 24px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
    }

    .feature-map-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .feature-map-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .feature-map-table {
      width: 100%;
    }

    .feature-map-row {
      display: grid;
      grid-template-columns: 200px 1fr;
      border-bottom: 1px solid var(--border);
    }

    .feature-map-row:last-child {
      border-bottom: none;
    }

    .feature-map-feature {
      padding: 16px 24px;
      font-size: 14px;
      font-weight: 600;
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      gap: 10px;
      border-right: 1px solid var(--border);
    }

    .feature-map-icon {
      font-size: 18px;
    }

    .feature-map-desc {
      padding: 16px 24px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* ===== WEIGHT LEGEND ===== */
    .weight-legend {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .weight-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .weight-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .weight-legend-dot.highest { background: var(--action); }
    .weight-legend-dot.moderate { background: var(--watch); }
    .weight-legend-dot.least { background: var(--info); }
    .weight-legend-dot.corroborative { background: var(--accent); }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a class="nav-brand" onclick="showPage('home')">
      <div class="nav-brand-icon">N</div>
      Newton
    </a>

    <div class="nav-links">
      <a class="nav-link active" onclick="showPage('home')" data-page="home">Home</a>
      <a class="nav-link" onclick="showPage('workflows')" data-page="workflows">Workflows</a>
      <a class="nav-link" onclick="showPage('ledger')" data-page="ledger">Audit Ledger</a>
    </div>

    <div class="nav-status">
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span id="systemStatus">System Active</span>
      </div>
    </div>
  </nav>

  <!-- Hero Pulse Bar -->
  <div class="pulse-bar" id="pulseBar">
    <div class="pulse-section">
      <div>
        <div class="pulse-label">Ledger Integrity</div>
        <div class="chain-visualizer" id="chainVisualizer">
          <div class="chain-block">1</div>
          <div class="chain-connector"></div>
          <div class="chain-block">2</div>
          <div class="chain-connector"></div>
          <div class="chain-block">3</div>
          <div class="chain-connector"></div>
          <div class="chain-block">4</div>
          <div class="chain-connector"></div>
          <div class="chain-block">5</div>
        </div>
        <div class="pulse-subtext" id="chainStatus">Verified: 0 rows</div>
      </div>
      <div class="economic-impact">
        <div>
          <div class="economic-value" id="economicValue">$0</div>
          <div class="economic-label">Exposure Prevented</div>
        </div>
      </div>
    </div>

    <div class="pulse-section center">
      <div class="pulse-counter">
        <div class="pulse-counter-value" id="pulseWorkflows">0</div>
        <div class="pulse-counter-label">Active Workflows</div>
      </div>
    </div>

    <div class="pulse-section right">
      <div class="pulse-alert" id="priorityAlert">
        <span class="pulse-alert-icon">&#10003;</span>
        <span class="pulse-alert-text" id="alertText">All systems operational</span>
      </div>
    </div>
  </div>

  <!-- Role Selector Bar -->
  <div class="role-bar">
    <div class="role-selector">
      <button class="role-btn active" data-role="briefing">Briefing</button>
      <button class="role-btn" data-role="exec">Exec</button>
      <button class="role-btn" data-role="compliance">Compliance</button>
      <button class="role-btn" data-role="engineer">Engineer</button>
    </div>
    <div class="role-filters">
      <select class="role-filter-select" id="timeFilter">
        <option value="24h">Last 24 Hours</option>
        <option value="7d" selected>Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
      </select>
      <span class="role-identity" id="userIdentity">Actor: System</span>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main">

    <!-- HOME PAGE -->
    <div class="page active" id="page-home">
      <div class="hero">
        <h1 class="hero-title">CA Residency Audit Defense</h1>
        <p class="hero-subtitle">Pre-audit documentation platform built on the 19 Bragg factors. Hash-chained evidence trails for FTB audit readiness.</p>

        <div class="hero-stats">
          <div class="hero-stat">
            <div class="hero-stat-value" id="statEntries">0</div>
            <div class="hero-stat-label">Audit Entries</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-value" id="statWorkflows">0</div>
            <div class="hero-stat-label">Active Clients</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-value">19</div>
            <div class="hero-stat-label">Bragg Factors</div>
          </div>
        </div>
      </div>

      <!-- FEATURE MAP (BAYCOMPLY STYLE) -->
      <div class="feature-map">
        <div class="feature-map-header">
          <div class="feature-map-title">How It Works</div>
          <div class="feature-map-subtitle">Every action maps to an audit-ready evidence chain</div>
        </div>
        <div class="feature-map-table">
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128197;</span> Day Counter</div>
            <div class="feature-map-desc">Track CA presence against the 183-day statutory threshold. Auto-alerts at Safe/Caution/Warning levels.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128737;</span> Safe Harbor</div>
            <div class="feature-map-desc">546-day employment contract tracking. Monitors 45-day CA visit limit and $200K intangible income threshold per R&TC 17014(d).</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#127968;</span> Address Timeline</div>
            <div class="feature-map-desc">Document all residences with dates. Compare CA vs non-CA homes for the "closer connections" test.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128200;</span> Realization Events</div>
            <div class="feature-map-desc">RSU vests, stock sales, option exercises. Source-rule documentation for CA-apportioned income.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128193;</span> Evidence Vault</div>
            <div class="feature-map-desc">Upload documents with category tagging. Official, records, digital, third-party classifications.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128231;</span> 3rd Party Requests</div>
            <div class="feature-map-desc">Track confirmation letters from employers, banks, utilities. Status workflow: Pending  Sent  Received.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128274;</span> Audit Trail</div>
            <div class="feature-map-desc">SHA-256 hash-chained ledger. Every entry links cryptographically. Tampering breaks the chain.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#127919;</span> Confidence Protocol</div>
            <div class="feature-map-desc">Declare KNOWN_KNOWN, KNOWN_UNKNOWN, or UNKNOWN_UNKNOWN before logging. No retroactive softening.</div>
          </div>
        </div>
      </div>

      <!-- BRAGG FACTORS FRAMEWORK -->
      <div class="framework-section">
        <div class="framework-header">
          <div>
            <h2 class="framework-title">The 19 Bragg Factors</h2>
            <p class="framework-subtitle">The foundation for CA residency analysis. FTB examines these factors holistically - no single factor is determinative, but some carry more weight.</p>
          </div>
          <div class="framework-source">
            <strong>Source:</strong> Appeal of Bragg (2003)<br>
            <strong>See also:</strong> FTB RSTM 1030, 1040
          </div>
        </div>

        <div class="weight-legend">
          <div class="weight-legend-item"><div class="weight-legend-dot highest"></div> Highest Weight</div>
          <div class="weight-legend-item"><div class="weight-legend-dot moderate"></div> Moderate Weight</div>
          <div class="weight-legend-item"><div class="weight-legend-dot least"></div> Least Weight</div>
          <div class="weight-legend-item"><div class="weight-legend-dot corroborative"></div> Corroborative</div>
        </div>

        <div class="bragg-grid">
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">1</div>
              <span class="bragg-factor-name">Physical Presence</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Amount of time spent in CA vs outside. 183+ days triggers statutory presumption.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">2</div>
              <span class="bragg-factor-name">Location of Spouse/RDP</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Where your spouse or registered domestic partner resides.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">3</div>
              <span class="bragg-factor-name">Location of Minor Children</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Where minor children reside and attend school.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">4</div>
              <span class="bragg-factor-name">Principal Residence</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Comparison of CA home vs new state home (size, value, furnishing).</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">5</div>
              <span class="bragg-factor-name">Employment</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Location of principal employment or business operations.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">6</div>
              <span class="bragg-factor-name">Business Interests</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Location of business interests and level of participation.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">7</div>
              <span class="bragg-factor-name">Real Property</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Ownership of real estate in CA vs elsewhere.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">8</div>
              <span class="bragg-factor-name">Bank Accounts</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Location of bank accounts and financial institutions used.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">9</div>
              <span class="bragg-factor-name">Investment Accounts</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Location of brokerage and investment accounts.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">10</div>
              <span class="bragg-factor-name">Professional Licenses</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">States where professional licenses are held (bar, CPA, medical, etc.).</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number least">11</div>
              <span class="bragg-factor-name">Motor Vehicle Registration</span>
              <span class="bragg-factor-weight least">Least</span>
            </div>
            <div class="bragg-factor-desc">Where vehicles are registered. Easy to change but still documented.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number least">12</div>
              <span class="bragg-factor-name">Driver's License</span>
              <span class="bragg-factor-weight least">Least</span>
            </div>
            <div class="bragg-factor-desc">State of driver's license. Formality but must be consistent.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number least">13</div>
              <span class="bragg-factor-name">Voter Registration</span>
              <span class="bragg-factor-weight least">Least</span>
            </div>
            <div class="bragg-factor-desc">Where registered to vote. Formality but signals intent.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">14</div>
              <span class="bragg-factor-name">Club Memberships</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Country clubs, gyms, social organizations. Shows community ties.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">15</div>
              <span class="bragg-factor-name">Religious Organizations</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Church, temple, mosque memberships and participation.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">16</div>
              <span class="bragg-factor-name">Professional Services</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Location of doctors, dentists, accountants, attorneys.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">17</div>
              <span class="bragg-factor-name">Mailing Address</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Where mail is received. USPS change of address documentation.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">18</div>
              <span class="bragg-factor-name">Safe Deposit Boxes</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Location of safe deposit boxes and valuables storage.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">19</div>
              <span class="bragg-factor-name">Personal Property</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Location of furniture, art, valuables, and heirlooms.</div>
          </div>
        </div>
      </div>

      <!-- CTA SECTION -->
      <div class="capabilities-grid">
        <div class="capability-card" onclick="showPage('workflows')">
          <div class="capability-header">
            <div class="capability-icon">&#128203;</div>
            <span class="capability-status active">Active</span>
          </div>
          <h3 class="capability-title">Start a Workflow</h3>
          <p class="capability-description">Create a client workflow to track all 19 factors with evidence collection and hash-chained audit trail.</p>
          <div class="capability-action">
            <button class="capability-action-btn">View Workflows</button>
          </div>
        </div>
        <div class="capability-card" onclick="showPage('ledger')">
          <div class="capability-header">
            <div class="capability-icon">&#128274;</div>
            <span class="capability-status active">Active</span>
          </div>
          <h3 class="capability-title">Audit Ledger</h3>
          <p class="capability-description">View the tamper-evident log of all entries. Every action is hash-chained for integrity verification.</p>
          <div class="capability-action">
            <button class="capability-action-btn">View Ledger</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKFLOWS PAGE -->
    <div class="page" id="page-workflows">
      <div class="section-header">
        <h1 class="section-title">Residency Workflows</h1>
        <button class="btn btn-primary" onclick="showModal('newWorkflow')">+ New Client</button>
      </div>

      <div class="workflows-grid" id="workflowsGrid">
        <div class="empty-state">
          <div class="empty-state-icon">&#128203;</div>
          <div class="empty-state-title">No workflows yet</div>
          <div class="empty-state-text">Create your first client workflow to start tracking residency changes.</div>
          <button class="btn btn-primary" onclick="showModal('newWorkflow')">+ New Client</button>
        </div>
      </div>
    </div>

    <!-- WORKFLOW DETAIL PAGE -->
    <div class="page" id="page-workflow-detail">
      <div class="workflow-header">
        <div class="workflow-header-top">
          <div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
              <a href="#" onclick="showPage('workflows')" style="color: var(--accent); text-decoration: none;">&#8592; Back to Workflows</a>
            </div>
            <h1 class="workflow-client-name" id="workflowClientName">Client Name</h1>
          </div>
          <span class="workflow-card-status active" id="workflowStatus">Active</span>
        </div>
        <div class="workflow-header-meta">
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">From</span>
            <span class="workflow-meta-value" id="workflowFrom">California</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">To</span>
            <span class="workflow-meta-value" id="workflowTo">Nevada</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Move Date</span>
            <span class="workflow-meta-value" id="workflowMoveDate">-</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Progress</span>
            <span class="workflow-meta-value" id="workflowProgress">0%</span>
          </div>
        </div>
      </div>

      <!-- WORKFLOW TABS -->
      <div class="workflow-tabs" id="workflowTabs">
        <button class="workflow-tab active" onclick="showWorkflowTab('dayCounter')">Day Counter</button>
        <button class="workflow-tab" onclick="showWorkflowTab('safeHarbor')">Safe Harbor</button>
        <button class="workflow-tab" onclick="showWorkflowTab('addresses')">Addresses</button>
        <button class="workflow-tab" onclick="showWorkflowTab('evidence')">Evidence</button>
        <button class="workflow-tab" onclick="showWorkflowTab('realization')">Realization Events</button>
        <button class="workflow-tab" onclick="showWorkflowTab('requests')">3rd Party Requests</button>
        <button class="workflow-tab" onclick="showWorkflowTab('checklist')">FTB Checklist</button>
      </div>

      <!-- TAB: DAY COUNTER -->
      <div class="workflow-tab-content active" id="tab-dayCounter">
        <div class="day-counter-section">
          <div class="day-counter-header">
            <div class="day-counter-title">
              <span class="day-counter-title-icon">&#128197;</span>
              CA Day Counter - 183 Day Rule
            </div>
            <button class="btn btn-secondary" onclick="exportDayEntries()">Export CSV</button>
          </div>

          <div class="day-counter-stats">
            <div class="day-stat-card">
              <div class="day-stat-value" id="dayStatCA">0</div>
              <div class="day-stat-label">Days in CA</div>
            </div>
            <div class="day-stat-card">
              <div class="day-stat-value safe" id="dayStatOther">0</div>
              <div class="day-stat-label">Days Outside CA</div>
            </div>
            <div class="day-stat-card">
              <div class="day-stat-value" id="dayStatRemaining">183</div>
              <div class="day-stat-label">Days Until Limit</div>
            </div>
            <div class="day-stat-card">
              <div class="day-stat-value" id="dayStatYear">2025</div>
              <div class="day-stat-label">Tax Year</div>
            </div>
          </div>

          <div class="day-progress-container">
            <div class="day-progress-header">
              <span class="day-progress-label">Progress to 183-Day Threshold</span>
              <span class="day-progress-value" id="dayProgressText">0 / 183 (0%)</span>
            </div>
            <div class="day-progress-bar">
              <div class="day-progress-fill safe" id="dayProgressFill" style="width: 0%"></div>
            </div>
            <div class="day-progress-markers">
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>0</span></div>
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>120 Safe</span></div>
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>150 Caution</span></div>
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>183 Limit</span></div>
            </div>
          </div>

          <div class="day-alert-banner safe" id="dayAlertBanner">
            <span class="day-alert-icon">&#10003;</span>
            <span id="dayAlertText">Safe Zone: You have plenty of room before approaching the 183-day threshold.</span>
          </div>

          <div class="day-entry-form" id="dayEntryForm">
            <div class="day-entry-group">
              <label class="day-entry-label">Date</label>
              <input type="date" class="day-entry-input" id="dayEntryDate">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Location</label>
              <select class="day-entry-input" id="dayEntryLocation">
                <option value="CA">California</option>
                <option value="NV">Nevada</option>
                <option value="OTHER">Other State</option>
                <option value="INTL">International</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Purpose</label>
              <select class="day-entry-input" id="dayEntryPurpose">
                <option value="PERSONAL">Personal</option>
                <option value="BUSINESS">Business</option>
                <option value="MEDICAL">Medical</option>
                <option value="TRANSIT">Transit</option>
                <option value="VACATION">Vacation</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Notes</label>
              <input type="text" class="day-entry-input" id="dayEntryNotes" placeholder="Brief description...">
            </div>
            <button class="day-entry-btn" onclick="addDayEntry()">+ Add Day</button>
          </div>

          <label class="day-bulk-toggle">
            <input type="checkbox" id="bulkEntryToggle" onchange="toggleBulkEntry()">
            Enable bulk entry mode (for date ranges)
          </label>

          <div class="day-bulk-form" id="bulkEntryForm">
            <div class="day-bulk-hint">Format: YYYY-MM-DD to YYYY-MM-DD: LOCATION, PURPOSE</div>
            <textarea class="day-bulk-textarea" id="bulkEntryText" placeholder="2025-01-01 to 2025-01-15: NV, Personal"></textarea>
            <button class="day-entry-btn" onclick="processBulkEntry()">Process Bulk Entry</button>
          </div>

          <div class="day-entries-list" id="dayEntriesList">
            <div class="day-entries-header">
              <span>Date</span><span>Location</span><span>Purpose</span><span>Notes</span><span>Action</span>
            </div>
            <div id="dayEntriesBody"></div>
          </div>
        </div>
      </div>

      <!-- TAB: SAFE HARBOR -->
      <div class="workflow-tab-content" id="tab-safeHarbor">
        <div class="safe-harbor-section">
          <div class="safe-harbor-header">
            <div class="safe-harbor-title">
              <span>&#128737;</span> Safe Harbor Analysis - R&TC 17014(d)
            </div>
            <span class="safe-harbor-badge pending" id="safeHarborBadge">PENDING REVIEW</span>
          </div>

          <div class="timeline-info-box">
            <strong>Safe Harbor Eligibility:</strong> CA-domiciled individuals may be treated as nonresidents if absent under an employment contract for 546+ consecutive days, with CA visits under 45 days/year and intangible income under $200,000/year.
          </div>

          <!-- Safe Harbor Metrics -->
          <div class="safe-harbor-grid">
            <div class="safe-harbor-metric">
              <div class="safe-harbor-metric-header">
                <span class="safe-harbor-metric-label">Days Outside CA</span>
                <span class="safe-harbor-metric-status pending" id="shDaysStatus">TRACKING</span>
              </div>
              <div class="safe-harbor-metric-value" id="shDaysOutside">0</div>
              <div class="safe-harbor-metric-target">Target: 546 consecutive days</div>
              <div class="safe-harbor-progress">
                <div class="safe-harbor-progress-fill" id="shDaysProgress" style="width: 0%; background: var(--accent);"></div>
              </div>
            </div>
            <div class="safe-harbor-metric">
              <div class="safe-harbor-metric-header">
                <span class="safe-harbor-metric-label">CA Visits This Year</span>
                <span class="safe-harbor-metric-status pass" id="shVisitsStatus">PASS</span>
              </div>
              <div class="safe-harbor-metric-value" id="shCAVisits">0</div>
              <div class="safe-harbor-metric-target">Limit: 45 days per tax year</div>
              <div class="safe-harbor-progress">
                <div class="safe-harbor-progress-fill" id="shVisitsProgress" style="width: 0%; background: var(--safe);"></div>
              </div>
            </div>
            <div class="safe-harbor-metric">
              <div class="safe-harbor-metric-header">
                <span class="safe-harbor-metric-label">Intangible Income</span>
                <span class="safe-harbor-metric-status pass" id="shIncomeStatus">PASS</span>
              </div>
              <div class="safe-harbor-metric-value" id="shIntangibleIncome">$0</div>
              <div class="safe-harbor-metric-target">Limit: $200,000 per year</div>
              <div class="safe-harbor-progress">
                <div class="safe-harbor-progress-fill" id="shIncomeProgress" style="width: 0%; background: var(--safe);"></div>
              </div>
            </div>
          </div>

          <!-- Employment Contract -->
          <div class="safe-harbor-contract">
            <div class="safe-harbor-contract-header">
              <div class="safe-harbor-contract-title">Employment Contract Details</div>
              <button class="btn btn-secondary" onclick="saveSafeHarborContract()">Save Contract</button>
            </div>
            <div class="safe-harbor-form">
              <div class="day-entry-group">
                <label class="day-entry-label">Employer Name</label>
                <input type="text" class="day-entry-input" id="shEmployer" placeholder="Company name">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Contract Start Date</label>
                <input type="date" class="day-entry-input" id="shContractStart">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Contract End Date</label>
                <input type="date" class="day-entry-input" id="shContractEnd">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Work Location (Non-CA)</label>
                <input type="text" class="day-entry-input" id="shWorkLocation" placeholder="City, State/Country">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Annual Intangible Income</label>
                <input type="number" class="day-entry-input" id="shAnnualIncome" placeholder="0">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Contract Document</label>
                <input type="text" class="day-entry-input" id="shContractDoc" placeholder="Filename or reference">
              </div>
            </div>
          </div>

          <!-- Requirements Checklist -->
          <h4 style="margin-bottom: 12px; font-size: 14px;">Safe Harbor Requirements</h4>
          <div class="safe-harbor-requirements" id="shRequirements">
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">546 Consecutive Days</div>
                <div class="safe-harbor-requirement-desc">Must be outside CA for uninterrupted 546+ days under contract</div>
              </div>
            </div>
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">45-Day CA Limit</div>
                <div class="safe-harbor-requirement-desc">CA visits must not exceed 45 days in any covered tax year</div>
              </div>
            </div>
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">$200K Income Limit</div>
                <div class="safe-harbor-requirement-desc">Intangible income must be under $200,000 per year</div>
              </div>
            </div>
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">No Tax Avoidance Purpose</div>
                <div class="safe-harbor-requirement-desc">Principal purpose must not be avoiding CA income tax</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: ADDRESSES -->
      <div class="workflow-tab-content" id="tab-addresses">
        <div class="address-section">
          <div class="day-counter-header">
            <div class="day-counter-title">
              <span>&#127968;</span> Address Timeline
            </div>
          </div>

          <div class="timeline-info-box">
            Document all residences with dates. FTB examines where you maintain your primary home and the comparison between CA and non-CA residences.
          </div>

          <div class="address-form">
            <div class="day-entry-group">
              <label class="day-entry-label">Start Date</label>
              <input type="date" class="day-entry-input" id="addrStartDate">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">End Date</label>
              <input type="date" class="day-entry-input" id="addrEndDate" placeholder="Present">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Address</label>
              <input type="text" class="day-entry-input" id="addrStreet" placeholder="Street address">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">City, State</label>
              <input type="text" class="day-entry-input" id="addrCity" placeholder="City, ST">
            </div>
            <button class="day-entry-btn" onclick="addAddress()">+ Add Address</button>
          </div>

          <div class="address-timeline" id="addressTimeline">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No addresses recorded yet.</div>
          </div>
        </div>
      </div>

      <!-- TAB: EVIDENCE -->
      <div class="workflow-tab-content" id="tab-evidence">
        <div class="evidence-section">
          <div class="evidence-header">
            <div class="evidence-title">
              <span>&#128193;</span> Evidence Repository
            </div>
            <div class="evidence-stats">
              <div class="evidence-stat"><span class="evidence-stat-count" id="evidenceTotal">0</span> Total</div>
              <div class="evidence-stat"><span class="evidence-stat-count" id="evidenceVerified">0</span> Verified</div>
            </div>
          </div>

          <div class="evidence-categories" id="evidenceCategories">
            <div class="evidence-category active" onclick="filterEvidence('all')">
              <div class="evidence-category-icon">&#128194;</div>
              <div class="evidence-category-name">All Evidence</div>
              <div class="evidence-category-count" id="evCatAll">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('official')">
              <div class="evidence-category-icon">&#128220;</div>
              <div class="evidence-category-name">Official Documents</div>
              <div class="evidence-category-count" id="evCatOfficial">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('records')">
              <div class="evidence-category-icon">&#128203;</div>
              <div class="evidence-category-name">Records</div>
              <div class="evidence-category-count" id="evCatRecords">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('digital')">
              <div class="evidence-category-icon">&#128187;</div>
              <div class="evidence-category-name">Digital Evidence</div>
              <div class="evidence-category-count" id="evCatDigital">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('thirdparty')">
              <div class="evidence-category-icon">&#128101;</div>
              <div class="evidence-category-name">Third-Party</div>
              <div class="evidence-category-count" id="evCatThirdparty">0 items</div>
            </div>
          </div>

          <div class="evidence-upload-zone" onclick="document.getElementById('evidenceFileInput').click()">
            <div class="evidence-upload-icon">&#128228;</div>
            <div class="evidence-upload-text">Drop files here or click to upload</div>
            <div class="evidence-upload-hint">PDF, images, or documents up to 10MB</div>
            <input type="file" id="evidenceFileInput" style="display:none" onchange="handleEvidenceUpload(event)">
          </div>

          <div class="evidence-list" id="evidenceList">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No evidence uploaded yet.</div>
          </div>
        </div>
      </div>

      <!-- TAB: REALIZATION EVENTS -->
      <div class="workflow-tab-content" id="tab-realization">
        <div class="timeline-section">
          <div class="timeline-header">
            <div class="timeline-title">
              <span>&#128200;</span> Realization Events Timeline
            </div>
            <button class="btn btn-primary" onclick="showModal('newRealization')">+ Add Event</button>
          </div>

          <div class="timeline-info-box">
            <strong>Why this matters:</strong> Stock sales, RSU vests, and other realization events may be partially sourced to CA based on where you worked during the vesting period. Document all significant events with dates and amounts.
          </div>

          <div class="timeline-form">
            <div class="day-entry-group">
              <label class="day-entry-label">Event Date</label>
              <input type="date" class="day-entry-input" id="realEventDate">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Event Type</label>
              <select class="day-entry-input" id="realEventType">
                <option value="RSU_VEST">RSU Vest</option>
                <option value="STOCK_SALE">Stock Sale</option>
                <option value="OPTION_EXERCISE">Option Exercise</option>
                <option value="BONUS">Bonus Payment</option>
                <option value="DEFERRED_COMP">Deferred Compensation</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Amount ($)</label>
              <input type="number" class="day-entry-input" id="realEventAmount" placeholder="0">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Description</label>
              <input type="text" class="day-entry-input" id="realEventDesc" placeholder="Details...">
            </div>
            <button class="day-entry-btn" onclick="addRealizationEvent()">+ Add</button>
          </div>

          <div class="timeline-events" id="realizationTimeline">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No realization events recorded.</div>
          </div>
        </div>
      </div>

      <!-- TAB: THIRD-PARTY REQUESTS -->
      <div class="workflow-tab-content" id="tab-requests">
        <div class="requests-section">
          <div class="requests-header">
            <div class="requests-title">
              <span>&#128231;</span> Third-Party Information Requests
            </div>
          </div>

          <div class="requests-info">
            <strong>Documentation Strategy:</strong> Proactively request confirmations from employers, banks, and service providers. These third-party letters carry more weight with FTB than self-reported information.
          </div>

          <div class="requests-form">
            <div class="day-entry-group">
              <label class="day-entry-label">Entity Name</label>
              <input type="text" class="day-entry-input" id="reqEntity" placeholder="Company/Organization">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Request Type</label>
              <select class="day-entry-input" id="reqType">
                <option value="EMPLOYMENT_LETTER">Employment Confirmation</option>
                <option value="BANK_STATEMENT">Bank Statement</option>
                <option value="UTILITY_RECORDS">Utility Records</option>
                <option value="MEDICAL_RECORDS">Medical Records</option>
                <option value="MEMBERSHIP">Club/Membership</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Date Sent</label>
              <input type="date" class="day-entry-input" id="reqDateSent">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Status</label>
              <select class="day-entry-input" id="reqStatus">
                <option value="PENDING">Pending</option>
                <option value="SENT">Sent</option>
                <option value="RECEIVED">Received</option>
                <option value="OVERDUE">Overdue</option>
              </select>
            </div>
            <button class="day-entry-btn" onclick="addRequest()">+ Add</button>
          </div>

          <div class="requests-list" id="requestsList">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No requests tracked yet.</div>
          </div>
        </div>
      </div>

      <!-- TAB: FTB CHECKLIST -->
      <div class="workflow-tab-content" id="tab-checklist">
        <div id="checklistContainer">
          <!-- Checklist categories will be rendered here -->
        </div>
      </div>
    </div>

    <!-- LEDGER PAGE -->
    <div class="page" id="page-ledger">
      <h1 class="section-title">Audit Ledger</h1>

      <div class="ledger-controls">
        <div class="ledger-filters">
          <select class="filter-select" id="filterEventType">
            <option value="">All Event Types</option>
            <option value="FINDING">Finding</option>
            <option value="CHECKLIST_UPDATE">Checklist Update</option>
            <option value="WORKFLOW_CREATE">Workflow Create</option>
          </select>
          <select class="filter-select" id="filterPeriod">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>

        <div class="ledger-search">
          <input type="text" placeholder="Search entries..." id="ledgerSearch">
          <button class="btn btn-secondary" onclick="loadLedgerData()">Search</button>
          <button class="btn btn-primary" onclick="showModal('newEntry')">+ New Entry</button>
        </div>
      </div>

      <div class="ledger-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Timestamp</th>
              <th>Actor</th>
              <th>Event Type</th>
              <th>Text</th>
              <th>Confidence</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="ledgerTableBody">
            <tr><td colspan="7"><div class="loading"><div class="loading-spinner"></div>Loading...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Modal: New Entry -->
  <div class="modal-overlay" id="modal-newEntry">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">New Audit Entry</h2>
        <button class="modal-close" onclick="closeModal('newEntry')">&#10005;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Confidence Level *</label>
          <select class="form-input" id="entryConfidence">
            <option value="">Select confidence level...</option>
            <option value="KNOWN_KNOWN">KNOWN_KNOWN - I know the fact and have evidence</option>
            <option value="KNOWN_UNKNOWN">KNOWN_UNKNOWN - I know there's a gap here</option>
            <option value="UNKNOWN_UNKNOWN">UNKNOWN_UNKNOWN - I don't know what I don't know</option>
          </select>
          <p class="form-hint">Declare confidence before the entry is logged (Rumsfeld Protocol)</p>
        </div>
        <div class="form-group">
          <label class="form-label">Event Type *</label>
          <select class="form-input" id="entryEventType">
            <option value="">Select event type...</option>
            <option value="FINDING">Finding</option>
            <option value="OBSERVATION">Observation</option>
            <option value="DECISION">Decision</option>
            <option value="ALERT">Alert</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Text *</label>
          <textarea class="form-input form-textarea" id="entryText" placeholder="Describe the finding, observation, or decision..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('newEntry')">Cancel</button>
        <button class="btn btn-primary" onclick="submitNewEntry()">Create Entry</button>
      </div>
    </div>
  </div>

  <!-- Modal: New Workflow -->
  <div class="modal-overlay" id="modal-newWorkflow">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">New Client Workflow</h2>
        <button class="modal-close" onclick="closeModal('newWorkflow')">&#10005;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Client Name *</label>
          <input type="text" class="form-input" id="workflowName" placeholder="Full legal name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="workflowEmail" placeholder="client@email.com">
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="workflowPhone" placeholder="(555) 555-5555">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">From State *</label>
            <select class="form-input" id="workflowFromState">
              <option value="CA" selected>California</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">To State *</label>
            <select class="form-input" id="workflowToState">
              <option value="">Select state...</option>
              <option value="NV">Nevada</option>
              <option value="TX">Texas</option>
              <option value="FL">Florida</option>
              <option value="WA">Washington</option>
              <option value="TN">Tennessee</option>
              <option value="WY">Wyoming</option>
              <option value="SD">South Dakota</option>
              <option value="AK">Alaska</option>
              <option value="NH">New Hampshire</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Target Move Date</label>
          <input type="date" class="form-input" id="workflowMoveDate">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('newWorkflow')">Cancel</button>
        <button class="btn btn-primary" onclick="createWorkflow()">Create Workflow</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ===== API CONFIGURATION =====
    const API_BASE = 'https://baycomply-api-827642717513.us-central1.run.app';
    const DEFAULT_TENANT = '00000000-0000-0000-0000-000000000001';
    const DEFAULT_USER = '00000000-0000-0000-0000-000000000001';

    // ===== LOCAL STATE =====
    let workflows = JSON.parse(localStorage.getItem('newton_workflows') || '[]');
    let currentWorkflowId = null;

    // ===== CHECKLIST TEMPLATE =====
    const CHECKLIST_TEMPLATE = {
      'formalities': {
        title: 'Formalities (Least Weight - But Required)',
        items: [
          { id: 'drivers_license', name: "Driver's License - Surrender CA, obtain new state" },
          { id: 'vehicle_registration', name: 'Vehicle Registration - All vehicles registered in new state' },
          { id: 'voter_registration', name: 'Voter Registration - Register in new state' },
          { id: 'usps_address', name: 'USPS Address Change - File Form 3575' },
          { id: 'professional_services', name: 'Professional Services - New doctors, dentists, accountants, attorneys' },
        ]
      },
      'property': {
        title: 'Residential Property (Highest Weight)',
        items: [
          { id: 'ca_property_status', name: 'CA Property - Listed for sale, rented, or disposed' },
          { id: 'homeowners_exemption', name: "Homeowner's Exemption - Removed from CA property" },
          { id: 'new_residence', name: 'New Residence - Purchased or leased in new state' },
          { id: 'residence_comparison', name: 'Residence Comparison - New home comparable or better' },
        ]
      },
      'physical_presence': {
        title: 'Physical Presence (Highest Weight)',
        items: [
          { id: 'move_date', name: 'Move Date - Documented date of physical move' },
          { id: 'day_count', name: 'Day Count - Less than 9 months in CA' },
          { id: 'visit_purpose', name: 'CA Visits - Purpose documented (vacation, business, medical)' },
          { id: 'visit_accommodations', name: 'CA Accommodations - Where you stay when visiting' },
        ]
      },
      'family_social': {
        title: 'Family & Social Connections (Highest Weight)',
        items: [
          { id: 'spouse_location', name: 'Spouse/Partner - Lives in new state' },
          { id: 'children_location', name: 'Minor Children - Reside and attend school in new state' },
          { id: 'clubs_resigned', name: 'CA Clubs - Resigned from country clubs, gyms, etc.' },
          { id: 'clubs_joined', name: 'New State Clubs - Joined clubs, organizations in new state' },
        ]
      },
      'business_employment': {
        title: 'Business & Employment (Highest/Moderate Weight)',
        items: [
          { id: 'employment_location', name: 'Employment - Primary work location in new state' },
          { id: 'business_interests', name: 'CA Business Interests - Level of participation documented' },
          { id: 'professional_licenses', name: 'Professional Licenses - Where licenses are held' },
          { id: 'remote_work', name: 'Remote Work - Physical location when working documented' },
        ]
      },
      'financial': {
        title: 'Financial & Income',
        items: [
          { id: 'bank_accounts', name: 'Bank Accounts - Opened in new state' },
          { id: 'stock_options', name: 'Stock Options/RSUs - CA portion documented' },
          { id: 'deferred_comp', name: 'Deferred Compensation - Timing and sourcing documented' },
        ]
      },
      'safe_harbor': {
        title: 'Safe Harbor Screening',
        items: [
          { id: 'employment_contract', name: 'Employment Contract - 546+ consecutive days outside CA' },
          { id: 'intangible_income', name: 'Intangible Income - Under $200K threshold verified' },
        ]
      }
    };

    // ===== API HELPER =====
    async function api(endpoint, options = {}) {
      try {
        const response = await fetch(API_BASE + endpoint, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        return await response.json();
      } catch (err) {
        console.error('API Error:', err);
        return null;
      }
    }

    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.dataset.page === pageId) link.classList.add('active');
      });

      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');

      if (pageId === 'ledger') loadLedgerData();
      if (pageId === 'home') loadHomeStats();
      if (pageId === 'workflows') renderWorkflowsList();
    }

    function showWorkflowDetail(workflowId) {
      currentWorkflowId = workflowId;
      const workflow = workflows.find(w => w.id === workflowId);
      if (!workflow) return;

      document.getElementById('workflowClientName').textContent = workflow.name;
      document.getElementById('workflowFrom').textContent = workflow.fromState;
      document.getElementById('workflowTo').textContent = workflow.toState;
      document.getElementById('workflowMoveDate').textContent = workflow.moveDate || '-';

      const progress = calculateWorkflowProgress(workflow);
      document.getElementById('workflowProgress').textContent = progress + '%';

      renderChecklist(workflow);

      // Reset to first tab
      document.querySelectorAll('.workflow-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.workflow-tab').classList.add('active');
      document.querySelectorAll('.workflow-tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById('tab-dayCounter').classList.add('active');

      renderDayCounter();

      // Set default date to today
      document.getElementById('dayEntryDate').value = new Date().toISOString().split('T')[0];

      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById('page-workflow-detail').classList.add('active');
    }

    // ===== MODALS =====
    function showModal(modalId) {
      document.getElementById('modal-' + modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById('modal-' + modalId).classList.remove('active');
    }

    // ===== TOAST =====
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = '<span>' + (type === 'success' ? '&#10003;' : '&#9888;') + '</span><span>' + message + '</span>';
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // ===== LOAD HOME STATS =====
    async function loadHomeStats() {
      const stats = await api('/api/stats');
      if (stats) {
        document.getElementById('statEntries').textContent = stats.entries.toLocaleString();
        document.getElementById('statWorkflows').textContent = workflows.length;
        document.getElementById('statCompliance').textContent = stats.compliance + '%';
      }
      document.getElementById('pulseWorkflows').textContent = workflows.length;
    }

    // ===== LOAD PULSE BAR =====
    async function loadPulseBar() {
      const chain = await api('/api/chain/integrity');
      if (chain) {
        document.getElementById('chainStatus').innerHTML =
          '<span class="pulse-value ' + (chain.verified ? 'verified' : 'broken') + '">' +
          (chain.verified ? 'VERIFIED' : 'BROKEN') + '</span> - ' + chain.rows.toLocaleString() + ' rows';
        document.getElementById('systemStatus').textContent = chain.verified ? 'Chain Verified' : 'CHAIN BROKEN';
      }
      document.getElementById('pulseWorkflows').textContent = workflows.length;
    }

    // ===== LOAD LEDGER =====
    async function loadLedgerData() {
      const tbody = document.getElementById('ledgerTableBody');
      tbody.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="loading-spinner"></div>Loading...</div></td></tr>';

      const entries = await api('/api/audit');

      if (!entries || entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--text-muted); padding: 40px;">No entries yet. Create your first audit entry.</td></tr>';
        return;
      }

      tbody.innerHTML = entries.map(entry => {
        const confidenceClass = (entry.confidence || 'KNOWN_KNOWN').toLowerCase().replace(/_/g, '-');
        return '<tr>' +
          '<td><span class="ledger-uuid">' + String(entry.uuid).substring(0, 8) + '</span></td>' +
          '<td>' + entry.timestamp + '</td>' +
          '<td>' + entry.actor + '</td>' +
          '<td><span class="ledger-event-type">' + entry.eventType + '</span></td>' +
          '<td>' + String(entry.text).substring(0, 50) + (String(entry.text).length > 50 ? '...' : '') + '</td>' +
          '<td><span class="ledger-confidence"><span class="confidence-dot ' + confidenceClass + '"></span>' + entry.confidence + '</span></td>' +
          '<td>' + entry.status + '</td>' +
        '</tr>';
      }).join('');
    }

    // ===== SUBMIT NEW ENTRY =====
    async function submitNewEntry() {
      const confidence = document.getElementById('entryConfidence').value;
      const eventType = document.getElementById('entryEventType').value;
      const text = document.getElementById('entryText').value;

      if (!confidence || !eventType || !text) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      const result = await api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: eventType,
          content: { message: text, confidence: confidence }
        })
      });

      if (result && !result.error) {
        closeModal('newEntry');
        showToast('Entry created with hash-chain verification', 'success');
        loadLedgerData();
        loadPulseBar();
        document.getElementById('entryConfidence').value = '';
        document.getElementById('entryEventType').value = '';
        document.getElementById('entryText').value = '';
      } else {
        showToast('Error: ' + (result?.error || 'Unknown error'), 'error');
      }
    }

    // ===== WORKFLOWS =====
    function createWorkflow() {
      const name = document.getElementById('workflowName').value;
      const email = document.getElementById('workflowEmail').value;
      const phone = document.getElementById('workflowPhone').value;
      const fromState = document.getElementById('workflowFromState').value;
      const toState = document.getElementById('workflowToState').value;
      const moveDate = document.getElementById('workflowMoveDate').value;

      if (!name || !toState) {
        showToast('Please fill in required fields', 'error');
        return;
      }

      const workflow = {
        id: 'wf_' + Date.now(),
        name,
        email,
        phone,
        fromState,
        toState,
        moveDate,
        createdAt: new Date().toISOString(),
        checklist: initializeChecklist()
      };

      workflows.push(workflow);
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'WORKFLOW_CREATE',
          content: {
            message: 'Created workflow for ' + name + ' (' + fromState + ' to ' + toState + ')',
            confidence: 'KNOWN_KNOWN',
            workflowId: workflow.id
          }
        })
      });

      closeModal('newWorkflow');
      showToast('Workflow created for ' + name, 'success');

      // Clear form
      document.getElementById('workflowName').value = '';
      document.getElementById('workflowEmail').value = '';
      document.getElementById('workflowPhone').value = '';
      document.getElementById('workflowMoveDate').value = '';
      document.getElementById('workflowToState').value = '';

      showWorkflowDetail(workflow.id);
    }

    function initializeChecklist() {
      const checklist = {};
      for (const [categoryId, category] of Object.entries(CHECKLIST_TEMPLATE)) {
        checklist[categoryId] = {};
        for (const item of category.items) {
          checklist[categoryId][item.id] = {
            status: 'not_started',
            confidence: '',
            notes: '',
            evidence: null,
            updatedAt: null
          };
        }
      }
      return checklist;
    }

    function saveWorkflows() {
      localStorage.setItem('newton_workflows', JSON.stringify(workflows));
    }

    function renderWorkflowsList() {
      const grid = document.getElementById('workflowsGrid');

      if (workflows.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#128203;</div>
            <div class="empty-state-title">No workflows yet</div>
            <div class="empty-state-text">Create your first client workflow to start tracking residency changes.</div>
            <button class="btn btn-primary" onclick="showModal('newWorkflow')">+ New Client</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = workflows.map(w => {
        const progress = calculateWorkflowProgress(w);
        return `
          <div class="workflow-card" onclick="showWorkflowDetail('${w.id}')">
            <div class="workflow-card-header">
              <div class="workflow-card-title">${w.name}</div>
              <span class="workflow-card-status ${progress === 100 ? 'active' : 'pending'}">${progress === 100 ? 'Complete' : 'In Progress'}</span>
            </div>
            <div class="workflow-card-meta">${w.fromState} &#8594; ${w.toState} ${w.moveDate ? '| ' + w.moveDate : ''}</div>
            <div class="workflow-card-progress">
              <div class="workflow-card-progress-bar" style="width: ${progress}%"></div>
            </div>
            <div class="workflow-card-stats">
              <span>${progress}% complete</span>
              <span>Created ${new Date(w.createdAt).toLocaleDateString()}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function calculateWorkflowProgress(workflow) {
      let total = 0;
      let completed = 0;
      for (const category of Object.values(workflow.checklist)) {
        for (const item of Object.values(category)) {
          total++;
          if (item.status === 'complete' || item.status === 'na') completed++;
        }
      }
      return total > 0 ? Math.round((completed / total) * 100) : 0;
    }

    function renderChecklist(workflow) {
      const container = document.getElementById('checklistContainer');
      container.innerHTML = '';

      for (const [categoryId, category] of Object.entries(CHECKLIST_TEMPLATE)) {
        const categoryData = workflow.checklist[categoryId] || {};
        const completedCount = Object.values(categoryData).filter(i => i.status === 'complete' || i.status === 'na').length;

        const categoryHtml = `
          <div class="checklist-category">
            <div class="checklist-category-header">
              <div class="checklist-category-title">${category.title}</div>
              <div class="checklist-category-count">${completedCount}/${category.items.length}</div>
            </div>
            <div class="checklist-category-body">
              ${category.items.map(item => {
                const itemData = categoryData[item.id] || { status: 'not_started', confidence: '' };
                return `
                  <div class="checklist-item">
                    <div class="checklist-item-name">${item.name}</div>
                    <div class="checklist-item-status">
                      <select class="checklist-select" onchange="updateChecklistItem('${workflow.id}', '${categoryId}', '${item.id}', 'status', this.value)">
                        <option value="not_started" ${itemData.status === 'not_started' ? 'selected' : ''}>Not Started</option>
                        <option value="in_progress" ${itemData.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                        <option value="complete" ${itemData.status === 'complete' ? 'selected' : ''}>Complete</option>
                        <option value="na" ${itemData.status === 'na' ? 'selected' : ''}>N/A</option>
                      </select>
                    </div>
                    <div class="checklist-item-confidence tooltip-container">
                      <select class="checklist-select" onchange="updateChecklistItem('${workflow.id}', '${categoryId}', '${item.id}', 'confidence', this.value)">
                        <option value="" ${!itemData.confidence ? 'selected' : ''}>Select confidence...</option>
                        <option value="KNOWN_KNOWN" ${itemData.confidence === 'KNOWN_KNOWN' ? 'selected' : ''}>KNOWN_KNOWN</option>
                        <option value="KNOWN_UNKNOWN" ${itemData.confidence === 'KNOWN_UNKNOWN' ? 'selected' : ''}>KNOWN_UNKNOWN</option>
                        <option value="UNKNOWN_UNKNOWN" ${itemData.confidence === 'UNKNOWN_UNKNOWN' ? 'selected' : ''}>UNKNOWN_UNKNOWN</option>
                      </select>
                      <div class="tooltip">
                        KNOWN_KNOWN: I have evidence<br>
                        KNOWN_UNKNOWN: I know there's a gap<br>
                        UNKNOWN_UNKNOWN: I don't know what I don't know
                      </div>
                    </div>
                    <div class="checklist-item-actions">
                      <button class="checklist-btn" onclick="uploadEvidence('${workflow.id}', '${categoryId}', '${item.id}')">&#128206; Upload</button>
                      <button class="checklist-btn primary" onclick="logChecklistItem('${workflow.id}', '${categoryId}', '${item.id}')">&#10003; Log</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
        container.innerHTML += categoryHtml;
      }
    }

    function updateChecklistItem(workflowId, categoryId, itemId, field, value) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (!workflow) return;

      if (!workflow.checklist[categoryId]) workflow.checklist[categoryId] = {};
      if (!workflow.checklist[categoryId][itemId]) {
        workflow.checklist[categoryId][itemId] = { status: 'not_started', confidence: '', notes: '' };
      }

      workflow.checklist[categoryId][itemId][field] = value;
      workflow.checklist[categoryId][itemId].updatedAt = new Date().toISOString();
      saveWorkflows();

      // Update progress display
      const progress = calculateWorkflowProgress(workflow);
      document.getElementById('workflowProgress').textContent = progress + '%';
    }

    async function logChecklistItem(workflowId, categoryId, itemId) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (!workflow) return;

      const itemData = workflow.checklist[categoryId]?.[itemId];
      const itemTemplate = CHECKLIST_TEMPLATE[categoryId]?.items.find(i => i.id === itemId);

      if (!itemData?.confidence) {
        showToast('Please select a confidence level first', 'error');
        return;
      }

      const result = await api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'CHECKLIST_UPDATE',
          content: {
            message: workflow.name + ' | ' + itemTemplate.name + ' | Status: ' + itemData.status,
            confidence: itemData.confidence,
            workflowId: workflowId,
            categoryId: categoryId,
            itemId: itemId
          }
        })
      });

      if (result && !result.error) {
        showToast('Logged to audit ledger with hash verification', 'success');
      } else {
        showToast('Error logging to ledger', 'error');
      }
    }

    function uploadEvidence(workflowId, categoryId, itemId) {
      // For now, just show a toast - file upload requires backend storage
      showToast('Evidence upload coming soon - for now, note the file in comments', 'warning');
    }

    // ===== DAY COUNTER =====
    function getDayEntries(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.dayEntries || [];
    }

    function saveDayEntries(workflowId, entries) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (workflow) {
        workflow.dayEntries = entries;
        saveWorkflows();
      }
    }

    function addDayEntry() {
      if (!currentWorkflowId) return;

      const date = document.getElementById('dayEntryDate').value;
      const location = document.getElementById('dayEntryLocation').value;
      const purpose = document.getElementById('dayEntryPurpose').value;
      const notes = document.getElementById('dayEntryNotes').value;

      if (!date) {
        showToast('Please select a date', 'error');
        return;
      }

      const entries = getDayEntries(currentWorkflowId);

      // Check for duplicate date
      if (entries.find(e => e.date === date)) {
        showToast('Entry for this date already exists', 'error');
        return;
      }

      const entry = {
        id: 'day_' + Date.now(),
        date,
        location,
        purpose,
        notes,
        createdAt: new Date().toISOString()
      };

      entries.push(entry);
      entries.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first
      saveDayEntries(currentWorkflowId, entries);

      // Log to audit ledger
      logDayEntry(entry);

      // Update UI
      renderDayCounter();

      // Clear form
      document.getElementById('dayEntryDate').value = '';
      document.getElementById('dayEntryNotes').value = '';

      showToast('Day logged: ' + date + ' in ' + location, 'success');
    }

    async function logDayEntry(entry) {
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      await api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'DAY_ENTRY',
          content: {
            message: workflow.name + ' | Day logged: ' + entry.date + ' in ' + entry.location + ' (' + entry.purpose + ')',
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            dayEntry: entry
          }
        })
      });
    }

    function deleteDayEntry(entryId) {
      if (!currentWorkflowId) return;

      let entries = getDayEntries(currentWorkflowId);
      const entry = entries.find(e => e.id === entryId);
      entries = entries.filter(e => e.id !== entryId);
      saveDayEntries(currentWorkflowId, entries);

      // Log deletion to audit ledger
      if (entry) {
        api('/api/audit', {
          method: 'POST',
          body: JSON.stringify({
            tenantId: DEFAULT_TENANT,
            userId: DEFAULT_USER,
            entryType: 'DAY_ENTRY_DELETE',
            content: {
              message: 'Day entry deleted: ' + entry.date + ' in ' + entry.location,
              confidence: 'KNOWN_KNOWN',
              workflowId: currentWorkflowId,
              deletedEntry: entry
            }
          })
        });
      }

      renderDayCounter();
      showToast('Day entry deleted', 'success');
    }

    function toggleBulkEntry() {
      const checkbox = document.getElementById('bulkEntryToggle');
      const form = document.getElementById('bulkEntryForm');
      const singleForm = document.getElementById('dayEntryForm');

      if (checkbox.checked) {
        form.classList.add('active');
        singleForm.style.display = 'none';
      } else {
        form.classList.remove('active');
        singleForm.style.display = 'grid';
      }
    }

    function processBulkEntry() {
      if (!currentWorkflowId) return;

      const text = document.getElementById('bulkEntryText').value.trim();
      if (!text) {
        showToast('Please enter some date ranges', 'error');
        return;
      }

      const lines = text.split('\n');
      let addedCount = 0;
      let entries = getDayEntries(currentWorkflowId);

      for (const line of lines) {
        // Parse: YYYY-MM-DD to YYYY-MM-DD: LOCATION, PURPOSE
        const match = line.match(/(\d{4}-\d{2}-\d{2})\s*to\s*(\d{4}-\d{2}-\d{2}):\s*(\w+),?\s*(\w+)?/i);
        if (!match) continue;

        const startDate = new Date(match[1]);
        const endDate = new Date(match[2]);
        const location = match[3].toUpperCase();
        const purpose = (match[4] || 'PERSONAL').toUpperCase();

        // Generate entries for each day in range
        let current = new Date(startDate);
        while (current <= endDate) {
          const dateStr = current.toISOString().split('T')[0];

          // Skip if already exists
          if (!entries.find(e => e.date === dateStr)) {
            entries.push({
              id: 'day_' + Date.now() + '_' + addedCount,
              date: dateStr,
              location: location === 'NV' ? 'NV' : location === 'CA' ? 'CA' : location === 'INTL' ? 'INTL' : 'OTHER',
              purpose: ['PERSONAL', 'BUSINESS', 'MEDICAL', 'TRANSIT', 'VACATION'].includes(purpose) ? purpose : 'PERSONAL',
              notes: 'Bulk entry',
              createdAt: new Date().toISOString()
            });
            addedCount++;
          }
          current.setDate(current.getDate() + 1);
        }
      }

      if (addedCount > 0) {
        entries.sort((a, b) => new Date(b.date) - new Date(a.date));
        saveDayEntries(currentWorkflowId, entries);

        // Log bulk entry to audit ledger
        api('/api/audit', {
          method: 'POST',
          body: JSON.stringify({
            tenantId: DEFAULT_TENANT,
            userId: DEFAULT_USER,
            entryType: 'DAY_ENTRY_BULK',
            content: {
              message: 'Bulk day entry: ' + addedCount + ' days added',
              confidence: 'KNOWN_KNOWN',
              workflowId: currentWorkflowId,
              count: addedCount
            }
          })
        });

        renderDayCounter();
        document.getElementById('bulkEntryText').value = '';
        showToast(addedCount + ' days added via bulk entry', 'success');
      } else {
        showToast('No new days added (may be duplicates)', 'warning');
      }
    }

    function calculateDayStats(entries) {
      const currentYear = new Date().getFullYear();
      const yearEntries = entries.filter(e => new Date(e.date).getFullYear() === currentYear);

      const caDays = yearEntries.filter(e => e.location === 'CA').length;
      const otherDays = yearEntries.filter(e => e.location !== 'CA').length;
      const remaining = Math.max(0, 183 - caDays);

      let status = 'safe';
      if (caDays >= 183) {
        status = 'danger';
      } else if (caDays >= 151) {
        status = 'warning';
      } else if (caDays >= 121) {
        status = 'caution';
      }

      return { caDays, otherDays, remaining, status, year: currentYear };
    }

    function getAlertMessage(status, caDays, remaining) {
      switch (status) {
        case 'safe':
          return { icon: '&#10003;', text: 'Safe Zone: You have ' + remaining + ' days remaining before approaching the 183-day threshold.' };
        case 'caution':
          return { icon: '&#9888;', text: 'Caution: You have ' + remaining + ' days remaining. Start limiting CA visits.' };
        case 'warning':
          return { icon: '&#9888;', text: 'Warning: Only ' + remaining + ' days remaining! Strongly limit CA presence.' };
        case 'danger':
          return { icon: '&#10060;', text: 'PRESUMED CA RESIDENT: You have exceeded 183 days in California this year. Consult tax advisor immediately.' };
        default:
          return { icon: '&#10003;', text: 'No data yet. Start logging your days.' };
      }
    }

    function renderDayCounter() {
      if (!currentWorkflowId) return;

      const entries = getDayEntries(currentWorkflowId);
      const stats = calculateDayStats(entries);
      const alert = getAlertMessage(stats.status, stats.caDays, stats.remaining);

      // Update stats
      const caStatEl = document.getElementById('dayStatCA');
      caStatEl.textContent = stats.caDays;
      caStatEl.className = 'day-stat-value ' + stats.status;

      document.getElementById('dayStatOther').textContent = stats.otherDays;
      document.getElementById('dayStatRemaining').textContent = stats.remaining;
      document.getElementById('dayStatYear').textContent = stats.year;

      // Update progress bar
      const percentage = Math.min(100, Math.round((stats.caDays / 183) * 100));
      const progressFill = document.getElementById('dayProgressFill');
      progressFill.style.width = percentage + '%';
      progressFill.className = 'day-progress-fill ' + stats.status;
      progressFill.textContent = percentage > 10 ? percentage + '%' : '';
      document.getElementById('dayProgressText').textContent = stats.caDays + ' / 183 (' + percentage + '%)';

      // Update alert banner
      const banner = document.getElementById('dayAlertBanner');
      banner.className = 'day-alert-banner ' + stats.status;
      document.getElementById('dayAlertText').textContent = alert.text;
      banner.querySelector('.day-alert-icon').innerHTML = alert.icon;

      // Render entries list
      const tbody = document.getElementById('dayEntriesBody');
      if (entries.length === 0) {
        tbody.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No days logged yet. Add your first entry above.</div>';
      } else {
        tbody.innerHTML = entries.map(e => {
          const isCA = e.location === 'CA';
          return '<div class="day-entry-row">' +
            '<span>' + e.date + '</span>' +
            '<span class="day-entry-location ' + (isCA ? 'ca' : 'other') + '">' + e.location + '</span>' +
            '<span>' + e.purpose + '</span>' +
            '<span style="color: var(--text-muted);">' + (e.notes || '-') + '</span>' +
            '<button class="day-entry-delete" onclick="deleteDayEntry(\'' + e.id + '\')">&times;</button>' +
          '</div>';
        }).join('');
      }

      // Update the physical presence checklist item if exists
      updatePhysicalPresenceFactor(stats);
    }

    function updatePhysicalPresenceFactor(stats) {
      // Auto-update the day_count checklist item based on day counter stats
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow || !workflow.checklist.physical_presence) return;

      const dayCountItem = workflow.checklist.physical_presence.day_count;
      if (dayCountItem) {
        if (stats.caDays <= 183) {
          dayCountItem.status = 'complete';
          dayCountItem.confidence = 'KNOWN_KNOWN';
        } else {
          dayCountItem.status = 'in_progress';
          dayCountItem.confidence = 'KNOWN_UNKNOWN';
        }
        dayCountItem.notes = 'Auto-tracked: ' + stats.caDays + ' CA days in ' + stats.year;
        dayCountItem.updatedAt = new Date().toISOString();
        saveWorkflows();
      }
    }

    function exportDayEntries() {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const entries = getDayEntries(currentWorkflowId);

      if (entries.length === 0) {
        showToast('No entries to export', 'warning');
        return;
      }

      // Create CSV content
      const headers = ['Date', 'Location', 'Purpose', 'Notes', 'Created At'];
      const rows = entries.map(e => [e.date, e.location, e.purpose, e.notes || '', e.createdAt]);
      const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + v + '"').join(','))].join('\n');

      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = workflow.name.replace(/\s+/g, '_') + '_day_entries_' + new Date().toISOString().split('T')[0] + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Exported ' + entries.length + ' entries to CSV', 'success');
    }

    // ===== WORKFLOW TABS =====
    function showWorkflowTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.workflow-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.workflow-tab[onclick="showWorkflowTab('${tabId}')"]`).classList.add('active');

      // Update tab content
      document.querySelectorAll('.workflow-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');

      // Render content for the tab
      if (tabId === 'dayCounter') renderDayCounter();
      if (tabId === 'safeHarbor') renderSafeHarbor();
      if (tabId === 'addresses') renderAddresses();
      if (tabId === 'evidence') renderEvidence();
      if (tabId === 'realization') renderRealizationEvents();
      if (tabId === 'requests') renderRequests();
      if (tabId === 'checklist') {
        const workflow = workflows.find(w => w.id === currentWorkflowId);
        if (workflow) renderChecklist(workflow);
      }
    }

    // ===== SAFE HARBOR =====
    function getSafeHarbor(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.safeHarbor || {
        employer: '',
        contractStart: '',
        contractEnd: '',
        workLocation: '',
        annualIncome: 0,
        contractDoc: ''
      };
    }

    function saveSafeHarborContract() {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.safeHarbor = {
        employer: document.getElementById('shEmployer').value,
        contractStart: document.getElementById('shContractStart').value,
        contractEnd: document.getElementById('shContractEnd').value,
        workLocation: document.getElementById('shWorkLocation').value,
        annualIncome: parseFloat(document.getElementById('shAnnualIncome').value) || 0,
        contractDoc: document.getElementById('shContractDoc').value
      };

      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'SAFE_HARBOR_UPDATE',
          content: {
            message: workflow.name + ' | Safe Harbor contract saved: ' + workflow.safeHarbor.employer,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            safeHarbor: workflow.safeHarbor
          }
        })
      });

      renderSafeHarbor();
      showToast('Safe Harbor contract saved', 'success');
    }

    function renderSafeHarbor() {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const sh = getSafeHarbor(currentWorkflowId);
      const dayEntries = getDayEntries(currentWorkflowId);

      // Populate form
      document.getElementById('shEmployer').value = sh.employer || '';
      document.getElementById('shContractStart').value = sh.contractStart || '';
      document.getElementById('shContractEnd').value = sh.contractEnd || '';
      document.getElementById('shWorkLocation').value = sh.workLocation || '';
      document.getElementById('shAnnualIncome').value = sh.annualIncome || '';
      document.getElementById('shContractDoc').value = sh.contractDoc || '';

      // Calculate metrics
      let daysOutsideCA = 0;
      let caVisitsThisYear = 0;
      const currentYear = new Date().getFullYear();

      if (sh.contractStart) {
        const contractStart = new Date(sh.contractStart);
        const today = new Date();
        const daysSinceStart = Math.floor((today - contractStart) / (1000 * 60 * 60 * 24));

        // Count CA days during contract period
        const caDaysDuringContract = dayEntries.filter(e => {
          const entryDate = new Date(e.date);
          return e.location === 'CA' && entryDate >= contractStart && entryDate <= today;
        }).length;

        daysOutsideCA = Math.max(0, daysSinceStart - caDaysDuringContract);
      }

      // CA visits this year
      caVisitsThisYear = dayEntries.filter(e => {
        return e.location === 'CA' && new Date(e.date).getFullYear() === currentYear;
      }).length;

      // Update metrics display
      document.getElementById('shDaysOutside').textContent = daysOutsideCA;
      const daysProgress = Math.min(100, Math.round((daysOutsideCA / 546) * 100));
      document.getElementById('shDaysProgress').style.width = daysProgress + '%';

      const daysStatus = daysOutsideCA >= 546 ? 'pass' : 'pending';
      document.getElementById('shDaysStatus').textContent = daysOutsideCA >= 546 ? 'PASS' : 'TRACKING';
      document.getElementById('shDaysStatus').className = 'safe-harbor-metric-status ' + daysStatus;
      document.getElementById('shDaysProgress').style.background = daysOutsideCA >= 546 ? 'var(--safe)' : 'var(--accent)';

      document.getElementById('shCAVisits').textContent = caVisitsThisYear;
      const visitsProgress = Math.min(100, Math.round((caVisitsThisYear / 45) * 100));
      document.getElementById('shVisitsProgress').style.width = visitsProgress + '%';

      const visitsStatus = caVisitsThisYear <= 45 ? 'pass' : 'fail';
      document.getElementById('shVisitsStatus').textContent = caVisitsThisYear <= 45 ? 'PASS' : 'FAIL';
      document.getElementById('shVisitsStatus').className = 'safe-harbor-metric-status ' + visitsStatus;
      document.getElementById('shVisitsProgress').style.background = caVisitsThisYear <= 45 ? 'var(--safe)' : 'var(--action)';

      const income = sh.annualIncome || 0;
      document.getElementById('shIntangibleIncome').textContent = '$' + income.toLocaleString();
      const incomeProgress = Math.min(100, Math.round((income / 200000) * 100));
      document.getElementById('shIncomeProgress').style.width = incomeProgress + '%';

      const incomeStatus = income <= 200000 ? 'pass' : 'fail';
      document.getElementById('shIncomeStatus').textContent = income <= 200000 ? 'PASS' : 'FAIL';
      document.getElementById('shIncomeStatus').className = 'safe-harbor-metric-status ' + incomeStatus;
      document.getElementById('shIncomeProgress').style.background = income <= 200000 ? 'var(--safe)' : 'var(--action)';

      // Overall badge
      const allPass = daysOutsideCA >= 546 && caVisitsThisYear <= 45 && income <= 200000;
      const anyFail = caVisitsThisYear > 45 || income > 200000;
      const badge = document.getElementById('safeHarborBadge');

      if (allPass) {
        badge.textContent = 'ELIGIBLE';
        badge.className = 'safe-harbor-badge eligible';
      } else if (anyFail) {
        badge.textContent = 'INELIGIBLE';
        badge.className = 'safe-harbor-badge ineligible';
      } else {
        badge.textContent = 'PENDING REVIEW';
        badge.className = 'safe-harbor-badge pending';
      }

      // Update requirements icons
      const reqIcons = document.querySelectorAll('#shRequirements .safe-harbor-requirement-icon');
      const reqStatuses = [
        daysOutsideCA >= 546 ? 'pass' : 'pending',
        caVisitsThisYear <= 45 ? 'pass' : 'fail',
        income <= 200000 ? 'pass' : 'fail',
        'pending' // Tax avoidance - manual verification
      ];
      const reqSymbols = { pass: '&#10003;', fail: '&#10005;', pending: '?' };

      reqIcons.forEach((icon, i) => {
        icon.className = 'safe-harbor-requirement-icon ' + reqStatuses[i];
        icon.innerHTML = reqSymbols[reqStatuses[i]];
      });
    }

    // ===== ADDRESSES =====
    function getAddresses(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.addresses || [];
    }

    function addAddress() {
      if (!currentWorkflowId) return;

      const startDate = document.getElementById('addrStartDate').value;
      const endDate = document.getElementById('addrEndDate').value;
      const street = document.getElementById('addrStreet').value;
      const city = document.getElementById('addrCity').value;

      if (!startDate || !street || !city) {
        showToast('Please fill in required fields', 'error');
        return;
      }

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.addresses) workflow.addresses = [];

      const address = {
        id: 'addr_' + Date.now(),
        startDate,
        endDate: endDate || null,
        street,
        city,
        type: city.toLowerCase().includes('ca') || city.toLowerCase().includes('california') ? 'secondary' : 'primary',
        createdAt: new Date().toISOString()
      };

      workflow.addresses.push(address);
      workflow.addresses.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'ADDRESS_ADD',
          content: {
            message: workflow.name + ' | Address added: ' + street + ', ' + city,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            address
          }
        })
      });

      // Clear form
      document.getElementById('addrStartDate').value = '';
      document.getElementById('addrEndDate').value = '';
      document.getElementById('addrStreet').value = '';
      document.getElementById('addrCity').value = '';

      renderAddresses();
      showToast('Address added', 'success');
    }

    function deleteAddress(addrId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.addresses = workflow.addresses.filter(a => a.id !== addrId);
      saveWorkflows();
      renderAddresses();
      showToast('Address deleted', 'success');
    }

    function renderAddresses() {
      if (!currentWorkflowId) return;

      const addresses = getAddresses(currentWorkflowId);
      const container = document.getElementById('addressTimeline');

      if (addresses.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No addresses recorded yet.</div>';
        return;
      }

      container.innerHTML = addresses.map(a => {
        const isCurrent = !a.endDate;
        const isCA = a.city.toLowerCase().includes('ca') || a.city.toLowerCase().includes('california');
        return `
          <div class="address-entry">
            <div class="address-entry-dates">
              <div ${isCurrent ? 'class="address-entry-current"' : ''}>${a.startDate}</div>
              <div>${a.endDate || 'Present'}</div>
            </div>
            <div class="address-entry-info">
              <div class="address-entry-street">${a.street}</div>
              <div class="address-entry-city">${a.city}</div>
            </div>
            <span class="address-entry-type ${isCA ? 'secondary' : 'primary'}">${isCA ? 'CA' : 'Non-CA'}</span>
            <button class="day-entry-delete" onclick="deleteAddress('${a.id}')">&times;</button>
          </div>
        `;
      }).join('');
    }

    // ===== EVIDENCE REPOSITORY =====
    function getEvidence(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.evidence || [];
    }

    function handleEvidenceUpload(event) {
      const file = event.target.files[0];
      if (!file || !currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.evidence) workflow.evidence = [];

      // For now, just store metadata (actual file storage would need backend)
      const evidence = {
        id: 'ev_' + Date.now(),
        name: file.name,
        size: file.size,
        type: file.type,
        category: 'records',
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      workflow.evidence.push(evidence);
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'EVIDENCE_UPLOAD',
          content: {
            message: workflow.name + ' | Evidence uploaded: ' + file.name,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            evidence
          }
        })
      });

      renderEvidence();
      showToast('Evidence added: ' + file.name, 'success');
      event.target.value = '';
    }

    function deleteEvidence(evId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.evidence = workflow.evidence.filter(e => e.id !== evId);
      saveWorkflows();
      renderEvidence();
      showToast('Evidence deleted', 'success');
    }

    function filterEvidence(category) {
      document.querySelectorAll('.evidence-category').forEach(c => c.classList.remove('active'));
      document.querySelector(`.evidence-category[onclick="filterEvidence('${category}')"]`).classList.add('active');
      renderEvidence(category);
    }

    function renderEvidence(filterCat = 'all') {
      if (!currentWorkflowId) return;

      const evidence = getEvidence(currentWorkflowId);
      const filtered = filterCat === 'all' ? evidence : evidence.filter(e => e.category === filterCat);

      // Update counts
      document.getElementById('evidenceTotal').textContent = evidence.length;
      document.getElementById('evidenceVerified').textContent = evidence.filter(e => e.status === 'verified').length;
      document.getElementById('evCatAll').textContent = evidence.length + ' items';
      document.getElementById('evCatOfficial').textContent = evidence.filter(e => e.category === 'official').length + ' items';
      document.getElementById('evCatRecords').textContent = evidence.filter(e => e.category === 'records').length + ' items';
      document.getElementById('evCatDigital').textContent = evidence.filter(e => e.category === 'digital').length + ' items';
      document.getElementById('evCatThirdparty').textContent = evidence.filter(e => e.category === 'thirdparty').length + ' items';

      const container = document.getElementById('evidenceList');
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No evidence uploaded yet.</div>';
        return;
      }

      container.innerHTML = filtered.map(e => {
        const icon = e.type?.includes('pdf') ? '&#128196;' : e.type?.includes('image') ? '&#128247;' : '&#128193;';
        const sizeKB = Math.round(e.size / 1024);
        return `
          <div class="evidence-item">
            <div class="evidence-item-icon">${icon}</div>
            <div class="evidence-item-info">
              <div class="evidence-item-name">${e.name}</div>
              <div class="evidence-item-meta">${sizeKB}KB | ${new Date(e.createdAt).toLocaleDateString()}</div>
            </div>
            <span class="evidence-item-category">${e.category}</span>
            <span class="evidence-item-status ${e.status}">${e.status}</span>
            <button class="day-entry-delete" onclick="deleteEvidence('${e.id}')">&times;</button>
          </div>
        `;
      }).join('');
    }

    // ===== REALIZATION EVENTS =====
    function getRealizationEvents(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.realizationEvents || [];
    }

    function addRealizationEvent() {
      if (!currentWorkflowId) return;

      const date = document.getElementById('realEventDate').value;
      const type = document.getElementById('realEventType').value;
      const amount = parseFloat(document.getElementById('realEventAmount').value) || 0;
      const desc = document.getElementById('realEventDesc').value;

      if (!date || !amount) {
        showToast('Please fill in date and amount', 'error');
        return;
      }

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.realizationEvents) workflow.realizationEvents = [];

      const event = {
        id: 'real_' + Date.now(),
        date,
        type,
        amount,
        description: desc,
        createdAt: new Date().toISOString()
      };

      workflow.realizationEvents.push(event);
      workflow.realizationEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'REALIZATION_EVENT',
          content: {
            message: workflow.name + ' | ' + type + ': $' + amount.toLocaleString(),
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            event
          }
        })
      });

      // Clear form
      document.getElementById('realEventDate').value = '';
      document.getElementById('realEventAmount').value = '';
      document.getElementById('realEventDesc').value = '';

      renderRealizationEvents();
      showToast('Realization event added', 'success');
    }

    function deleteRealizationEvent(eventId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.realizationEvents = workflow.realizationEvents.filter(e => e.id !== eventId);
      saveWorkflows();
      renderRealizationEvents();
      showToast('Event deleted', 'success');
    }

    function renderRealizationEvents() {
      if (!currentWorkflowId) return;

      const events = getRealizationEvents(currentWorkflowId);
      const container = document.getElementById('realizationTimeline');

      if (events.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No realization events recorded.</div>';
        return;
      }

      const typeLabels = {
        'RSU_VEST': 'RSU Vest',
        'STOCK_SALE': 'Stock Sale',
        'OPTION_EXERCISE': 'Option Exercise',
        'BONUS': 'Bonus',
        'DEFERRED_COMP': 'Deferred Comp',
        'OTHER': 'Other'
      };

      const typeClasses = {
        'RSU_VEST': 'rsu',
        'STOCK_SALE': 'sale',
        'OPTION_EXERCISE': 'stock',
        'BONUS': 'stock',
        'DEFERRED_COMP': 'rsu',
        'OTHER': 'stock'
      };

      container.innerHTML = events.map(e => `
        <div class="timeline-event ${e.type === 'STOCK_SALE' ? 'realized' : ''}">
          <div class="timeline-event-header">
            <span class="timeline-event-date">${e.date}</span>
            <span class="timeline-event-type ${typeClasses[e.type] || 'stock'}">${typeLabels[e.type] || e.type}</span>
          </div>
          <div class="timeline-event-title">${e.description || typeLabels[e.type]}</div>
          <div class="timeline-event-amount">$${e.amount.toLocaleString()}</div>
          <button class="day-entry-delete" style="position:absolute;top:12px;right:12px;" onclick="deleteRealizationEvent('${e.id}')">&times;</button>
        </div>
      `).join('');
    }

    // ===== THIRD-PARTY REQUESTS =====
    function getRequests(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.requests || [];
    }

    function addRequest() {
      if (!currentWorkflowId) return;

      const entity = document.getElementById('reqEntity').value;
      const type = document.getElementById('reqType').value;
      const dateSent = document.getElementById('reqDateSent').value;
      const status = document.getElementById('reqStatus').value;

      if (!entity || !type) {
        showToast('Please fill in entity and type', 'error');
        return;
      }

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.requests) workflow.requests = [];

      const request = {
        id: 'req_' + Date.now(),
        entity,
        type,
        dateSent: dateSent || null,
        status,
        createdAt: new Date().toISOString()
      };

      workflow.requests.push(request);
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'REQUEST_ADD',
          content: {
            message: workflow.name + ' | Request added: ' + entity + ' - ' + type,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            request
          }
        })
      });

      // Clear form
      document.getElementById('reqEntity').value = '';
      document.getElementById('reqDateSent').value = '';

      renderRequests();
      showToast('Request added', 'success');
    }

    function updateRequestStatus(reqId, newStatus) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const request = workflow.requests.find(r => r.id === reqId);
      if (request) {
        request.status = newStatus;
        request.updatedAt = new Date().toISOString();
        saveWorkflows();
        renderRequests();
      }
    }

    function deleteRequest(reqId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.requests = workflow.requests.filter(r => r.id !== reqId);
      saveWorkflows();
      renderRequests();
      showToast('Request deleted', 'success');
    }

    function renderRequests() {
      if (!currentWorkflowId) return;

      const requests = getRequests(currentWorkflowId);
      const container = document.getElementById('requestsList');

      if (requests.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No requests tracked yet.</div>';
        return;
      }

      const typeLabels = {
        'EMPLOYMENT_LETTER': 'Employment Letter',
        'BANK_STATEMENT': 'Bank Statement',
        'UTILITY_RECORDS': 'Utility Records',
        'MEDICAL_RECORDS': 'Medical Records',
        'MEMBERSHIP': 'Membership',
        'OTHER': 'Other'
      };

      container.innerHTML = requests.map(r => `
        <div class="request-item">
          <div>
            <div class="request-item-entity">${r.entity}</div>
            <div class="request-item-type">${typeLabels[r.type] || r.type}</div>
          </div>
          <span class="request-item-date">${r.dateSent || 'Not sent'}</span>
          <select class="checklist-select" style="width:100px" onchange="updateRequestStatus('${r.id}', this.value)">
            <option value="PENDING" ${r.status === 'PENDING' ? 'selected' : ''}>Pending</option>
            <option value="SENT" ${r.status === 'SENT' ? 'selected' : ''}>Sent</option>
            <option value="RECEIVED" ${r.status === 'RECEIVED' ? 'selected' : ''}>Received</option>
            <option value="OVERDUE" ${r.status === 'OVERDUE' ? 'selected' : ''}>Overdue</option>
          </select>
          <span class="request-item-status ${r.status.toLowerCase()}">${r.status}</span>
          <button class="day-entry-delete" onclick="deleteRequest('${r.id}')">&times;</button>
        </div>
      `).join('');
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      loadHomeStats();
      loadPulseBar();
    });
  </script>
</body>
</html>
