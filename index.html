<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Newton - AI Governance Platform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-dark: #0a0a0f;
      --bg-card: #12121a;
      --bg-hover: #1a1a25;
      --bg-active: #252535;
      --border: rgba(255,255,255,0.08);
      --border-hover: rgba(255,255,255,0.15);
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --safe: #10b981;
      --watch: #f59e0b;
      --action: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    /* ===== NAVIGATION ===== */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: rgba(10, 10, 15, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      z-index: 100;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 20px;
      font-weight: 700;
      color: var(--text-primary);
      text-decoration: none;
      cursor: pointer;
    }

    .nav-brand-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), #a855f7);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .nav-links {
      display: flex;
      gap: 8px;
    }

    .nav-link {
      padding: 10px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
    }

    .nav-link:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .nav-link.active {
      color: var(--text-primary);
      background: var(--bg-active);
    }

    .nav-status {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-card);
      border-radius: 20px;
      font-size: 13px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--safe);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ===== HERO PULSE BAR ===== */
    .pulse-bar {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 32px;
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 24px;
      z-index: 99;
    }

    .pulse-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .pulse-section.center {
      justify-content: center;
    }

    .pulse-section.right {
      justify-content: flex-end;
    }

    .chain-visualizer {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .chain-block {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      background: var(--safe);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: white;
      transition: all 0.3s;
    }

    .chain-connector {
      width: 8px;
      height: 2px;
      background: var(--safe);
    }

    .pulse-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pulse-value {
      font-size: 14px;
      font-weight: 600;
    }

    .pulse-value.verified { color: var(--safe); }
    .pulse-value.broken { color: var(--action); }

    .pulse-subtext {
      font-size: 11px;
      color: var(--text-muted);
    }

    .pulse-counter {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .pulse-counter-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
    }

    .pulse-counter-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .pulse-alert {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 8px;
      max-width: 350px;
    }

    .pulse-alert-icon {
      font-size: 18px;
    }

    .pulse-alert-text {
      font-size: 13px;
      flex: 1;
    }

    .economic-impact {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.2);
      border-radius: 8px;
    }

    .economic-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--safe);
    }

    .economic-label {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* ===== ROLE SELECTOR ===== */
    .role-bar {
      position: fixed;
      top: 140px;
      left: 0;
      right: 0;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
      padding: 12px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      z-index: 98;
    }

    .role-selector {
      display: flex;
      gap: 4px;
      background: var(--bg-dark);
      padding: 4px;
      border-radius: 8px;
    }

    .role-btn {
      padding: 8px 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .role-btn:hover {
      color: var(--text-secondary);
    }

    .role-btn.active {
      background: var(--accent);
      color: white;
    }

    .role-filters {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .role-filter-select {
      padding: 8px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 12px;
    }

    .role-identity {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ===== MAIN CONTENT ===== */
    .main {
      padding-top: 100px;
      min-height: 100vh;
    }

    /* Hide the pulse-bar and role-bar - causing overlap issues */
    .pulse-bar, .role-bar {
      display: none;
    }

    .page {
      display: none;
      padding: 40px;
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeIn 0.3s ease;
    }

    .page.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== HOME PAGE ===== */
    .hero {
      text-align: center;
      padding: 60px 0;
    }

    .hero-title {
      font-size: 48px;
      font-weight: 700;
      margin-bottom: 16px;
      background: linear-gradient(135deg, #fff, #a0a0b0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .hero-subtitle {
      font-size: 20px;
      color: var(--text-secondary);
      max-width: 600px;
      margin: 0 auto 40px;
    }

    .hero-stats {
      display: flex;
      justify-content: center;
      gap: 48px;
      margin-bottom: 60px;
    }

    .hero-stat {
      text-align: center;
    }

    .hero-stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
    }

    .hero-stat-label {
      font-size: 14px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ===== SECTION TITLE ===== */
    .section-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    /* ===== CAPABILITY CARDS ===== */
    .capabilities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 24px;
      margin-bottom: 60px;
    }

    .capability-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .capability-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    .capability-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .capability-icon {
      width: 56px;
      height: 56px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      background: var(--bg-hover);
    }

    .capability-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .capability-status.active {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .capability-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .capability-description {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .capability-features {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .capability-feature {
      padding: 6px 12px;
      background: var(--bg-hover);
      border-radius: 6px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .capability-action {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .capability-action-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .capability-action-btn:hover {
      background: var(--accent-hover);
    }

    /* ===== TABLES ===== */
    .ledger-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      gap: 16px;
      flex-wrap: wrap;
    }

    .ledger-filters {
      display: flex;
      gap: 12px;
    }

    .filter-select {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .ledger-search {
      display: flex;
      gap: 8px;
    }

    .ledger-search input {
      padding: 10px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      font-size: 14px;
      width: 280px;
    }

    .ledger-table {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .ledger-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .ledger-table th {
      padding: 16px 20px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
    }

    .ledger-table td {
      padding: 16px 20px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    .ledger-table tr:last-child td {
      border-bottom: none;
    }

    .ledger-table tr:hover td {
      background: var(--bg-hover);
    }

    .ledger-uuid {
      font-family: 'SF Mono', 'Consolas', monospace;
      font-size: 12px;
      color: var(--text-muted);
    }

    .ledger-event-type {
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      background: var(--bg-hover);
    }

    .ledger-confidence {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .confidence-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .confidence-dot.known-known { background: var(--safe); }
    .confidence-dot.known-unknown { background: var(--watch); }
    .confidence-dot.unknown-unknown { background: var(--action); }

    /* ===== WORKFLOWS PAGE ===== */
    .workflows-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
    }

    .workflow-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .workflow-card:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }

    .workflow-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .workflow-card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .workflow-card-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .workflow-card-status.active {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .workflow-card-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .workflow-card-meta {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .workflow-card-progress {
      height: 6px;
      background: var(--bg-hover);
      border-radius: 3px;
      overflow: hidden;
    }

    .workflow-card-progress-bar {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      transition: width 0.3s;
    }

    .workflow-card-stats {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* ===== WORKFLOW DETAIL ===== */
    .workflow-header {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .workflow-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
    }

    .workflow-client-name {
      font-size: 24px;
      font-weight: 700;
    }

    .workflow-header-meta {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
    }

    .workflow-meta-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .workflow-meta-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .workflow-meta-value {
      font-size: 14px;
      font-weight: 500;
    }

    .checklist-category {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 16px;
      overflow: hidden;
    }

    .checklist-category-header {
      padding: 16px 20px;
      background: var(--bg-hover);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .checklist-category-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .checklist-category-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .checklist-category-body {
      padding: 0;
    }

    .checklist-item {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
    }

    .checklist-item:last-child {
      border-bottom: none;
    }

    .checklist-item-name {
      font-size: 14px;
    }

    .checklist-item-status {
      width: 140px;
    }

    .checklist-item-confidence {
      width: 180px;
    }

    .checklist-item-actions {
      display: flex;
      gap: 8px;
    }

    .checklist-select {
      padding: 8px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 12px;
      width: 100%;
      cursor: pointer;
    }

    .checklist-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .checklist-btn {
      padding: 8px 12px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .checklist-btn:hover {
      background: var(--bg-active);
      color: var(--text-primary);
    }

    .checklist-btn.primary {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    /* ===== TOOLTIP ===== */
    .tooltip-container {
      position: relative;
    }

    .tooltip-container:hover .tooltip {
      opacity: 1;
      visibility: visible;
    }

    .tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-dark);
      border: 1px solid var(--border);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 50;
      margin-bottom: 8px;
    }

    /* ===== MODAL ===== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 20px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: var(--bg-hover);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }

    .modal-footer {
      padding: 20px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .form-input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-textarea {
      min-height: 120px;
      resize: vertical;
    }

    .form-hint {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-hover);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    /* ===== LOADING ===== */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px;
      color: var(--text-secondary);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== TOAST ===== */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 300;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      padding: 16px 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .toast.success { border-color: var(--safe); }
    .toast.error { border-color: var(--action); }
    .toast.warning { border-color: var(--watch); }

    /* ===== EMPTY STATE ===== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state-title {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .empty-state-text {
      font-size: 14px;
      margin-bottom: 24px;
    }

    /* ===== DAY COUNTER ===== */
    .day-counter-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .day-counter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .day-counter-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .day-counter-title-icon {
      font-size: 24px;
    }

    .day-counter-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .day-stat-card {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .day-stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .day-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .day-stat-value.safe { color: var(--safe); }
    .day-stat-value.caution { color: var(--watch); }
    .day-stat-value.warning { color: #f97316; }
    .day-stat-value.danger { color: var(--action); }

    .day-progress-container {
      margin-bottom: 24px;
    }

    .day-progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .day-progress-label {
      font-size: 14px;
      font-weight: 600;
    }

    .day-progress-value {
      font-size: 14px;
      font-family: 'SF Mono', 'Consolas', monospace;
    }

    .day-progress-bar {
      height: 24px;
      background: var(--bg-dark);
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .day-progress-fill {
      height: 100%;
      border-radius: 12px;
      transition: width 0.5s ease, background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      font-size: 12px;
      font-weight: 600;
      color: white;
    }

    .day-progress-fill.safe { background: linear-gradient(90deg, #059669, var(--safe)); }
    .day-progress-fill.caution { background: linear-gradient(90deg, #d97706, var(--watch)); }
    .day-progress-fill.warning { background: linear-gradient(90deg, #ea580c, #f97316); }
    .day-progress-fill.danger { background: linear-gradient(90deg, #dc2626, var(--action)); }

    .day-progress-markers {
      display: flex;
      justify-content: space-between;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .day-progress-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .day-progress-marker-line {
      width: 1px;
      height: 6px;
      background: var(--text-muted);
      margin-bottom: 2px;
    }

    .day-alert-banner {
      padding: 12px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
      font-size: 14px;
    }

    .day-alert-banner.safe {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: var(--safe);
    }

    .day-alert-banner.caution {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--watch);
    }

    .day-alert-banner.warning {
      background: rgba(249, 115, 22, 0.1);
      border: 1px solid rgba(249, 115, 22, 0.3);
      color: #f97316;
    }

    .day-alert-banner.danger {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: var(--action);
    }

    .day-alert-icon {
      font-size: 20px;
    }

    .day-entry-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      margin-bottom: 20px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
    }

    .day-entry-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .day-entry-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .day-entry-input {
      padding: 10px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 14px;
    }

    .day-entry-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .day-entry-btn {
      padding: 10px 20px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .day-entry-btn:hover {
      background: var(--accent-hover);
    }

    .day-entries-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .day-entries-header {
      display: grid;
      grid-template-columns: 120px 80px 120px 1fr 60px;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-hover);
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .day-entry-row {
      display: grid;
      grid-template-columns: 120px 80px 120px 1fr 60px;
      gap: 12px;
      padding: 12px 16px;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .day-entry-row:last-child {
      border-bottom: none;
    }

    .day-entry-row:hover {
      background: var(--bg-hover);
    }

    .day-entry-location {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .day-entry-location.ca {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .day-entry-location.other {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .day-entry-delete {
      padding: 6px 10px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .day-entry-delete:hover {
      background: rgba(239, 68, 68, 0.1);
      border-color: var(--action);
      color: var(--action);
    }

    .day-bulk-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .day-bulk-toggle input {
      accent-color: var(--accent);
    }

    .day-bulk-form {
      display: none;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .day-bulk-form.active {
      display: block;
    }

    .day-bulk-textarea {
      width: 100%;
      min-height: 80px;
      padding: 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 13px;
      font-family: 'SF Mono', 'Consolas', monospace;
      resize: vertical;
      margin-bottom: 12px;
    }

    .day-bulk-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    /* ===== WORKFLOW TABS ===== */
    .workflow-tabs {
      display: flex;
      gap: 4px;
      background: var(--bg-hover);
      padding: 4px;
      border-radius: 10px;
      margin-bottom: 24px;
      overflow-x: auto;
    }

    .workflow-tab {
      padding: 10px 16px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .workflow-tab:hover {
      color: var(--text-secondary);
      background: var(--bg-active);
    }

    .workflow-tab.active {
      background: var(--accent);
      color: white;
    }

    .workflow-tab-content {
      display: none;
    }

    .workflow-tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    /* ===== SAFE HARBOR SECTION ===== */
    .safe-harbor-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .safe-harbor-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .safe-harbor-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .safe-harbor-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .safe-harbor-badge.eligible {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .safe-harbor-badge.ineligible {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .safe-harbor-badge.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .safe-harbor-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .safe-harbor-metric {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
    }

    .safe-harbor-metric-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .safe-harbor-metric-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .safe-harbor-metric-status {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
    }

    .safe-harbor-metric-status.pass {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .safe-harbor-metric-status.fail {
      background: rgba(239, 68, 68, 0.2);
      color: var(--action);
    }

    .safe-harbor-metric-value {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .safe-harbor-metric-target {
      font-size: 12px;
      color: var(--text-muted);
    }

    .safe-harbor-progress {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      margin-top: 12px;
      overflow: hidden;
    }

    .safe-harbor-progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .safe-harbor-contract {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .safe-harbor-contract-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .safe-harbor-contract-title {
      font-size: 14px;
      font-weight: 600;
    }

    .safe-harbor-form {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .safe-harbor-form-full {
      grid-column: 1 / -1;
    }

    .safe-harbor-requirements {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 16px;
    }

    .safe-harbor-requirement {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 12px;
      background: var(--bg-hover);
      border-radius: 8px;
    }

    .safe-harbor-requirement-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      flex-shrink: 0;
    }

    .safe-harbor-requirement-icon.pass {
      background: var(--safe);
      color: white;
    }

    .safe-harbor-requirement-icon.fail {
      background: var(--action);
      color: white;
    }

    .safe-harbor-requirement-icon.pending {
      background: var(--watch);
      color: white;
    }

    .safe-harbor-requirement-text {
      font-size: 13px;
    }

    .safe-harbor-requirement-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .safe-harbor-requirement-desc {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* ===== EVIDENCE REPOSITORY ===== */
    .evidence-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .evidence-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .evidence-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .evidence-stats {
      display: flex;
      gap: 16px;
      font-size: 13px;
    }

    .evidence-stat {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-secondary);
    }

    .evidence-stat-count {
      font-weight: 600;
      color: var(--text-primary);
    }

    .evidence-categories {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .evidence-category {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .evidence-category:hover {
      border-color: var(--border-hover);
    }

    .evidence-category.active {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .evidence-category-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .evidence-category-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .evidence-category-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .evidence-upload-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 32px;
      text-align: center;
      margin-bottom: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .evidence-upload-zone:hover {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.05);
    }

    .evidence-upload-icon {
      font-size: 36px;
      margin-bottom: 12px;
    }

    .evidence-upload-text {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .evidence-upload-hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .evidence-list {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .evidence-item {
      display: grid;
      grid-template-columns: 40px 1fr auto auto auto;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .evidence-item:last-child {
      border-bottom: none;
    }

    .evidence-item-icon {
      width: 40px;
      height: 40px;
      background: var(--bg-hover);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .evidence-item-info {
      min-width: 0;
    }

    .evidence-item-name {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .evidence-item-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    .evidence-item-category {
      padding: 4px 10px;
      background: var(--bg-hover);
      border-radius: 12px;
      font-size: 11px;
      color: var(--text-secondary);
    }

    .evidence-item-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .evidence-item-status.verified {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .evidence-item-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    /* ===== REALIZATION EVENTS TIMELINE ===== */
    .timeline-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .timeline-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .timeline-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timeline-info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--info);
    }

    .timeline-form {
      display: grid;
      grid-template-columns: 1fr 1fr 2fr;
      gap: 12px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
      align-items: end;
    }

    .timeline-events {
      position: relative;
      padding-left: 30px;
    }

    .timeline-events::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-event {
      position: relative;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -24px;
      top: 20px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      border: 2px solid var(--bg-dark);
    }

    .timeline-event.realized::before {
      background: var(--action);
    }

    .timeline-event.pending::before {
      background: var(--watch);
    }

    .timeline-event-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .timeline-event-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .timeline-event-type {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .timeline-event-type.stock {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .timeline-event-type.rsu {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    .timeline-event-type.sale {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .timeline-event-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .timeline-event-amount {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
    }

    .timeline-event-details {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ===== ADDRESS TIMELINE ===== */
    .address-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .address-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
      align-items: end;
    }

    .address-timeline {
      position: relative;
    }

    .address-entry {
      display: grid;
      grid-template-columns: 120px 1fr 100px 60px;
      gap: 16px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .address-entry-dates {
      font-size: 12px;
      color: var(--text-muted);
    }

    .address-entry-current {
      font-weight: 600;
      color: var(--safe);
    }

    .address-entry-info {
      font-size: 14px;
    }

    .address-entry-street {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .address-entry-city {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .address-entry-type {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }

    .address-entry-type.primary {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .address-entry-type.secondary {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .address-entry-type.business {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
    }

    /* ===== THIRD PARTY REQUESTS ===== */
    .requests-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .requests-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .requests-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .requests-info {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--watch);
    }

    .requests-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr 1fr auto;
      gap: 12px;
      padding: 16px;
      background: var(--bg-hover);
      border-radius: 8px;
      margin-bottom: 20px;
      align-items: end;
    }

    .requests-list {
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .request-item {
      display: grid;
      grid-template-columns: 1fr 120px 120px 100px 60px;
      gap: 16px;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .request-item:last-child {
      border-bottom: none;
    }

    .request-item-entity {
      font-size: 14px;
      font-weight: 600;
    }

    .request-item-type {
      font-size: 12px;
      color: var(--text-muted);
    }

    .request-item-date {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .request-item-status {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      text-align: center;
    }

    .request-item-status.sent {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .request-item-status.received {
      background: rgba(16, 185, 129, 0.15);
      color: var(--safe);
    }

    .request-item-status.pending {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .request-item-status.overdue {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    /* ===== BRAGG FRAMEWORK SECTION ===== */
    .framework-section {
      margin-bottom: 48px;
    }

    .framework-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .framework-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .framework-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      max-width: 600px;
    }

    .framework-source {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .framework-source strong {
      color: var(--text-secondary);
    }

    .bragg-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 16px;
    }

    .bragg-factor {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      transition: all 0.2s;
    }

    .bragg-factor:hover {
      border-color: var(--border-hover);
    }

    .bragg-factor-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }

    .bragg-factor-number {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }

    .bragg-factor-number.highest {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .bragg-factor-number.moderate {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .bragg-factor-number.least {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .bragg-factor-number.corroborative {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .bragg-factor-name {
      font-size: 14px;
      font-weight: 600;
      flex: 1;
    }

    .bragg-factor-weight {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .bragg-factor-weight.highest {
      background: rgba(239, 68, 68, 0.15);
      color: var(--action);
    }

    .bragg-factor-weight.moderate {
      background: rgba(245, 158, 11, 0.15);
      color: var(--watch);
    }

    .bragg-factor-weight.least {
      background: rgba(59, 130, 246, 0.15);
      color: var(--info);
    }

    .bragg-factor-weight.corroborative {
      background: rgba(99, 102, 241, 0.15);
      color: var(--accent);
    }

    .bragg-factor-desc {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    /* ===== FEATURE MAP (BAYCOMPLY STYLE) ===== */
    .feature-map {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 48px;
    }

    .feature-map-header {
      padding: 20px 24px;
      background: var(--bg-hover);
      border-bottom: 1px solid var(--border);
    }

    .feature-map-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .feature-map-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .feature-map-table {
      width: 100%;
    }

    .feature-map-row {
      display: grid;
      grid-template-columns: 200px 1fr;
      border-bottom: 1px solid var(--border);
    }

    .feature-map-row:last-child {
      border-bottom: none;
    }

    .feature-map-feature {
      padding: 16px 24px;
      font-size: 14px;
      font-weight: 600;
      background: var(--bg-hover);
      display: flex;
      align-items: center;
      gap: 10px;
      border-right: 1px solid var(--border);
    }

    .feature-map-icon {
      font-size: 18px;
    }

    .feature-map-desc {
      padding: 16px 24px;
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* ===== WEIGHT LEGEND ===== */
    .weight-legend {
      display: flex;
      gap: 16px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .weight-legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .weight-legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }

    .weight-legend-dot.highest { background: var(--action); }
    .weight-legend-dot.moderate { background: var(--watch); }
    .weight-legend-dot.least { background: var(--info); }
    .weight-legend-dot.corroborative { background: var(--accent); }

    /* ===== ROADMAP TIMELINE ===== */
    .roadmap-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }

    .roadmap-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
    }

    .roadmap-title {
      font-size: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .roadmap-progress {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .roadmap-progress-bar {
      width: 200px;
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      overflow: hidden;
    }

    .roadmap-progress-fill {
      height: 100%;
      background: var(--safe);
      border-radius: 4px;
      transition: width 0.3s;
    }

    .roadmap-progress-text {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .roadmap-phases {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .roadmap-phase {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }

    .roadmap-phase-header {
      padding: 16px 20px;
      background: var(--bg-hover);
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .roadmap-phase-header:hover {
      background: var(--bg-active);
    }

    .roadmap-phase-title {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .roadmap-phase-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .roadmap-phase-icon.before { background: rgba(99, 102, 241, 0.15); }
    .roadmap-phase-icon.move { background: rgba(245, 158, 11, 0.15); }
    .roadmap-phase-icon.after { background: rgba(16, 185, 129, 0.15); }
    .roadmap-phase-icon.ongoing { background: rgba(59, 130, 246, 0.15); }
    .roadmap-phase-icon.annual { background: rgba(168, 85, 247, 0.15); }

    .roadmap-phase-name {
      font-size: 15px;
      font-weight: 600;
    }

    .roadmap-phase-timing {
      font-size: 12px;
      color: var(--text-muted);
    }

    .roadmap-phase-stats {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .roadmap-phase-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .roadmap-phase-toggle {
      font-size: 18px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .roadmap-phase.expanded .roadmap-phase-toggle {
      transform: rotate(180deg);
    }

    .roadmap-phase-body {
      display: none;
      padding: 0;
    }

    .roadmap-phase.expanded .roadmap-phase-body {
      display: block;
    }

    .roadmap-task {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: grid;
      grid-template-columns: 32px 1fr 120px 100px;
      gap: 16px;
      align-items: start;
    }

    .roadmap-task:last-child {
      border-bottom: none;
    }

    .roadmap-task-check {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 2px;
    }

    .roadmap-task-check:hover {
      border-color: var(--accent);
    }

    .roadmap-task-check.complete {
      background: var(--safe);
      border-color: var(--safe);
      color: white;
    }

    .roadmap-task-check.in-progress {
      background: var(--watch);
      border-color: var(--watch);
      color: white;
    }

    .roadmap-task-content {
      min-width: 0;
    }

    .roadmap-task-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .roadmap-task-why {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      line-height: 1.4;
    }

    .roadmap-task-evidence {
      font-size: 11px;
      color: var(--text-muted);
      background: var(--bg-hover);
      padding: 6px 10px;
      border-radius: 6px;
      display: inline-block;
    }

    .roadmap-task-evidence strong {
      color: var(--text-secondary);
    }

    .roadmap-task-weight {
      text-align: right;
    }

    .roadmap-task-weight-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .roadmap-task-status {
      text-align: right;
    }

    .roadmap-task-status select {
      padding: 6px 10px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
    }

    .roadmap-legal-note {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--info);
    }

    .roadmap-decision-box {
      background: var(--bg-hover);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .roadmap-decision-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .roadmap-decision-options {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .roadmap-decision-option {
      padding: 12px;
      background: var(--bg-dark);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .roadmap-decision-option:hover {
      border-color: var(--border-hover);
    }

    .roadmap-decision-option.selected {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .roadmap-decision-option-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .roadmap-decision-option-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ===== TRAP WARNINGS ===== */
    .trap-warnings-panel {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .trap-warnings-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .trap-warnings-header:hover {
      background: rgba(239, 68, 68, 0.05);
    }

    .trap-warnings-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--action);
    }

    .trap-warnings-toggle {
      font-size: 12px;
      color: var(--text-muted);
      transition: transform 0.2s;
    }

    .trap-warnings-panel.expanded .trap-warnings-toggle {
      transform: rotate(180deg);
    }

    .trap-warnings-body {
      display: none;
      padding: 0 16px 16px;
    }

    .trap-warnings-panel.expanded .trap-warnings-body {
      display: block;
    }

    .trap-warning-item {
      background: var(--bg-dark);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .trap-warning-item:last-child {
      margin-bottom: 0;
    }

    .trap-warning-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--action);
      margin-bottom: 4px;
    }

    .trap-warning-desc {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .trap-warning-case {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
    }

    .trap-warning-evidence {
      font-size: 11px;
      color: var(--safe);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid var(--border);
    }

    .rsu-allocation-box {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .rsu-allocation-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--watch);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rsu-allocation-formula {
      background: var(--bg-dark);
      border-radius: 6px;
      padding: 12px;
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
      color: var(--text-primary);
      margin-bottom: 8px;
    }

    .rsu-allocation-note {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .rsu-allocation-source {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 8px;
      font-style: italic;
    }

    /* ===== DETECTOR ALERTS ===== */
    .detector-alert {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      display: none;
    }

    .detector-alert.active {
      display: block;
    }

    .detector-alert.warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.4);
    }

    .detector-alert.critical {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .detector-alert-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 600;
      color: var(--action);
      margin-bottom: 6px;
    }

    .detector-alert.warning .detector-alert-header {
      color: var(--watch);
    }

    .detector-alert-body {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .detector-alert-case {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 6px;
    }

    /* ===== CRITICAL PERIOD ANALYSIS ===== */
    .critical-period-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .critical-period-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .critical-period-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .critical-period-stat {
      background: var(--bg-dark);
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .critical-period-value {
      font-size: 24px;
      font-weight: 700;
    }

    .critical-period-value.pass { color: var(--safe); }
    .critical-period-value.fail { color: var(--action); }

    .critical-period-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* ===== NEAR AND DEAR INVENTORY ===== */
    .inventory-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .inventory-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .inventory-grid {
      display: grid;
      gap: 8px;
    }

    .inventory-item {
      display: grid;
      grid-template-columns: 1fr 150px;
      gap: 12px;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .inventory-item-name {
      font-size: 13px;
    }

    .inventory-item-select {
      padding: 6px 10px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
    }

    /* ===== HOUSING COMPARISON ===== */
    .housing-comparison-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .housing-comparison-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .housing-comparison-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .housing-card {
      background: var(--bg-dark);
      border-radius: 8px;
      padding: 12px;
    }

    .housing-card-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .housing-card-field {
      margin-bottom: 8px;
    }

    .housing-card-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .housing-card-input {
      width: 100%;
      padding: 6px 10px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
    }

    /* ===== FAMILY LOCATION TRACKER ===== */
    .family-tracker-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .family-tracker-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .family-tracker-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .family-tracker-grid {
      display: grid;
      gap: 8px;
    }

    .family-tracker-row {
      display: grid;
      grid-template-columns: 1fr 150px;
      gap: 12px;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .family-tracker-label {
      font-size: 13px;
    }

    /* ===== RSU CALCULATOR ===== */
    .rsu-calculator-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .rsu-calculator-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .rsu-calculator-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .rsu-calc-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rsu-calc-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .rsu-calc-input {
      padding: 8px 10px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .rsu-result-box {
      background: var(--bg-dark);
      border-radius: 8px;
      padding: 16px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      text-align: center;
    }

    .rsu-result-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .rsu-result-value {
      font-size: 18px;
      font-weight: 700;
    }

    .rsu-result-value.highlight { color: var(--watch); }

    .rsu-result-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ===== CONTRACT TYPE WARNING ===== */
    .contract-type-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .contract-type-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .contract-type-options {
      display: grid;
      gap: 8px;
    }

    .contract-type-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .contract-type-option:hover {
      border-color: var(--border-hover);
    }

    .contract-type-option.selected {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .contract-type-radio {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .contract-type-option.selected .contract-type-radio {
      border-color: var(--accent);
    }

    .contract-type-option.selected .contract-type-radio::after {
      content: '';
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
    }

    .contract-type-label {
      font-size: 13px;
    }

    /* ===== WORKFLOW TYPE SELECTOR ===== */
    .workflow-type-selector {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }

    .workflow-type-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-dark);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .workflow-type-option:hover {
      border-color: var(--border-hover);
    }

    .workflow-type-option.selected {
      border-color: var(--accent);
      background: rgba(99, 102, 241, 0.1);
    }

    .workflow-type-icon {
      font-size: 28px;
    }

    .workflow-type-info {
      flex: 1;
    }

    .workflow-type-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .workflow-type-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ===== CALCOMPETES SPECIFIC ===== */
    .cc-eligibility-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .cc-eligibility-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cc-eligibility-grid {
      display: grid;
      gap: 8px;
    }

    .cc-eligibility-item {
      display: grid;
      grid-template-columns: 1fr 100px;
      gap: 12px;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .cc-eligibility-question {
      font-size: 13px;
    }

    .cc-eligibility-answer {
      display: flex;
      gap: 8px;
    }

    .cc-eligibility-btn {
      flex: 1;
      padding: 6px 12px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cc-eligibility-btn:hover {
      border-color: var(--border-hover);
    }

    .cc-eligibility-btn.yes.selected {
      background: rgba(16, 185, 129, 0.2);
      border-color: var(--safe);
      color: var(--safe);
    }

    .cc-eligibility-btn.no.selected {
      background: rgba(239, 68, 68, 0.2);
      border-color: var(--action);
      color: var(--action);
    }

    .cc-result-banner {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 13px;
      font-weight: 500;
    }

    .cc-result-banner.pass {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.4);
      color: var(--safe);
    }

    .cc-result-banner.fail {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: var(--action);
    }

    .cc-result-banner.warning {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.4);
      color: var(--watch);
    }

    /* Cost-Benefit Ratio Calculator */
    .cc-ratio-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .cc-ratio-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .cc-ratio-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .cc-ratio-field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cc-ratio-label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .cc-ratio-input {
      padding: 8px 10px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 13px;
    }

    .cc-ratio-result {
      background: var(--bg-dark);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .cc-ratio-value {
      font-size: 36px;
      font-weight: 700;
    }

    .cc-ratio-value.good { color: var(--safe); }
    .cc-ratio-value.ok { color: var(--watch); }
    .cc-ratio-value.bad { color: var(--action); }

    .cc-ratio-label-big {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .cc-ratio-benchmark {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 12px;
    }

    /* AFTE Calculator */
    .cc-afte-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .cc-afte-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .cc-afte-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .cc-afte-tab {
      padding: 8px 16px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cc-afte-tab.active {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }

    .cc-afte-result {
      background: var(--bg-dark);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .cc-afte-value {
      font-size: 24px;
      font-weight: 700;
    }

    /* Phase II Factors */
    .cc-phase2-grid {
      display: grid;
      gap: 8px;
    }

    .cc-phase2-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .cc-phase2-num {
      width: 24px;
      height: 24px;
      background: var(--bg-hover);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .cc-phase2-name {
      flex: 1;
      font-size: 13px;
    }

    .cc-phase2-status {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 4px;
      background: var(--bg-hover);
      color: var(--text-muted);
    }

    .cc-phase2-status.strong {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .cc-phase2-status.weak {
      background: rgba(245, 158, 11, 0.2);
      color: var(--watch);
    }

    /* Milestone Tracker */
    .cc-milestone-table {
      width: 100%;
      border-collapse: collapse;
    }

    .cc-milestone-table th,
    .cc-milestone-table td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }

    .cc-milestone-table th {
      background: var(--bg-dark);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10px;
    }

    .cc-milestone-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }

    .cc-milestone-status.on-track {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .cc-milestone-status.at-risk {
      background: rgba(245, 158, 11, 0.2);
      color: var(--watch);
    }

    .cc-milestone-status.breach {
      background: rgba(239, 68, 68, 0.2);
      color: var(--action);
    }

    /* ===== CALCOMPETES EXTENDED STYLES ===== */

    /* Overview Section */
    .cc-overview-section {
      padding: 20px;
    }

    .cc-overview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .cc-overview-title {
      font-size: 20px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .cc-status-badge {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 12px;
      font-weight: 600;
    }

    .cc-status-badge.pending {
      background: rgba(245, 158, 11, 0.2);
      color: var(--watch);
    }

    .cc-status-badge.approved {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .cc-status-badge.active {
      background: rgba(99, 102, 241, 0.2);
      color: var(--accent);
    }

    .cc-legal-note {
      padding: 12px 16px;
      background: rgba(99, 102, 241, 0.1);
      border-left: 3px solid var(--accent);
      border-radius: 0 6px 6px 0;
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .cc-stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .cc-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .cc-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .cc-stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
    }

    /* Timeline */
    .cc-timeline-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .cc-timeline-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .cc-timeline {
      display: flex;
      justify-content: space-between;
      position: relative;
      padding: 0 10px;
    }

    .cc-timeline::before {
      content: '';
      position: absolute;
      top: 12px;
      left: 20px;
      right: 20px;
      height: 2px;
      background: var(--border);
    }

    .cc-timeline-year {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      position: relative;
      z-index: 1;
    }

    .cc-timeline-marker {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-dark);
      border: 2px solid var(--border);
    }

    .cc-timeline-marker.pending {
      border-color: var(--text-muted);
    }

    .cc-timeline-marker.complete {
      background: var(--safe);
      border-color: var(--safe);
    }

    .cc-timeline-marker.current {
      background: var(--accent);
      border-color: var(--accent);
      animation: pulse 2s infinite;
    }

    .cc-timeline-label {
      font-size: 10px;
      color: var(--text-muted);
      text-align: center;
    }

    .cc-timeline-year.maintenance .cc-timeline-marker {
      border-style: dashed;
    }

    .cc-timeline-legend {
      display: flex;
      gap: 24px;
      justify-content: center;
      margin-top: 16px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .cc-legend-dot {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .cc-legend-dot.performance {
      background: var(--accent);
    }

    .cc-legend-dot.maintenance {
      border: 2px dashed var(--text-muted);
    }

    /* Application Windows */
    .cc-windows-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .cc-windows-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .cc-windows-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .cc-window-card {
      background: var(--bg-dark);
      border-radius: 6px;
      padding: 12px;
      text-align: center;
    }

    .cc-window-dates {
      font-size: 12px;
      margin-bottom: 8px;
    }

    .cc-window-status {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 10px;
      display: inline-block;
    }

    .cc-window-status.closed {
      background: rgba(239, 68, 68, 0.2);
      color: var(--action);
    }

    .cc-window-status.upcoming {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .cc-window-status.future {
      background: rgba(99, 102, 241, 0.2);
      color: var(--accent);
    }

    /* Eligibility Section */
    .cc-eligibility-section,
    .cc-ratio-section,
    .cc-afte-section,
    .cc-phase2-section,
    .cc-milestones-section,
    .cc-calendar-section,
    .cc-evidence-section {
      padding: 20px;
    }

    .cc-section-header {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .cc-eligibility-desc {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 12px;
    }

    .cc-eligibility-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cc-option {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .cc-option:hover {
      background: var(--bg-hover);
    }

    .cc-option input[type="radio"] {
      margin-top: 2px;
    }

    .cc-option-label {
      font-size: 13px;
      font-weight: 600;
      display: block;
    }

    .cc-option-desc {
      font-size: 11px;
      color: var(--text-muted);
      display: block;
      margin-top: 2px;
    }

    .cc-eligibility-evidence {
      margin-top: 12px;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .cc-eligibility-box.red-flag {
      border-color: rgba(239, 68, 68, 0.4);
      background: rgba(239, 68, 68, 0.05);
    }

    .cc-grant-checklist {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cc-grant-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .cc-grant-result {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: 6px;
    }

    .cc-grant-type {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }

    .cc-grant-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    .cc-disqualifier-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cc-disqualifier-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .cc-disqualifier-item input:checked + span {
      color: var(--action);
      text-decoration: line-through;
    }

    .cc-disqualifier-alert {
      margin-top: 12px;
      padding: 12px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 6px;
      color: var(--action);
      font-size: 13px;
      font-weight: 600;
    }

    /* Cost-Benefit Ratio Section */
    .cc-ratio-formula-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .cc-ratio-formula {
      font-size: 14px;
      font-weight: 600;
      font-family: monospace;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .cc-ratio-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    .cc-ratio-inputs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .cc-ratio-input-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cc-ratio-result-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 24px;
      text-align: center;
    }

    .cc-ratio-result {
      margin-bottom: 20px;
    }

    .cc-ratio-value {
      font-size: 48px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .cc-ratio-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .cc-gauge-bar {
      height: 8px;
      background: var(--bg-dark);
      border-radius: 4px;
      position: relative;
      overflow: visible;
    }

    .cc-gauge-fill {
      height: 100%;
      border-radius: 4px;
      transition: all 0.5s ease;
    }

    .cc-gauge-marker {
      position: absolute;
      top: -4px;
      width: 2px;
      height: 16px;
    }

    .cc-gauge-marker.safe { background: var(--safe); }
    .cc-gauge-marker.watch { background: var(--watch); }
    .cc-gauge-marker.danger { background: var(--action); }

    .cc-gauge-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 10px;
      color: var(--text-muted);
    }

    .cc-ratio-assessment {
      margin-top: 16px;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 13px;
    }

    .cc-ratio-assessment.safe {
      color: var(--safe);
      background: rgba(16, 185, 129, 0.1);
    }

    .cc-ratio-assessment.watch {
      color: var(--watch);
      background: rgba(245, 158, 11, 0.1);
    }

    .cc-ratio-assessment.danger {
      color: var(--action);
      background: rgba(239, 68, 68, 0.1);
    }

    .cc-ratio-bypass {
      margin-top: 16px;
      padding: 12px;
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 6px;
      color: var(--safe);
      font-size: 13px;
      text-align: center;
    }

    /* AFTE Section */
    .cc-afte-formula-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .cc-afte-formulas {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 8px;
    }

    .cc-afte-formula {
      font-size: 13px;
      font-family: monospace;
    }

    .cc-afte-note {
      font-size: 12px;
      color: var(--text-muted);
    }

    .cc-afte-entry {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .cc-afte-entry-header {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .cc-afte-entry-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    .cc-afte-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cc-afte-input-group label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .cc-afte-table-wrapper {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .cc-afte-table {
      width: 100%;
      border-collapse: collapse;
    }

    .cc-afte-table th,
    .cc-afte-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .cc-afte-table th {
      background: var(--bg-dark);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .cc-afte-empty td {
      text-align: center;
      color: var(--text-muted);
      padding: 24px;
    }

    .cc-afte-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }

    .cc-afte-summary-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }

    .cc-afte-summary-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 8px;
    }

    .cc-afte-summary-value {
      font-size: 24px;
      font-weight: 700;
    }

    /* Phase II Section */
    .cc-phase2-note {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .cc-phase2-factors {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cc-phase2-factor {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .cc-phase2-factor-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .cc-phase2-factor-header:hover {
      background: var(--bg-hover);
    }

    .cc-phase2-factor-num {
      width: 28px;
      height: 28px;
      background: var(--bg-dark);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
    }

    .cc-phase2-factor-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }

    .cc-phase2-factor-status {
      padding: 4px 10px;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .cc-phase2-factor-status.not-started {
      background: var(--bg-dark);
      color: var(--text-muted);
    }

    .cc-phase2-factor-status.documented {
      background: rgba(16, 185, 129, 0.2);
      color: var(--safe);
    }

    .cc-phase2-factor-status.weak {
      background: rgba(245, 158, 11, 0.2);
      color: var(--watch);
    }

    .cc-phase2-factor-body {
      padding: 0 16px 16px;
      display: none;
    }

    .cc-phase2-factor.expanded .cc-phase2-factor-body {
      display: block;
    }

    .cc-phase2-factor-textarea {
      width: 100%;
      min-height: 80px;
      padding: 10px;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 13px;
      resize: vertical;
    }

    /* Milestones Section */
    .cc-milestones-note {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 16px;
    }

    .cc-milestone-entry {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .cc-milestone-entry-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 12px;
    }

    .cc-milestone-input-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cc-milestone-input-group label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .cc-milestone-table-wrapper {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .cc-milestone-empty td {
      text-align: center;
      color: var(--text-muted);
      padding: 24px;
    }

    .cc-recapture-warning {
      padding: 12px 16px;
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 6px;
      color: var(--action);
      font-size: 13px;
    }

    /* Calendar Section */
    .cc-calendar-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }

    .cc-calendar-year {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
    }

    .cc-calendar-year-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cc-calendar-year-type {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      background: var(--bg-dark);
      color: var(--text-muted);
    }

    .cc-calendar-year-type.performance {
      background: rgba(99, 102, 241, 0.2);
      color: var(--accent);
    }

    .cc-calendar-year-type.maintenance {
      background: rgba(245, 158, 11, 0.2);
      color: var(--watch);
    }

    .cc-calendar-tasks {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .cc-calendar-task {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .cc-calendar-task-check {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 3px;
      cursor: pointer;
    }

    .cc-calendar-task-check.complete {
      background: var(--safe);
      border-color: var(--safe);
    }

    .cc-deadlines-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
    }

    .cc-deadlines-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
    }

    .cc-deadline-item {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 16px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
    }

    .cc-deadline-item:last-child {
      border-bottom: none;
    }

    .cc-deadline-when {
      color: var(--text-muted);
      font-size: 12px;
    }

    .cc-deadline-what {
      font-weight: 500;
    }

    /* Evidence Section */
    .cc-evidence-categories {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .cc-evidence-category {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .cc-evidence-category-header {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    .cc-evidence-category-header:hover {
      background: var(--bg-hover);
    }

    .cc-evidence-count {
      margin-left: auto;
      padding: 2px 10px;
      background: var(--bg-dark);
      border-radius: 10px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .cc-evidence-category-body {
      padding: 0 16px 16px;
      display: none;
    }

    .cc-evidence-category.expanded .cc-evidence-category-body {
      display: block;
    }

    .cc-evidence-items {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .cc-evidence-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: var(--bg-dark);
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
    }

    .cc-evidence-item input:checked + span {
      color: var(--safe);
    }

    .cc-ftb-alert {
      margin-top: 20px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      overflow: hidden;
    }

    .cc-ftb-alert-header {
      padding: 12px 16px;
      background: rgba(239, 68, 68, 0.15);
      font-size: 14px;
      font-weight: 600;
      color: var(--action);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .cc-ftb-alert-body {
      padding: 12px 16px;
      font-size: 13px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <a class="nav-brand" onclick="showPage('home')">
      <div class="nav-brand-icon">N</div>
      Newton
    </a>

    <div class="nav-links">
      <a class="nav-link active" onclick="showPage('home')" data-page="home">Home</a>
      <a class="nav-link" onclick="showPage('workflows')" data-page="workflows">Workflows</a>
      <a class="nav-link" onclick="showPage('ledger')" data-page="ledger">Audit Ledger</a>
    </div>

    <div class="nav-status">
      <div class="status-indicator">
        <div class="status-dot"></div>
        <span id="systemStatus">System Active</span>
      </div>
    </div>
  </nav>

  <!-- Hero Pulse Bar -->
  <div class="pulse-bar" id="pulseBar">
    <div class="pulse-section">
      <div>
        <div class="pulse-label">Ledger Integrity</div>
        <div class="chain-visualizer" id="chainVisualizer">
          <div class="chain-block">1</div>
          <div class="chain-connector"></div>
          <div class="chain-block">2</div>
          <div class="chain-connector"></div>
          <div class="chain-block">3</div>
          <div class="chain-connector"></div>
          <div class="chain-block">4</div>
          <div class="chain-connector"></div>
          <div class="chain-block">5</div>
        </div>
        <div class="pulse-subtext" id="chainStatus">Verified: 0 rows</div>
      </div>
      <div class="economic-impact">
        <div>
          <div class="economic-value" id="economicValue">$0</div>
          <div class="economic-label">Exposure Prevented</div>
        </div>
      </div>
    </div>

    <div class="pulse-section center">
      <div class="pulse-counter">
        <div class="pulse-counter-value" id="pulseWorkflows">0</div>
        <div class="pulse-counter-label">Active Workflows</div>
      </div>
    </div>

    <div class="pulse-section right">
      <div class="pulse-alert" id="priorityAlert">
        <span class="pulse-alert-icon">&#10003;</span>
        <span class="pulse-alert-text" id="alertText">All systems operational</span>
      </div>
    </div>
  </div>

  <!-- Role Selector Bar -->
  <div class="role-bar">
    <div class="role-selector">
      <button class="role-btn active" data-role="briefing">Briefing</button>
      <button class="role-btn" data-role="exec">Exec</button>
      <button class="role-btn" data-role="compliance">Compliance</button>
      <button class="role-btn" data-role="engineer">Engineer</button>
    </div>
    <div class="role-filters">
      <select class="role-filter-select" id="timeFilter">
        <option value="24h">Last 24 Hours</option>
        <option value="7d" selected>Last 7 Days</option>
        <option value="30d">Last 30 Days</option>
      </select>
      <span class="role-identity" id="userIdentity">Actor: System</span>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main">

    <!-- HOME PAGE -->
    <div class="page active" id="page-home">
      <div class="hero">
        <h1 class="hero-title">CA Residency Audit Defense</h1>
        <p class="hero-subtitle">Pre-audit documentation platform built on the 19 Bragg factors. Hash-chained evidence trails for FTB audit readiness.</p>

        <div class="hero-stats">
          <div class="hero-stat">
            <div class="hero-stat-value" id="statEntries">0</div>
            <div class="hero-stat-label">Audit Entries</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-value" id="statWorkflows">0</div>
            <div class="hero-stat-label">Active Clients</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-value">19</div>
            <div class="hero-stat-label">Bragg Factors</div>
          </div>
        </div>
      </div>

      <!-- FEATURE MAP (BAYCOMPLY STYLE) -->
      <div class="feature-map">
        <div class="feature-map-header">
          <div class="feature-map-title">How It Works</div>
          <div class="feature-map-subtitle">Every action maps to an audit-ready evidence chain</div>
        </div>
        <div class="feature-map-table">
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128197;</span> Day Counter</div>
            <div class="feature-map-desc">Track CA presence against the 183-day statutory threshold. Auto-alerts at Safe/Caution/Warning levels.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128737;</span> Safe Harbor</div>
            <div class="feature-map-desc">546-day employment contract tracking. Monitors 45-day CA visit limit and $200K intangible income threshold per R&TC 17014(d).</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#127968;</span> Address Timeline</div>
            <div class="feature-map-desc">Document all residences with dates. Compare CA vs non-CA homes for the "closer connections" test.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128200;</span> Realization Events</div>
            <div class="feature-map-desc">RSU vests, stock sales, option exercises. Source-rule documentation for CA-apportioned income.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128193;</span> Evidence Vault</div>
            <div class="feature-map-desc">Upload documents with category tagging. Official, records, digital, third-party classifications.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128231;</span> 3rd Party Requests</div>
            <div class="feature-map-desc">Track confirmation letters from employers, banks, utilities. Status workflow: Pending  Sent  Received.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#128274;</span> Audit Trail</div>
            <div class="feature-map-desc">SHA-256 hash-chained ledger. Every entry links cryptographically. Tampering breaks the chain.</div>
          </div>
          <div class="feature-map-row">
            <div class="feature-map-feature"><span class="feature-map-icon">&#127919;</span> Confidence Protocol</div>
            <div class="feature-map-desc">Declare KNOWN_KNOWN, KNOWN_UNKNOWN, or UNKNOWN_UNKNOWN before logging. No retroactive softening.</div>
          </div>
        </div>
      </div>

      <!-- BRAGG FACTORS FRAMEWORK -->
      <div class="framework-section">
        <div class="framework-header">
          <div>
            <h2 class="framework-title">The 19 Bragg Factors</h2>
            <p class="framework-subtitle">The foundation for CA residency analysis. FTB examines these factors holistically - no single factor is determinative, but some carry more weight.</p>
          </div>
          <div class="framework-source">
            <strong>Source:</strong> Appeal of Bragg (2003)<br>
            <strong>See also:</strong> FTB RSTM 1030, 1040
          </div>
        </div>

        <div class="weight-legend">
          <div class="weight-legend-item"><div class="weight-legend-dot highest"></div> Highest Weight</div>
          <div class="weight-legend-item"><div class="weight-legend-dot moderate"></div> Moderate Weight</div>
          <div class="weight-legend-item"><div class="weight-legend-dot least"></div> Least Weight</div>
          <div class="weight-legend-item"><div class="weight-legend-dot corroborative"></div> Corroborative</div>
        </div>

        <div class="bragg-grid">
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">1</div>
              <span class="bragg-factor-name">Physical Presence</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Amount of time spent in CA vs outside. 183+ days triggers statutory presumption.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">2</div>
              <span class="bragg-factor-name">Location of Spouse/RDP</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Where your spouse or registered domestic partner resides.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">3</div>
              <span class="bragg-factor-name">Location of Minor Children</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Where minor children reside and attend school.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">4</div>
              <span class="bragg-factor-name">Principal Residence</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Comparison of CA home vs new state home (size, value, furnishing).</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number highest">5</div>
              <span class="bragg-factor-name">Employment</span>
              <span class="bragg-factor-weight highest">Highest</span>
            </div>
            <div class="bragg-factor-desc">Location of principal employment or business operations.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">6</div>
              <span class="bragg-factor-name">Business Interests</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Location of business interests and level of participation.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">7</div>
              <span class="bragg-factor-name">Real Property</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Ownership of real estate in CA vs elsewhere.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">8</div>
              <span class="bragg-factor-name">Bank Accounts</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Location of bank accounts and financial institutions used.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">9</div>
              <span class="bragg-factor-name">Investment Accounts</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">Location of brokerage and investment accounts.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number moderate">10</div>
              <span class="bragg-factor-name">Professional Licenses</span>
              <span class="bragg-factor-weight moderate">Moderate</span>
            </div>
            <div class="bragg-factor-desc">States where professional licenses are held (bar, CPA, medical, etc.).</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number least">11</div>
              <span class="bragg-factor-name">Motor Vehicle Registration</span>
              <span class="bragg-factor-weight least">Least</span>
            </div>
            <div class="bragg-factor-desc">Where vehicles are registered. Easy to change but still documented.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number least">12</div>
              <span class="bragg-factor-name">Driver's License</span>
              <span class="bragg-factor-weight least">Least</span>
            </div>
            <div class="bragg-factor-desc">State of driver's license. Formality but must be consistent.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number least">13</div>
              <span class="bragg-factor-name">Voter Registration</span>
              <span class="bragg-factor-weight least">Least</span>
            </div>
            <div class="bragg-factor-desc">Where registered to vote. Formality but signals intent.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">14</div>
              <span class="bragg-factor-name">Club Memberships</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Country clubs, gyms, social organizations. Shows community ties.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">15</div>
              <span class="bragg-factor-name">Religious Organizations</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Church, temple, mosque memberships and participation.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">16</div>
              <span class="bragg-factor-name">Professional Services</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Location of doctors, dentists, accountants, attorneys.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">17</div>
              <span class="bragg-factor-name">Mailing Address</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Where mail is received. USPS change of address documentation.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">18</div>
              <span class="bragg-factor-name">Safe Deposit Boxes</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Location of safe deposit boxes and valuables storage.</div>
          </div>
          <div class="bragg-factor">
            <div class="bragg-factor-header">
              <div class="bragg-factor-number corroborative">19</div>
              <span class="bragg-factor-name">Personal Property</span>
              <span class="bragg-factor-weight corroborative">Corroborative</span>
            </div>
            <div class="bragg-factor-desc">Location of furniture, art, valuables, and heirlooms.</div>
          </div>
        </div>
      </div>

      <!-- CTA SECTION -->
      <div class="capabilities-grid">
        <div class="capability-card" onclick="showPage('workflows')">
          <div class="capability-header">
            <div class="capability-icon">&#128203;</div>
            <span class="capability-status active">Active</span>
          </div>
          <h3 class="capability-title">Start a Workflow</h3>
          <p class="capability-description">Create a client workflow to track all 19 factors with evidence collection and hash-chained audit trail.</p>
          <div class="capability-action">
            <button class="capability-action-btn">View Workflows</button>
          </div>
        </div>
        <div class="capability-card" onclick="showPage('ledger')">
          <div class="capability-header">
            <div class="capability-icon">&#128274;</div>
            <span class="capability-status active">Active</span>
          </div>
          <h3 class="capability-title">Audit Ledger</h3>
          <p class="capability-description">View the tamper-evident log of all entries. Every action is hash-chained for integrity verification.</p>
          <div class="capability-action">
            <button class="capability-action-btn">View Ledger</button>
          </div>
        </div>
      </div>
    </div>

    <!-- WORKFLOWS PAGE -->
    <div class="page" id="page-workflows">
      <div class="section-header">
        <h1 class="section-title">Residency Workflows</h1>
        <button class="btn btn-primary" onclick="showModal('newWorkflow')">+ New Client</button>
      </div>

      <div class="workflows-grid" id="workflowsGrid">
        <div class="empty-state">
          <div class="empty-state-icon">&#128203;</div>
          <div class="empty-state-title">No workflows yet</div>
          <div class="empty-state-text">Create your first client workflow to start tracking residency changes.</div>
          <button class="btn btn-primary" onclick="showModal('newWorkflow')">+ New Client</button>
        </div>
      </div>
    </div>

    <!-- WORKFLOW DETAIL PAGE -->
    <div class="page" id="page-workflow-detail">
      <div class="workflow-header">
        <div class="workflow-header-top">
          <div>
            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">
              <a href="#" onclick="showPage('workflows')" style="color: var(--accent); text-decoration: none;">&#8592; Back to Workflows</a>
            </div>
            <h1 class="workflow-client-name" id="workflowClientName">Client Name</h1>
          </div>
          <span class="workflow-card-status active" id="workflowStatus">Active</span>
        </div>
        <div class="workflow-header-meta">
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">From</span>
            <span class="workflow-meta-value" id="workflowFrom">California</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">To</span>
            <span class="workflow-meta-value" id="workflowTo">Nevada</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Move Date</span>
            <span class="workflow-meta-value" id="workflowMoveDate">-</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Progress</span>
            <span class="workflow-meta-value" id="workflowProgress">0%</span>
          </div>
        </div>
      </div>

      <!-- WORKFLOW TABS - RESIDENCY -->
      <div class="workflow-tabs" id="workflowTabs">
        <button class="workflow-tab active" onclick="showWorkflowTab('roadmap')">Roadmap</button>
        <button class="workflow-tab" onclick="showWorkflowTab('dayCounter')">Day Counter</button>
        <button class="workflow-tab" onclick="showWorkflowTab('safeHarbor')">Safe Harbor</button>
        <button class="workflow-tab" onclick="showWorkflowTab('addresses')">Addresses</button>
        <button class="workflow-tab" onclick="showWorkflowTab('evidence')">Evidence</button>
        <button class="workflow-tab" onclick="showWorkflowTab('realization')">Realization Events</button>
        <button class="workflow-tab" onclick="showWorkflowTab('requests')">3rd Party Requests</button>
        <button class="workflow-tab" onclick="showWorkflowTab('checklist')">FTB Checklist</button>
      </div>

      <!-- WORKFLOW TABS - CALCOMPETES -->
      <div class="workflow-tabs" id="workflowTabsCalCompetes" style="display: none;">
        <button class="workflow-tab active" onclick="showWorkflowTab('ccOverview')">Overview</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccEligibility')">Eligibility</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccRatio')">Cost-Benefit</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccAfte')">AFTE</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccPhase2')">Phase II Factors</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccMilestones')">Milestones</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccCalendar')">Compliance</button>
        <button class="workflow-tab" onclick="showWorkflowTab('ccEvidence')">Evidence</button>
      </div>

      <!-- TAB: ROADMAP -->
      <div class="workflow-tab-content active" id="tab-roadmap">
        <div class="roadmap-section">
          <div class="roadmap-header">
            <div class="roadmap-title">
              <span>&#128203;</span> Residency Change Roadmap
            </div>
            <div class="roadmap-progress">
              <div class="roadmap-progress-bar">
                <div class="roadmap-progress-fill" id="roadmapProgressFill" style="width: 0%"></div>
              </div>
              <span class="roadmap-progress-text" id="roadmapProgressText">0 of 21 complete</span>
            </div>
          </div>

          <div class="roadmap-legal-note">
            <strong>Legal Framework:</strong> To change domicile, you must satisfy three requirements: (1) physical move to the new location, (2) abandonment of the old domicile, and (3) intent to remain permanently or indefinitely.
          </div>

          <!-- Trap Warnings from OTA Case Law -->
          <div class="trap-warnings-panel" id="trapWarningsPanel">
            <div class="trap-warnings-header" onclick="toggleTrapWarnings()">
              <div class="trap-warnings-title">
                <span>&#9888;</span> 5 Common Traps from OTA Case Law
              </div>
              <span class="trap-warnings-toggle">&#9660;</span>
            </div>
            <div class="trap-warnings-body">
              <div class="trap-warning-item">
                <div class="trap-warning-name">1. Transition Period Trap</div>
                <div class="trap-warning-desc">You are a CA resident until the moment you physically arrive in the new state. Being "in the process of moving" does not change your residency status. Income realized during the move is CA-taxable.</div>
                <div class="trap-warning-case">Source: Appeal of Noble, Appeal of Bracamonte</div>
                <div class="trap-warning-evidence">&#10003; Evidence needed: Physical presence logs on income realization dates, transaction timing after physical move complete</div>
              </div>
              <div class="trap-warning-item">
                <div class="trap-warning-name">2. Impermanence/Stopgap Trap</div>
                <div class="trap-warning-desc">"Trading down" from a large owned CA home to a rented apartment in the new state signals lack of intent. The "linens vs. mementos" test: moving only essentials while leaving valuables in CA defeats domicile change.</div>
                <div class="trap-warning-case">Source: Appeal of Bracamonte (OTA)</div>
                <div class="trap-warning-evidence">&#10003; Evidence needed: Moving manifest showing heirlooms/mementos moved, comparable housing in new state, immediate CA home listing</div>
              </div>
              <div class="trap-warning-item">
                <div class="trap-warning-name">3. Marital Abode Trap</div>
                <div class="trap-warning-desc">If one spouse leaves for a fixed term (even if renewable) and the other stays in the "marital abode," domicile usually remains CA. Employer-provided housing counts as "job convenience," not establishing new ties. Also applies to fiances.</div>
                <div class="trap-warning-case">Source: Appeal of Mazer, Appeal of Beckwith</div>
                <div class="trap-warning-evidence">&#10003; Evidence needed: Spousal relocation proof, personal (not employer-paid) lease in your name, independent ties in new state</div>
              </div>
              <div class="trap-warning-item">
                <div class="trap-warning-name">4. RSU Trailing Tax Trap</div>
                <div class="trap-warning-desc">CA taxes the labor performed in-state, even if RSUs vest after you leave. The income must be allocated using a formula based on CA workdays during the vesting period. Without workday records, FTB assumes all days were CA days.</div>
                <div class="trap-warning-case">Source: FTB Chief Counsel Rulings 2013-02, 2014-01</div>
                <div class="trap-warning-evidence">&#10003; Evidence needed: Detailed workday calendars (grant to vest), grant/vest date documentation, location records for each workday</div>
              </div>
              <div class="trap-warning-item">
                <div class="trap-warning-name">5. FTB Enforcement Trap</div>
                <div class="trap-warning-desc">FTB mines federal returns. Deducting CA mortgage interest triggers algorithms. FEP notices sent to old CA address become final if missed. FTB uses "mortgage multiple" to guess income and send bills.</div>
                <div class="trap-warning-case">Source: Greenberg Traurig Alert</div>
                <div class="trap-warning-evidence">&#10003; Evidence needed: FTB address change confirmation, occupational license updates to nonresident status</div>
              </div>
            </div>
          </div>

          <!-- Decision Point -->
          <div class="roadmap-decision-box">
            <div class="roadmap-decision-title">
              <span>&#9888;</span> Decision Point: Safe Harbor vs. Domicile Change
            </div>
            <div class="roadmap-decision-options">
              <div class="roadmap-decision-option" id="optionSafeHarbor" onclick="selectRoadmapPath('safeHarbor')">
                <div class="roadmap-decision-option-title">Safe Harbor (R&TC 17014(d))</div>
                <div class="roadmap-decision-option-desc">Employment contract >18 months outside CA, <$200K intangible income. Treated as nonresident even if CA domiciliary.</div>
              </div>
              <div class="roadmap-decision-option" id="optionDomicile" onclick="selectRoadmapPath('domicile')">
                <div class="roadmap-decision-option-title">Full Domicile Change</div>
                <div class="roadmap-decision-option-desc">Permanent severance from CA. Must satisfy all three legal requirements for domicile change.</div>
              </div>
            </div>
          </div>

          <div class="roadmap-phases" id="roadmapPhases">
            <!-- Phase 1: Before the Move -->
            <div class="roadmap-phase expanded" data-phase="before">
              <div class="roadmap-phase-header" onclick="toggleRoadmapPhase(this)">
                <div class="roadmap-phase-title">
                  <div class="roadmap-phase-icon before">&#128197;</div>
                  <div>
                    <div class="roadmap-phase-name">Before the Move</div>
                    <div class="roadmap-phase-timing">60-90 days prior</div>
                  </div>
                </div>
                <div class="roadmap-phase-stats">
                  <span class="roadmap-phase-count" id="phase-before-count">0/4</span>
                  <span class="roadmap-phase-toggle">&#9660;</span>
                </div>
              </div>
              <div class="roadmap-phase-body">
                <div class="roadmap-task" data-task="purchase_home">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'purchase_home')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Purchase or Lease New Home</div>
                    <div class="roadmap-task-why">Establishing a permanent abode is critical for the "closest connection" test.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> HUD-1 closing statement or signed long-term lease</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('purchase_home', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="list_ca_home">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'list_ca_home')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">List California Home for Sale/Rent</div>
                    <div class="roadmap-task-why">Proves "abandonment" of prior domicile. Retaining available CA home suggests no intent to leave.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Listing agreement or rental management contract</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('list_ca_home', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="schedule_movers">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'schedule_movers')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Schedule Movers - Include Mementos/Heirlooms</div>
                    <div class="roadmap-task-why"><strong>CRITICAL (Bracamonte):</strong> Moving only "linens, towels, dishes" while leaving "precious mementos" in CA defeats domicile change. The OTA uses the "linens vs. mementos" test.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Bill of lading with itemized inventory showing heirlooms, art, photo albums moved to new state</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('schedule_movers', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="defer_income_events">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'defer_income_events')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Defer Major Income Events Until After Move Complete</div>
                    <div class="roadmap-task-why"><strong>CRITICAL (Noble):</strong> Income realized during "transition" is CA-taxable. Stock sales, RSU vests, and bonuses should occur AFTER physical move and furniture are complete.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Transaction records showing realization dates after physical move date</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('defer_income_events', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phase 2: Move Week -->
            <div class="roadmap-phase" data-phase="move">
              <div class="roadmap-phase-header" onclick="toggleRoadmapPhase(this)">
                <div class="roadmap-phase-title">
                  <div class="roadmap-phase-icon move">&#128666;</div>
                  <div>
                    <div class="roadmap-phase-name">Move Week</div>
                    <div class="roadmap-phase-timing">At time of physical move</div>
                  </div>
                </div>
                <div class="roadmap-phase-stats">
                  <span class="roadmap-phase-count" id="phase-move-count">0/4</span>
                  <span class="roadmap-phase-toggle">&#9660;</span>
                </div>
              </div>
              <div class="roadmap-phase-body">
                <div class="roadmap-task" data-task="physical_move">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'physical_move')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Physically Enter New State</div>
                    <div class="roadmap-task-why">You cannot change domicile without physically moving. This is the legal trigger.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> One-way ticket, gas receipts, first credit card charge in new state</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('physical_move', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="move_family">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'move_family')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Move Spouse/Partner and Children</div>
                    <div class="roadmap-task-why"><strong>CRITICAL (Mazer, Beckwith):</strong> Spouse staying in "marital abode" = domicile stays CA. Extended to fiances. If partner stays behind, you likely remain a CA resident regardless of where you go.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Family travel records, partner's new state ID, children's school enrollment in new state</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('move_family', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="personal_lease">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'personal_lease')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Sign Lease/Mortgage in Your Name (Not Employer)</div>
                    <div class="roadmap-task-why"><strong>CRITICAL (Mazer):</strong> Employer-provided housing is "job convenience," not establishing domicile. Housing must be in your name, paid from personal funds.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Lease agreement or mortgage in your name, bank statements showing personal payment</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('personal_lease', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="surrender_keys">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'surrender_keys')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Surrender Keys/Access to CA Property</div>
                    <div class="roadmap-task-why">Demonstrates abandonment of CA abode. Available access suggests continued residence.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Key surrender receipt, closing escrow statement</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('surrender_keys', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phase 3: First 30 Days -->
            <div class="roadmap-phase" data-phase="after">
              <div class="roadmap-phase-header" onclick="toggleRoadmapPhase(this)">
                <div class="roadmap-phase-title">
                  <div class="roadmap-phase-icon after">&#10003;</div>
                  <div>
                    <div class="roadmap-phase-name">Immediately After</div>
                    <div class="roadmap-phase-timing">First 30 days</div>
                  </div>
                </div>
                <div class="roadmap-phase-stats">
                  <span class="roadmap-phase-count" id="phase-after-count">0/6</span>
                  <span class="roadmap-phase-toggle">&#9660;</span>
                </div>
              </div>
              <div class="roadmap-phase-body">
                <div class="roadmap-task" data-task="county_assessor">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'county_assessor')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Notify County Assessor - Remove Homeowner's Exemption</div>
                    <div class="roadmap-task-why"><strong>CRUCIAL:</strong> Failure to remove is viewed as declaration of residency. HIGHEST WEIGHT factor.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Letter to County Assessor with certified mail receipt, response letter</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('county_assessor', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="new_bank_accounts">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'new_bank_accounts')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Open Bank Accounts in New State</div>
                    <div class="roadmap-task-why">Financial independence from CA supports "closest connection" test.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Monthly bank statements showing new address</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight moderate">Moderate</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('new_bank_accounts', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="new_drivers_license">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'new_drivers_license')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Obtain New Driver's License, Surrender CA License</div>
                    <div class="roadmap-task-why">Formality factor - retaining CA license suggests intent to return.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Copy of new license, CA surrender receipt</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight least">Least</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('new_drivers_license', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="vehicle_registration">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'vehicle_registration')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Register ALL Vehicles in New State Immediately</div>
                    <div class="roadmap-task-why"><strong>WARNING (Bracamonte):</strong> Purchasing a vehicle during transition and registering it in CA (not new state) was cited as evidence against domicile change. Any new purchases must be registered in new state.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> New state vehicle registration cards for ALL vehicles including new purchases</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight moderate">Moderate</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('vehicle_registration', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="ftb_address_update">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'ftb_address_update')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Update Address with FTB</div>
                    <div class="roadmap-task-why"><strong>CRITICAL (GT Alert):</strong> FTB sends Filing Enforcement notices to last known address. Missing a notice can result in final assessment. Update address formally with confirmation.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> FTB address change confirmation letter, Form 3533 if applicable</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('ftb_address_update', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="voter_registration">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'voter_registration')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Register to Vote in New State</div>
                    <div class="roadmap-task-why">Formality factor - signals intent to be part of new community.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Voter registration card from new state</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight least">Least</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('voter_registration', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phase 4: First 12 Months -->
            <div class="roadmap-phase" data-phase="ongoing">
              <div class="roadmap-phase-header" onclick="toggleRoadmapPhase(this)">
                <div class="roadmap-phase-title">
                  <div class="roadmap-phase-icon ongoing">&#128200;</div>
                  <div>
                    <div class="roadmap-phase-name">Ongoing</div>
                    <div class="roadmap-phase-timing">First 12 months</div>
                  </div>
                </div>
                <div class="roadmap-phase-stats">
                  <span class="roadmap-phase-count" id="phase-ongoing-count">0/4</span>
                  <span class="roadmap-phase-toggle">&#9660;</span>
                </div>
              </div>
              <div class="roadmap-phase-body">
                <div class="roadmap-task" data-task="day_counting">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'day_counting')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Day Counting - Stay Under 183 CA Days</div>
                    <div class="roadmap-task-why">Physical presence is primary factor. >9 months in CA creates statutory presumption.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Contemporaneous travel log, flight records, credit card statements</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('day_counting', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="medical_ties">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'medical_ties')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Establish Medical/Professional Ties</div>
                    <div class="roadmap-task-why">Location of doctors, dentists, accountants is a standard residency factor.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> EOB statements, billing records showing service in new state</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight corroborative">Corroborative</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('medical_ties', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="social_orgs">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'social_orgs')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Join Social Organizations, Resign CA Clubs</div>
                    <div class="roadmap-task-why">Demonstrates social integration into new community and severance from CA.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> New membership agreements, CA resignation letters, dues statements</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight corroborative">Corroborative</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('social_orgs', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="religious_orgs">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'religious_orgs')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Join Religious Organizations</div>
                    <div class="roadmap-task-why">Church/temple membership shows community roots in new state.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Membership records, donation receipts</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight corroborative">Corroborative</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('religious_orgs', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>

            <!-- Phase 5: Annual Maintenance -->
            <div class="roadmap-phase" data-phase="annual">
              <div class="roadmap-phase-header" onclick="toggleRoadmapPhase(this)">
                <div class="roadmap-phase-title">
                  <div class="roadmap-phase-icon annual">&#128197;</div>
                  <div>
                    <div class="roadmap-phase-name">Annual Maintenance</div>
                    <div class="roadmap-phase-timing">Each tax year</div>
                  </div>
                </div>
                <div class="roadmap-phase-stats">
                  <span class="roadmap-phase-count" id="phase-annual-count">0/3</span>
                  <span class="roadmap-phase-toggle">&#9660;</span>
                </div>
              </div>
              <div class="roadmap-phase-body">
                <div class="roadmap-task" data-task="file_540nr">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'file_540nr')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">File Form 540NR (Nonresident Return)</div>
                    <div class="roadmap-task-why">Filing Form 540 (resident) is an admission of residency. Must file 540NR if CA-source income.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Copies of filed federal and CA state returns</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('file_540nr', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="monitor_ca_income">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'monitor_ca_income')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Monitor CA-Source Income</div>
                    <div class="roadmap-task-why">Nonresidents taxed on CA-source income. Failure to report triggers audit.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Schedule K-1s, W-2s, 1099s showing CA-source amounts</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight moderate">Moderate</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('monitor_ca_income', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
                <div class="roadmap-task" data-task="manage_ca_property">
                  <div class="roadmap-task-check" onclick="toggleRoadmapTask(this, 'manage_ca_property')"></div>
                  <div class="roadmap-task-content">
                    <div class="roadmap-task-title">Manage CA Property Usage</div>
                    <div class="roadmap-task-why">If retained, must be rented or limited vacation use. Available home suggests no change.</div>
                    <div class="roadmap-task-evidence"><strong>Evidence:</strong> Lease agreements with tenants, rental income documentation</div>
                  </div>
                  <div class="roadmap-task-weight">
                    <span class="roadmap-task-weight-badge bragg-factor-weight highest">Highest</span>
                  </div>
                  <div class="roadmap-task-status">
                    <select onchange="updateRoadmapTaskStatus('manage_ca_property', this.value)">
                      <option value="not_started">Not Started</option>
                      <option value="in_progress">In Progress</option>
                      <option value="complete">Complete</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: DAY COUNTER -->
      <div class="workflow-tab-content" id="tab-dayCounter">
        <div class="day-counter-section">
          <div class="day-counter-header">
            <div class="day-counter-title">
              <span class="day-counter-title-icon">&#128197;</span>
              CA Day Counter - 183 Day Rule
            </div>
            <button class="btn btn-secondary" onclick="exportDayEntries()">Export CSV</button>
          </div>

          <div class="day-counter-stats">
            <div class="day-stat-card">
              <div class="day-stat-value" id="dayStatCA">0</div>
              <div class="day-stat-label">Days in CA</div>
            </div>
            <div class="day-stat-card">
              <div class="day-stat-value safe" id="dayStatOther">0</div>
              <div class="day-stat-label">Days Outside CA</div>
            </div>
            <div class="day-stat-card">
              <div class="day-stat-value" id="dayStatRemaining">183</div>
              <div class="day-stat-label">Days Until Limit</div>
            </div>
            <div class="day-stat-card">
              <div class="day-stat-value" id="dayStatYear">2025</div>
              <div class="day-stat-label">Tax Year</div>
            </div>
          </div>

          <div class="day-progress-container">
            <div class="day-progress-header">
              <span class="day-progress-label">Progress to 183-Day Threshold</span>
              <span class="day-progress-value" id="dayProgressText">0 / 183 (0%)</span>
            </div>
            <div class="day-progress-bar">
              <div class="day-progress-fill safe" id="dayProgressFill" style="width: 0%"></div>
            </div>
            <div class="day-progress-markers">
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>0</span></div>
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>120 Safe</span></div>
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>150 Caution</span></div>
              <div class="day-progress-marker"><div class="day-progress-marker-line"></div><span>183 Limit</span></div>
            </div>
          </div>

          <div class="day-alert-banner safe" id="dayAlertBanner">
            <span class="day-alert-icon">&#10003;</span>
            <span id="dayAlertText">Safe Zone: You have plenty of room before approaching the 183-day threshold.</span>
          </div>

          <!-- Critical Period Analysis (Bracamonte Detector) -->
          <div class="critical-period-box" id="criticalPeriodBox">
            <div class="critical-period-title">
              <span>&#128200;</span> Critical Period Analysis
            </div>
            <div class="detector-alert" id="criticalPeriodAlert">
              <div class="detector-alert-header">
                <span>&#128308;</span> PHYSICAL PRESENCE FAIL
              </div>
              <div class="detector-alert-body" id="criticalPeriodAlertText">
                You spent more time in CA than your new state during the critical period between lease signing and income realization.
              </div>
              <div class="detector-alert-case">Bracamonte lost on this exact issue - 90 days CA vs 28 days NV.</div>
            </div>
            <div class="critical-period-grid">
              <div class="critical-period-stat">
                <div class="critical-period-value" id="criticalCADays">--</div>
                <div class="critical-period-label">CA Days (Critical Period)</div>
              </div>
              <div class="critical-period-stat">
                <div class="critical-period-value" id="criticalNewStateDays">--</div>
                <div class="critical-period-label">New State Days</div>
              </div>
              <div class="critical-period-stat">
                <div class="critical-period-value" id="criticalPeriodResult">--</div>
                <div class="critical-period-label">Result</div>
              </div>
            </div>
            <div style="font-size: 12px; color: var(--text-muted);">
              Critical period: From new state lease/purchase date to first major realization event. Add addresses and realization events to calculate.
            </div>
          </div>

          <div class="day-entry-form" id="dayEntryForm">
            <div class="day-entry-group">
              <label class="day-entry-label">Date</label>
              <input type="date" class="day-entry-input" id="dayEntryDate">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Location</label>
              <select class="day-entry-input" id="dayEntryLocation">
                <option value="CA">California</option>
                <option value="NV">Nevada</option>
                <option value="OTHER">Other State</option>
                <option value="INTL">International</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Purpose</label>
              <select class="day-entry-input" id="dayEntryPurpose">
                <option value="PERSONAL">Personal</option>
                <option value="BUSINESS">Business</option>
                <option value="MEDICAL">Medical</option>
                <option value="TRANSIT">Transit</option>
                <option value="VACATION">Vacation</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Notes</label>
              <input type="text" class="day-entry-input" id="dayEntryNotes" placeholder="Brief description...">
            </div>
            <button class="day-entry-btn" onclick="addDayEntry()">+ Add Day</button>
          </div>

          <label class="day-bulk-toggle">
            <input type="checkbox" id="bulkEntryToggle" onchange="toggleBulkEntry()">
            Enable bulk entry mode (for date ranges)
          </label>

          <div class="day-bulk-form" id="bulkEntryForm">
            <div class="day-bulk-hint">Format: YYYY-MM-DD to YYYY-MM-DD: LOCATION, PURPOSE</div>
            <textarea class="day-bulk-textarea" id="bulkEntryText" placeholder="2025-01-01 to 2025-01-15: NV, Personal"></textarea>
            <button class="day-entry-btn" onclick="processBulkEntry()">Process Bulk Entry</button>
          </div>

          <div class="day-entries-list" id="dayEntriesList">
            <div class="day-entries-header">
              <span>Date</span><span>Location</span><span>Purpose</span><span>Notes</span><span>Action</span>
            </div>
            <div id="dayEntriesBody"></div>
          </div>
        </div>
      </div>

      <!-- TAB: SAFE HARBOR -->
      <div class="workflow-tab-content" id="tab-safeHarbor">
        <div class="safe-harbor-section">
          <div class="safe-harbor-header">
            <div class="safe-harbor-title">
              <span>&#128737;</span> Safe Harbor Analysis - R&TC 17014(d)
            </div>
            <span class="safe-harbor-badge pending" id="safeHarborBadge">PENDING REVIEW</span>
          </div>

          <div class="timeline-info-box">
            <strong>Safe Harbor Eligibility:</strong> CA-domiciled individuals may be treated as nonresidents if absent under an employment contract for 546+ consecutive days, with CA visits under 45 days/year and intangible income under $200,000/year.
          </div>

          <!-- Safe Harbor Metrics -->
          <div class="safe-harbor-grid">
            <div class="safe-harbor-metric">
              <div class="safe-harbor-metric-header">
                <span class="safe-harbor-metric-label">Days Outside CA</span>
                <span class="safe-harbor-metric-status pending" id="shDaysStatus">TRACKING</span>
              </div>
              <div class="safe-harbor-metric-value" id="shDaysOutside">0</div>
              <div class="safe-harbor-metric-target">Target: 546 consecutive days</div>
              <div class="safe-harbor-progress">
                <div class="safe-harbor-progress-fill" id="shDaysProgress" style="width: 0%; background: var(--accent);"></div>
              </div>
            </div>
            <div class="safe-harbor-metric">
              <div class="safe-harbor-metric-header">
                <span class="safe-harbor-metric-label">CA Visits This Year</span>
                <span class="safe-harbor-metric-status pass" id="shVisitsStatus">PASS</span>
              </div>
              <div class="safe-harbor-metric-value" id="shCAVisits">0</div>
              <div class="safe-harbor-metric-target">Limit: 45 days per tax year</div>
              <div class="safe-harbor-progress">
                <div class="safe-harbor-progress-fill" id="shVisitsProgress" style="width: 0%; background: var(--safe);"></div>
              </div>
            </div>
            <div class="safe-harbor-metric">
              <div class="safe-harbor-metric-header">
                <span class="safe-harbor-metric-label">Intangible Income</span>
                <span class="safe-harbor-metric-status pass" id="shIncomeStatus">PASS</span>
              </div>
              <div class="safe-harbor-metric-value" id="shIntangibleIncome">$0</div>
              <div class="safe-harbor-metric-target">Limit: $200,000 per year</div>
              <div class="safe-harbor-progress">
                <div class="safe-harbor-progress-fill" id="shIncomeProgress" style="width: 0%; background: var(--safe);"></div>
              </div>
            </div>
          </div>

          <!-- Employment Contract -->
          <div class="safe-harbor-contract">
            <div class="safe-harbor-contract-header">
              <div class="safe-harbor-contract-title">Employment Contract Details</div>
              <button class="btn btn-secondary" onclick="saveSafeHarborContract()">Save Contract</button>
            </div>
            <div class="safe-harbor-form">
              <div class="day-entry-group">
                <label class="day-entry-label">Employer Name</label>
                <input type="text" class="day-entry-input" id="shEmployer" placeholder="Company name">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Contract Start Date</label>
                <input type="date" class="day-entry-input" id="shContractStart">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Contract End Date</label>
                <input type="date" class="day-entry-input" id="shContractEnd">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Work Location (Non-CA)</label>
                <input type="text" class="day-entry-input" id="shWorkLocation" placeholder="City, State/Country">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Annual Intangible Income</label>
                <input type="number" class="day-entry-input" id="shAnnualIncome" placeholder="0">
              </div>
              <div class="day-entry-group">
                <label class="day-entry-label">Contract Document</label>
                <input type="text" class="day-entry-input" id="shContractDoc" placeholder="Filename or reference">
              </div>
            </div>
          </div>

          <!-- Requirements Checklist -->
          <h4 style="margin-bottom: 12px; font-size: 14px;">Safe Harbor Requirements</h4>
          <div class="safe-harbor-requirements" id="shRequirements">
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">546 Consecutive Days</div>
                <div class="safe-harbor-requirement-desc">Must be outside CA for uninterrupted 546+ days under contract</div>
              </div>
            </div>
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">45-Day CA Limit</div>
                <div class="safe-harbor-requirement-desc">CA visits must not exceed 45 days in any covered tax year</div>
              </div>
            </div>
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">$200K Income Limit</div>
                <div class="safe-harbor-requirement-desc">Intangible income must be under $200,000 per year</div>
              </div>
            </div>
            <div class="safe-harbor-requirement">
              <div class="safe-harbor-requirement-icon pending">?</div>
              <div class="safe-harbor-requirement-text">
                <div class="safe-harbor-requirement-title">No Tax Avoidance Purpose</div>
                <div class="safe-harbor-requirement-desc">Principal purpose must not be avoiding CA income tax</div>
              </div>
            </div>
          </div>

          <!-- Contract Type Warning (Mazer Detector) -->
          <div class="contract-type-box" id="contractTypeBox">
            <div class="contract-type-title">Employment Contract Type (Mazer Detector)</div>
            <div class="detector-alert warning" id="contractTypeAlert">
              <div class="detector-alert-header">
                <span>&#9888;</span> DEFINITE END DATE
              </div>
              <div class="detector-alert-body">
                Fixed-term contracts (even if renewable) suggest temporary absence, not permanent relocation. 2-year benchmark: absence under 2 years with defined end = likely temporary.
              </div>
              <div class="detector-alert-case">Mazer rule: "May be renewable" wasn't enough to prove indefinite intent.</div>
            </div>
            <div class="contract-type-options" id="contractTypeOptions">
              <div class="contract-type-option" onclick="selectContractType('fixed')">
                <div class="contract-type-radio"></div>
                <div class="contract-type-label">Fixed term (1 year, 2 years, etc.)</div>
              </div>
              <div class="contract-type-option" onclick="selectContractType('renewable')">
                <div class="contract-type-radio"></div>
                <div class="contract-type-label">"May be renewable"</div>
              </div>
              <div class="contract-type-option" onclick="selectContractType('atwill')">
                <div class="contract-type-radio"></div>
                <div class="contract-type-label">At-will / Indefinite</div>
              </div>
              <div class="contract-type-option" onclick="selectContractType('permanent')">
                <div class="contract-type-radio"></div>
                <div class="contract-type-label">Permanent relocation</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: ADDRESSES -->
      <div class="workflow-tab-content" id="tab-addresses">
        <div class="address-section">
          <div class="day-counter-header">
            <div class="day-counter-title">
              <span>&#127968;</span> Address Timeline
            </div>
          </div>

          <div class="timeline-info-box">
            Document all residences with dates. FTB examines where you maintain your primary home and the comparison between CA and non-CA residences.
          </div>

          <!-- Housing Comparison Detector -->
          <div class="housing-comparison-box" id="housingComparisonBox">
            <div class="housing-comparison-title">Housing Comparison (Bracamonte Detector)</div>
            <div class="detector-alert warning" id="housingComparisonAlert">
              <div class="detector-alert-header">
                <span>&#9888;</span> IMPERMANENCE SIGNAL
              </div>
              <div class="detector-alert-body">
                Owned CA home vs rented new state apartment suggests stopgap housing. Purchase comparable home before liquidity event.
              </div>
              <div class="detector-alert-case">Bracamonte rule: "Trading down" from large owned home to rental = no intent to remain.</div>
            </div>
            <div class="housing-comparison-grid">
              <div class="housing-card">
                <div class="housing-card-title">CA Residence</div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Type</div>
                  <select class="housing-card-input" id="caHousingType" onchange="checkHousingComparison()">
                    <option value="">Select...</option>
                    <option value="owned">Owned</option>
                    <option value="rented">Rented</option>
                  </select>
                </div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Est. Value ($)</div>
                  <input type="number" class="housing-card-input" id="caHousingValue" placeholder="0" onchange="checkHousingComparison()">
                </div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Square Feet</div>
                  <input type="number" class="housing-card-input" id="caHousingSqft" placeholder="0" onchange="checkHousingComparison()">
                </div>
              </div>
              <div class="housing-card">
                <div class="housing-card-title">New State Residence</div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Type</div>
                  <select class="housing-card-input" id="newHousingType" onchange="checkHousingComparison()">
                    <option value="">Select...</option>
                    <option value="owned">Owned</option>
                    <option value="rented">Rented</option>
                  </select>
                </div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Est. Value ($)</div>
                  <input type="number" class="housing-card-input" id="newHousingValue" placeholder="0" onchange="checkHousingComparison()">
                </div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Square Feet</div>
                  <input type="number" class="housing-card-input" id="newHousingSqft" placeholder="0" onchange="checkHousingComparison()">
                </div>
              </div>
            </div>
          </div>

          <!-- Employer Housing Flag (Mazer Detector) -->
          <div class="housing-comparison-box" id="employerHousingBox">
            <div class="housing-comparison-title">New State Housing Ownership (Mazer Detector)</div>
            <div class="detector-alert warning" id="employerHousingAlert">
              <div class="detector-alert-header">
                <span>&#9888;</span> JOB CONVENIENCE
              </div>
              <div class="detector-alert-body">
                Employer-provided housing given little weight in establishing domicile. Sign lease in your own name, pay with personal funds.
              </div>
              <div class="detector-alert-case">Mazer rule: Employer-paid apartment = "job convenience," not putting down roots.</div>
            </div>
            <div class="housing-comparison-grid">
              <div class="housing-card">
                <div class="housing-card-title">Lease/Mortgage Details</div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Who pays rent/mortgage?</div>
                  <select class="housing-card-input" id="housingPaidBy" onchange="checkEmployerHousing()">
                    <option value="">Select...</option>
                    <option value="self">Self (Personal funds)</option>
                    <option value="employer">Employer</option>
                    <option value="other">Other</option>
                  </select>
                </div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Whose name on lease?</div>
                  <select class="housing-card-input" id="leaseNamedParty" onchange="checkEmployerHousing()">
                    <option value="">Select...</option>
                    <option value="self">Self</option>
                    <option value="employer">Employer</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
              <div class="housing-card">
                <div class="housing-card-title">Vehicle in New State</div>
                <div class="housing-card-field">
                  <div class="housing-card-label">Vehicle ownership?</div>
                  <select class="housing-card-input" id="vehicleOwnership" onchange="checkEmployerHousing()">
                    <option value="">Select...</option>
                    <option value="self">Self-owned</option>
                    <option value="employer">Employer-provided</option>
                    <option value="rental">Rental</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="address-form">
            <div class="day-entry-group">
              <label class="day-entry-label">Start Date</label>
              <input type="date" class="day-entry-input" id="addrStartDate">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">End Date</label>
              <input type="date" class="day-entry-input" id="addrEndDate" placeholder="Present">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Address</label>
              <input type="text" class="day-entry-input" id="addrStreet" placeholder="Street address">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">City, State</label>
              <input type="text" class="day-entry-input" id="addrCity" placeholder="City, ST">
            </div>
            <button class="day-entry-btn" onclick="addAddress()">+ Add Address</button>
          </div>

          <div class="address-timeline" id="addressTimeline">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No addresses recorded yet.</div>
          </div>
        </div>
      </div>

      <!-- TAB: EVIDENCE -->
      <div class="workflow-tab-content" id="tab-evidence">
        <div class="evidence-section">
          <div class="evidence-header">
            <div class="evidence-title">
              <span>&#128193;</span> Evidence Repository
            </div>
            <div class="evidence-stats">
              <div class="evidence-stat"><span class="evidence-stat-count" id="evidenceTotal">0</span> Total</div>
              <div class="evidence-stat"><span class="evidence-stat-count" id="evidenceVerified">0</span> Verified</div>
            </div>
          </div>

          <div class="evidence-categories" id="evidenceCategories">
            <div class="evidence-category active" onclick="filterEvidence('all')">
              <div class="evidence-category-icon">&#128194;</div>
              <div class="evidence-category-name">All Evidence</div>
              <div class="evidence-category-count" id="evCatAll">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('official')">
              <div class="evidence-category-icon">&#128220;</div>
              <div class="evidence-category-name">Official Documents</div>
              <div class="evidence-category-count" id="evCatOfficial">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('records')">
              <div class="evidence-category-icon">&#128203;</div>
              <div class="evidence-category-name">Records</div>
              <div class="evidence-category-count" id="evCatRecords">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('digital')">
              <div class="evidence-category-icon">&#128187;</div>
              <div class="evidence-category-name">Digital Evidence</div>
              <div class="evidence-category-count" id="evCatDigital">0 items</div>
            </div>
            <div class="evidence-category" onclick="filterEvidence('thirdparty')">
              <div class="evidence-category-icon">&#128101;</div>
              <div class="evidence-category-name">Third-Party</div>
              <div class="evidence-category-count" id="evCatThirdparty">0 items</div>
            </div>
          </div>

          <!-- Near and Dear Inventory (Bracamonte Detector) -->
          <div class="inventory-section" id="nearAndDearInventory">
            <div class="inventory-title">
              <span>&#127968;</span> "Near and Dear" Inventory (Bracamonte Detector)
            </div>
            <div class="detector-alert warning" id="nearAndDearAlert">
              <div class="detector-alert-header">
                <span>&#9888;</span> NEAR AND DEAR WARNING
              </div>
              <div class="detector-alert-body" id="nearAndDearAlertText">
                Items remaining in CA after move date suggest you haven't truly moved.
              </div>
              <div class="detector-alert-case">Bracamonte left "precious mementos and valuable items" in CA - court cited this as evidence of no domicile change.</div>
            </div>
            <div class="inventory-grid">
              <div class="inventory-item">
                <div class="inventory-item-name">Furniture - Primary residence set</div>
                <select class="inventory-item-select" id="invFurniture" onchange="checkNearAndDear()">
                  <option value="">Select...</option>
                  <option value="CA">In CA</option>
                  <option value="NEW">In New State</option>
                  <option value="TRANSIT">In Transit</option>
                </select>
              </div>
              <div class="inventory-item">
                <div class="inventory-item-name">Artwork</div>
                <select class="inventory-item-select" id="invArtwork" onchange="checkNearAndDear()">
                  <option value="">Select...</option>
                  <option value="CA">In CA</option>
                  <option value="NEW">In New State</option>
                  <option value="TRANSIT">In Transit</option>
                </select>
              </div>
              <div class="inventory-item">
                <div class="inventory-item-name">Family photos / Heirlooms</div>
                <select class="inventory-item-select" id="invHeirlooms" onchange="checkNearAndDear()">
                  <option value="">Select...</option>
                  <option value="CA">In CA</option>
                  <option value="NEW">In New State</option>
                  <option value="TRANSIT">In Transit</option>
                </select>
              </div>
              <div class="inventory-item">
                <div class="inventory-item-name">"Favorite chair" / Sentimental items</div>
                <select class="inventory-item-select" id="invSentimental" onchange="checkNearAndDear()">
                  <option value="">Select...</option>
                  <option value="CA">In CA</option>
                  <option value="NEW">In New State</option>
                  <option value="TRANSIT">In Transit</option>
                </select>
              </div>
              <div class="inventory-item">
                <div class="inventory-item-name">Important documents (originals)</div>
                <select class="inventory-item-select" id="invDocuments" onchange="checkNearAndDear()">
                  <option value="">Select...</option>
                  <option value="CA">In CA</option>
                  <option value="NEW">In New State</option>
                  <option value="TRANSIT">In Transit</option>
                </select>
              </div>
              <div class="inventory-item">
                <div class="inventory-item-name">Vehicles</div>
                <select class="inventory-item-select" id="invVehicles" onchange="checkNearAndDear()">
                  <option value="">Select...</option>
                  <option value="CA">In CA</option>
                  <option value="NEW">In New State</option>
                  <option value="TRANSIT">In Transit</option>
                </select>
              </div>
            </div>
            <div style="font-size: 11px; color: var(--text-muted); margin-top: 12px;">
              <strong>Evidence needed:</strong> Moving company bill of lading, itemized inventory list showing heirlooms/mementos moved to new state
            </div>
          </div>

          <div class="evidence-upload-zone" onclick="document.getElementById('evidenceFileInput').click()">
            <div class="evidence-upload-icon">&#128228;</div>
            <div class="evidence-upload-text">Drop files here or click to upload</div>
            <div class="evidence-upload-hint">PDF, images, or documents up to 10MB</div>
            <input type="file" id="evidenceFileInput" style="display:none" onchange="handleEvidenceUpload(event)">
          </div>

          <div class="evidence-list" id="evidenceList">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No evidence uploaded yet.</div>
          </div>
        </div>
      </div>

      <!-- TAB: REALIZATION EVENTS -->
      <div class="workflow-tab-content" id="tab-realization">
        <div class="timeline-section">
          <div class="timeline-header">
            <div class="timeline-title">
              <span>&#128200;</span> Realization Events Timeline
            </div>
            <button class="btn btn-primary" onclick="showModal('newRealization')">+ Add Event</button>
          </div>

          <div class="timeline-info-box">
            <strong>Why this matters:</strong> Stock sales, RSU vests, and other realization events may be partially sourced to CA based on where you worked during the vesting period. Document all significant events with dates and amounts.
          </div>

          <!-- RSU Allocation Formula -->
          <div class="rsu-allocation-box">
            <div class="rsu-allocation-title">
              <span>&#9888;</span> RSU "Trailing Tax" Allocation Formula
            </div>
            <div class="rsu-allocation-formula">
              CA Tax = Total Gain  (CA Workdays  Total Workdays)<br>
              <span style="color: var(--text-muted);">Period: Grant Date  Vest Date</span>
            </div>
            <div class="rsu-allocation-note">
              <strong>Critical:</strong> If RSUs are granted while a CA resident but vest after becoming a nonresident, CA still taxes the portion attributable to CA labor. Without detailed workday calendars, FTB will assume ALL workdays were CA days.
            </div>
            <div class="rsu-allocation-source">
              Source: FTB Chief Counsel Rulings 2013-02, 2014-01
            </div>
          </div>

          <!-- Transition Period Detector (Noble/Bracamonte) -->
          <div class="detector-alert warning" id="transitionPeriodAlert">
            <div class="detector-alert-header">
              <span>&#9888;</span> TRANSITION TRAP DETECTED
            </div>
            <div class="detector-alert-body" id="transitionAlertText">
              Income realized during move period. You are a CA resident until physical arrival + belongings moved. Consider delaying liquidity event or accelerating physical move.
            </div>
            <div class="detector-alert-case">Noble/Bracamonte rule: There is no "transition" status. You're CA resident until you physically arrive in new state.</div>
          </div>

          <!-- RSU Allocation Calculator -->
          <div class="rsu-calculator-box" id="rsuCalculatorBox">
            <div class="rsu-calculator-title">
              <span>&#129518;</span> RSU/Equity Allocation Calculator
            </div>
            <div class="rsu-calculator-grid">
              <div class="rsu-calc-field">
                <label class="rsu-calc-label">Grant Date</label>
                <input type="date" class="rsu-calc-input" id="rsuGrantDate" onchange="calculateRSUAllocation()">
              </div>
              <div class="rsu-calc-field">
                <label class="rsu-calc-label">Vest Date</label>
                <input type="date" class="rsu-calc-input" id="rsuVestDate" onchange="calculateRSUAllocation()">
              </div>
              <div class="rsu-calc-field">
                <label class="rsu-calc-label">Vest Value ($)</label>
                <input type="number" class="rsu-calc-input" id="rsuVestValue" placeholder="0" onchange="calculateRSUAllocation()">
              </div>
              <div class="rsu-calc-field">
                <label class="rsu-calc-label">Total Working Days (GrantVest)</label>
                <input type="number" class="rsu-calc-input" id="rsuTotalDays" placeholder="Auto or manual" onchange="calculateRSUAllocation()">
              </div>
              <div class="rsu-calc-field">
                <label class="rsu-calc-label">CA Working Days (GrantVest)</label>
                <input type="number" class="rsu-calc-input" id="rsuCADays" placeholder="Enter CA workdays" onchange="calculateRSUAllocation()">
              </div>
              <div class="rsu-calc-field">
                <label class="rsu-calc-label">Non-CA Working Days</label>
                <input type="number" class="rsu-calc-input" id="rsuNonCADays" readonly placeholder="Auto-calculated">
              </div>
            </div>
            <div class="rsu-result-box">
              <div class="rsu-result-item">
                <div class="rsu-result-value" id="rsuAllocPct">--%</div>
                <div class="rsu-result-label">CA Allocation %</div>
              </div>
              <div class="rsu-result-item">
                <div class="rsu-result-value highlight" id="rsuCATaxable">$--</div>
                <div class="rsu-result-label">CA Taxable Amount</div>
              </div>
              <div class="rsu-result-item">
                <div class="rsu-result-value" id="rsuNonCATaxable">$--</div>
                <div class="rsu-result-label">Non-CA Amount</div>
              </div>
              <div class="rsu-result-item">
                <div class="rsu-result-value" id="rsuVestTotal">$--</div>
                <div class="rsu-result-label">Total Vest Value</div>
              </div>
            </div>
            <div style="font-size: 11px; color: var(--text-muted); margin-top: 12px;">
              <strong>Evidence needed:</strong> Grant agreement with date, vest schedule, workday calendar (daily location log)
            </div>
          </div>

          <div class="timeline-form">
            <div class="day-entry-group">
              <label class="day-entry-label">Event Date</label>
              <input type="date" class="day-entry-input" id="realEventDate">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Event Type</label>
              <select class="day-entry-input" id="realEventType">
                <option value="RSU_VEST">RSU Vest</option>
                <option value="STOCK_SALE">Stock Sale</option>
                <option value="OPTION_EXERCISE">Option Exercise</option>
                <option value="BONUS">Bonus Payment</option>
                <option value="DEFERRED_COMP">Deferred Compensation</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Amount ($)</label>
              <input type="number" class="day-entry-input" id="realEventAmount" placeholder="0">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Description</label>
              <input type="text" class="day-entry-input" id="realEventDesc" placeholder="Details...">
            </div>
            <button class="day-entry-btn" onclick="addRealizationEvent()">+ Add</button>
          </div>

          <div class="timeline-events" id="realizationTimeline">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No realization events recorded.</div>
          </div>
        </div>
      </div>

      <!-- TAB: THIRD-PARTY REQUESTS -->
      <div class="workflow-tab-content" id="tab-requests">
        <div class="requests-section">
          <div class="requests-header">
            <div class="requests-title">
              <span>&#128231;</span> Third-Party Information Requests
            </div>
          </div>

          <div class="requests-info">
            <strong>Documentation Strategy:</strong> Proactively request confirmations from employers, banks, and service providers. These third-party letters carry more weight with FTB than self-reported information.
          </div>

          <div class="requests-form">
            <div class="day-entry-group">
              <label class="day-entry-label">Entity Name</label>
              <input type="text" class="day-entry-input" id="reqEntity" placeholder="Company/Organization">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Request Type</label>
              <select class="day-entry-input" id="reqType">
                <option value="EMPLOYMENT_LETTER">Employment Confirmation</option>
                <option value="BANK_STATEMENT">Bank Statement</option>
                <option value="UTILITY_RECORDS">Utility Records</option>
                <option value="MEDICAL_RECORDS">Medical Records</option>
                <option value="MEMBERSHIP">Club/Membership</option>
                <option value="OTHER">Other</option>
              </select>
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Date Sent</label>
              <input type="date" class="day-entry-input" id="reqDateSent">
            </div>
            <div class="day-entry-group">
              <label class="day-entry-label">Status</label>
              <select class="day-entry-input" id="reqStatus">
                <option value="PENDING">Pending</option>
                <option value="SENT">Sent</option>
                <option value="RECEIVED">Received</option>
                <option value="OVERDUE">Overdue</option>
              </select>
            </div>
            <button class="day-entry-btn" onclick="addRequest()">+ Add</button>
          </div>

          <div class="requests-list" id="requestsList">
            <div style="padding: 24px; text-align: center; color: var(--text-muted);">No requests tracked yet.</div>
          </div>
        </div>
      </div>

      <!-- TAB: FTB CHECKLIST -->
      <div class="workflow-tab-content" id="tab-checklist">
        <!-- Family Location Tracker (Mazer/Beckwith Detector) -->
        <div class="family-tracker-box" id="familyTrackerBox">
          <div class="family-tracker-title">
            <span>&#128106;</span> Family Location Tracker (Highest Weight Factor)
          </div>
          <div class="family-tracker-subtitle">
            Mazer rule: Spouse remaining in CA = domicile retained. Beckwith extended this to fiances.
          </div>
          <div class="detector-alert critical" id="spousalLocationAlert">
            <div class="detector-alert-header">
              <span>&#128308;</span> MARITAL ABODE RULE TRIGGERED
            </div>
            <div class="detector-alert-body">
              Spouse remaining in CA home strongly indicates CA domicile retained. This is the HIGHEST WEIGHT factor in domicile analysis.
            </div>
            <div class="detector-alert-case">Mazer lost on this exact issue. Leaving wife in CA = automatic CA residency.</div>
          </div>
          <div class="family-tracker-grid">
            <div class="family-tracker-row">
              <div class="family-tracker-label">Spouse/Partner location</div>
              <select class="inventory-item-select" id="spouseLocation" onchange="checkFamilyLocation()">
                <option value="">Select...</option>
                <option value="CA">California</option>
                <option value="NEW">New State (with you)</option>
                <option value="OTHER">Other Location</option>
                <option value="NA">N/A - No spouse/partner</option>
              </select>
            </div>
            <div class="family-tracker-row">
              <div class="family-tracker-label">Minor children location</div>
              <select class="inventory-item-select" id="childrenLocation" onchange="checkFamilyLocation()">
                <option value="">Select...</option>
                <option value="CA">California</option>
                <option value="NEW">New State (with you)</option>
                <option value="SPLIT">Split custody</option>
                <option value="NA">N/A - No minor children</option>
              </select>
            </div>
            <div class="family-tracker-row">
              <div class="family-tracker-label">Adult dependents location</div>
              <select class="inventory-item-select" id="dependentsLocation" onchange="checkFamilyLocation()">
                <option value="">Select...</option>
                <option value="CA">California</option>
                <option value="NEW">New State</option>
                <option value="NA">N/A - No adult dependents</option>
              </select>
            </div>
          </div>
        </div>

        <div id="checklistContainer">
          <!-- Checklist categories will be rendered here -->
        </div>
      </div>

      <!-- ========================================== -->
      <!-- CALCOMPETES WORKFLOW TABS                  -->
      <!-- ========================================== -->

      <!-- TAB: CC OVERVIEW -->
      <div class="workflow-tab-content" id="tab-ccOverview">
        <div class="cc-overview-section">
          <div class="cc-overview-header">
            <div class="cc-overview-title">
              <span>&#128176;</span> California Competes Tax Credit
            </div>
            <div class="cc-overview-status" id="ccOverviewStatus">
              <span class="cc-status-badge pending">Application Pending</span>
            </div>
          </div>

          <div class="cc-legal-note">
            <strong>Program Structure:</strong> GO-Biz administers, FTB reviews. 5-year performance + 3-year maintenance = 8-year lifecycle. Risk: Recapture if milestones not maintained.
          </div>

          <!-- Quick Stats Grid -->
          <div class="cc-stats-grid">
            <div class="cc-stat-card">
              <div class="cc-stat-label">Credit Requested</div>
              <div class="cc-stat-value" id="ccStatCredit">$0</div>
            </div>
            <div class="cc-stat-card">
              <div class="cc-stat-label">Cost-Benefit Ratio</div>
              <div class="cc-stat-value" id="ccStatRatio">-</div>
            </div>
            <div class="cc-stat-card">
              <div class="cc-stat-label">New FTEs Committed</div>
              <div class="cc-stat-value" id="ccStatFtes">0</div>
            </div>
            <div class="cc-stat-card">
              <div class="cc-stat-label">Investment Committed</div>
              <div class="cc-stat-value" id="ccStatInvestment">$0</div>
            </div>
          </div>

          <!-- Timeline -->
          <div class="cc-timeline-box">
            <div class="cc-timeline-title">8-Year Compliance Timeline</div>
            <div class="cc-timeline">
              <div class="cc-timeline-year" data-year="app">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Application</div>
              </div>
              <div class="cc-timeline-year" data-year="1">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Year 1</div>
              </div>
              <div class="cc-timeline-year" data-year="2">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Year 2</div>
              </div>
              <div class="cc-timeline-year" data-year="3">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Year 3</div>
              </div>
              <div class="cc-timeline-year" data-year="4">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Year 4</div>
              </div>
              <div class="cc-timeline-year" data-year="5">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Year 5</div>
              </div>
              <div class="cc-timeline-year maintenance" data-year="6">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Maint 1</div>
              </div>
              <div class="cc-timeline-year maintenance" data-year="7">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Maint 2</div>
              </div>
              <div class="cc-timeline-year maintenance" data-year="8">
                <div class="cc-timeline-marker pending"></div>
                <div class="cc-timeline-label">Maint 3</div>
              </div>
            </div>
            <div class="cc-timeline-legend">
              <span><span class="cc-legend-dot performance"></span> Performance Period (Years 1-5)</span>
              <span><span class="cc-legend-dot maintenance"></span> Maintenance Period (Years 6-8)</span>
            </div>
          </div>

          <!-- Application Windows -->
          <div class="cc-windows-box">
            <div class="cc-windows-title">FY 2025-26 Application Windows</div>
            <div class="cc-windows-grid">
              <div class="cc-window-card" data-window="july">
                <div class="cc-window-dates">July 21  Aug 11, 2025</div>
                <div class="cc-window-status closed">Closed</div>
              </div>
              <div class="cc-window-card" data-window="jan">
                <div class="cc-window-dates">Jan 5  Jan 26, 2026</div>
                <div class="cc-window-status upcoming">Upcoming</div>
              </div>
              <div class="cc-window-card" data-window="mar">
                <div class="cc-window-dates">Mar 2  Mar 16, 2026</div>
                <div class="cc-window-status future">Future</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: CC ELIGIBILITY -->
      <div class="workflow-tab-content" id="tab-ccEligibility">
        <div class="cc-eligibility-section">
          <div class="cc-section-header">
            <span>&#9989;</span> Eligibility Screener
          </div>

          <!-- But For Test -->
          <div class="cc-eligibility-box">
            <div class="cc-eligibility-title">
              <span>&#9888;</span> "But For" Test (Flight Risk)
            </div>
            <div class="cc-eligibility-desc">
              Would this project occur in another state without the credit? If YES, you can bypass the ratio competition and advance directly to Phase II.
            </div>
            <div class="cc-eligibility-options">
              <label class="cc-option">
                <input type="radio" name="butForTest" value="yes" onchange="updateButForTest(this.value)">
                <span class="cc-option-label">Yes - Flight Risk</span>
                <span class="cc-option-desc">We have competing offers from other states</span>
              </label>
              <label class="cc-option">
                <input type="radio" name="butForTest" value="no" onchange="updateButForTest(this.value)">
                <span class="cc-option-label">No - CA Only</span>
                <span class="cc-option-desc">Project will only occur in California</span>
              </label>
            </div>
            <div class="cc-eligibility-evidence" id="butForEvidence" style="display: none;">
              <label class="form-label">Evidence of Alternative Location</label>
              <textarea class="form-input form-textarea" id="butForEvidenceText" placeholder="Describe competing offers (state, incentives offered, timeline)..."></textarea>
            </div>
          </div>

          <!-- High Need Location -->
          <div class="cc-eligibility-box">
            <div class="cc-eligibility-title">
              <span>&#127919;</span> High Need Location Test
            </div>
            <div class="cc-eligibility-desc">
              75% of new FTEs work 75% of time in High Poverty or High Unemployment area. If YES, bypass ratio competition.
            </div>
            <div class="cc-eligibility-options">
              <label class="cc-option">
                <input type="radio" name="highNeedTest" value="yes" onchange="updateHighNeedTest(this.value)">
                <span class="cc-option-label">Yes - High Need Location</span>
                <span class="cc-option-desc">Meets 75%/75% threshold</span>
              </label>
              <label class="cc-option">
                <input type="radio" name="highNeedTest" value="no" onchange="updateHighNeedTest(this.value)">
                <span class="cc-option-label">No - Standard Location</span>
                <span class="cc-option-desc">Does not meet threshold</span>
              </label>
            </div>
          </div>

          <!-- Grant Thresholds -->
          <div class="cc-eligibility-box">
            <div class="cc-eligibility-title">
              <span>&#128181;</span> Grant vs. Credit
            </div>
            <div class="cc-eligibility-desc">
              Grant requires ONE of: 500 new FTEs, $10M infrastructure investment, OR High Need location.
            </div>
            <div class="cc-grant-checklist">
              <label class="cc-grant-item">
                <input type="checkbox" id="grantCheck500Jobs" onchange="updateGrantEligibility()">
                <span>500 new full-time jobs</span>
              </label>
              <label class="cc-grant-item">
                <input type="checkbox" id="grantCheck10M" onchange="updateGrantEligibility()">
                <span>$10M infrastructure investment</span>
              </label>
              <label class="cc-grant-item">
                <input type="checkbox" id="grantCheckHighNeed" onchange="updateGrantEligibility()">
                <span>Located in High Unemployment/Poverty area</span>
              </label>
            </div>
            <div class="cc-grant-result" id="grantResult">
              <span class="cc-grant-type">Credit</span>
              <span class="cc-grant-note">Grant eligibility not met</span>
            </div>
          </div>

          <!-- Disqualifiers -->
          <div class="cc-eligibility-box red-flag">
            <div class="cc-eligibility-title">
              <span>&#128683;</span> Disqualifiers (Red Flags)
            </div>
            <div class="cc-eligibility-desc">
              Any of these will sink your application or trigger recapture.
            </div>
            <div class="cc-disqualifier-list">
              <label class="cc-disqualifier-item">
                <input type="checkbox" id="dqRelatedParty" onchange="checkDisqualifiers()">
                <span>Related party transfers (parentsubsidiary)</span>
              </label>
              <label class="cc-disqualifier-item">
                <input type="checkbox" id="dqPreAppInvestment" onchange="checkDisqualifiers()">
                <span>Investment made BEFORE application deadline</span>
              </label>
              <label class="cc-disqualifier-item">
                <input type="checkbox" id="dqPartTime" onchange="checkDisqualifiers()">
                <span>Counting 2 part-time as 1 FTE (not allowed)</span>
              </label>
              <label class="cc-disqualifier-item">
                <input type="checkbox" id="dqBaseYear" onchange="checkDisqualifiers()">
                <span>Base year manipulation (understating to inflate "net increase")</span>
              </label>
              <label class="cc-disqualifier-item">
                <input type="checkbox" id="dqWageViolation" onchange="checkDisqualifiers()">
                <span>Including bonuses/benefits in "wages" calculation</span>
              </label>
              <label class="cc-disqualifier-item">
                <input type="checkbox" id="dqLitigation" onchange="checkDisqualifiers()">
                <span>Material litigation or labor/environmental violations (10 years)</span>
              </label>
            </div>
            <div class="cc-disqualifier-alert" id="disqualifierAlert" style="display: none;">
              <span>&#128308;</span> DISQUALIFIER DETECTED - Application at risk
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: CC COST-BENEFIT RATIO -->
      <div class="workflow-tab-content" id="tab-ccRatio">
        <div class="cc-ratio-section">
          <div class="cc-section-header">
            <span>&#128200;</span> Phase I: Cost-Benefit Ratio Calculator
          </div>

          <div class="cc-ratio-formula-box">
            <div class="cc-ratio-formula">
              Ratio = Credit Requested  (Aggregate Employee Compensation + Aggregate Investment)
            </div>
            <div class="cc-ratio-note">
              Lower is better. Historical cutoffs: 0.03 to 1.9. Safe zone: &lt;0.08
            </div>
          </div>

          <div class="cc-ratio-inputs">
            <div class="cc-ratio-input-group">
              <label class="form-label">Credit Requested ($)</label>
              <input type="number" class="form-input" id="ccCreditRequested" placeholder="1,000,000" onchange="calculateCostBenefitRatio()">
            </div>
            <div class="cc-ratio-input-group">
              <label class="form-label">Aggregate Employee Compensation (5-yr W-2)</label>
              <input type="number" class="form-input" id="ccAggEmployeeComp" placeholder="15,000,000" onchange="calculateCostBenefitRatio()">
              <span class="form-hint">NET NEW employees only. Excludes: bonuses, overtime, commissions, benefits, stock options</span>
            </div>
            <div class="cc-ratio-input-group">
              <label class="form-label">Aggregate Investment ($)</label>
              <input type="number" class="form-input" id="ccAggInvestment" placeholder="5,000,000" onchange="calculateCostBenefitRatio()">
              <span class="form-hint">Real + Personal property purchased AFTER application deadline</span>
            </div>
          </div>

          <div class="cc-ratio-result-box">
            <div class="cc-ratio-result">
              <div class="cc-ratio-value" id="ccRatioValue">-</div>
              <div class="cc-ratio-label">Cost-Benefit Ratio</div>
            </div>
            <div class="cc-ratio-gauge">
              <div class="cc-gauge-bar">
                <div class="cc-gauge-fill" id="ccGaugeFill" style="width: 0%"></div>
                <div class="cc-gauge-marker safe" style="left: 4%"></div>
                <div class="cc-gauge-marker watch" style="left: 40%"></div>
                <div class="cc-gauge-marker danger" style="left: 80%"></div>
              </div>
              <div class="cc-gauge-labels">
                <span>0.04 (Safe)</span>
                <span>0.80 (Risky)</span>
                <span>1.60+</span>
              </div>
            </div>
            <div class="cc-ratio-assessment" id="ccRatioAssessment">
              Enter values to calculate ratio
            </div>
          </div>

          <!-- Bypass Notice -->
          <div class="cc-ratio-bypass" id="ccRatioBypass" style="display: none;">
            <span>&#10003;</span> Phase I bypass available (Flight Risk or High Need Location)
          </div>
        </div>
      </div>

      <!-- TAB: CC AFTE -->
      <div class="workflow-tab-content" id="tab-ccAfte">
        <div class="cc-afte-section">
          <div class="cc-section-header">
            <span>&#128101;</span> AFTE Calculator (Annual Full-Time Equivalent)
          </div>

          <div class="cc-afte-formula-box">
            <div class="cc-afte-formulas">
              <div class="cc-afte-formula">
                <strong>Hourly:</strong> Total Hours  1,750 (max 1.0 per employee)
              </div>
              <div class="cc-afte-formula">
                <strong>Salaried:</strong> Total Weeks  50 (max 1.0 per employee)
              </div>
            </div>
            <div class="cc-afte-note">
              Must average 35 hours/week to count. Cannot combine 2 PT to equal 1 FT.
            </div>
          </div>

          <!-- Employee Entry Form -->
          <div class="cc-afte-entry">
            <div class="cc-afte-entry-header">Add Employee</div>
            <div class="cc-afte-entry-grid">
              <div class="cc-afte-input-group">
                <label>Employee Name/ID</label>
                <input type="text" class="form-input" id="afteEmployeeName" placeholder="John Doe">
              </div>
              <div class="cc-afte-input-group">
                <label>Type</label>
                <select class="form-input" id="afteEmployeeType" onchange="updateAfteFields()">
                  <option value="hourly">Hourly</option>
                  <option value="salaried">Salaried</option>
                </select>
              </div>
              <div class="cc-afte-input-group" id="afteHoursGroup">
                <label>Total Hours (Annual)</label>
                <input type="number" class="form-input" id="afteHours" placeholder="1750">
              </div>
              <div class="cc-afte-input-group" id="afteWeeksGroup" style="display: none;">
                <label>Total Weeks</label>
                <input type="number" class="form-input" id="afteWeeks" placeholder="50">
              </div>
              <div class="cc-afte-input-group">
                <label>Hire Date</label>
                <input type="date" class="form-input" id="afteHireDate">
              </div>
              <div class="cc-afte-input-group">
                <label>Annual W-2 Wage</label>
                <input type="number" class="form-input" id="afteWage" placeholder="75000">
              </div>
            </div>
            <button class="btn btn-primary" onclick="addAfteEmployee()">Add Employee</button>
          </div>

          <!-- Employee Table -->
          <div class="cc-afte-table-wrapper">
            <table class="cc-afte-table">
              <thead>
                <tr>
                  <th>Employee</th>
                  <th>Type</th>
                  <th>Hours/Weeks</th>
                  <th>AFTE</th>
                  <th>W-2 Wage</th>
                  <th>Hire Date</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="afteTableBody">
                <tr class="cc-afte-empty">
                  <td colspan="7">No employees added. Add employees above to calculate AFTE.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- AFTE Summary -->
          <div class="cc-afte-summary">
            <div class="cc-afte-summary-item">
              <div class="cc-afte-summary-label">Total Employees</div>
              <div class="cc-afte-summary-value" id="afteTotalEmployees">0</div>
            </div>
            <div class="cc-afte-summary-item">
              <div class="cc-afte-summary-label">Total AFTE</div>
              <div class="cc-afte-summary-value" id="afteTotalAfte">0.00</div>
            </div>
            <div class="cc-afte-summary-item">
              <div class="cc-afte-summary-label">Total Compensation</div>
              <div class="cc-afte-summary-value" id="afteTotalComp">$0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: CC PHASE II FACTORS -->
      <div class="workflow-tab-content" id="tab-ccPhase2">
        <div class="cc-phase2-section">
          <div class="cc-section-header">
            <span>&#128203;</span> Phase II: 14 Qualitative Factors
          </div>

          <div class="cc-phase2-note">
            GO-Biz evaluates applications on these 14 factors. Document your narrative for each.
          </div>

          <div class="cc-phase2-factors" id="phase2FactorsContainer">
            <!-- Rendered by JavaScript -->
          </div>
        </div>
      </div>

      <!-- TAB: CC MILESTONES -->
      <div class="workflow-tab-content" id="tab-ccMilestones">
        <div class="cc-milestones-section">
          <div class="cc-section-header">
            <span>&#127942;</span> Exhibit A: Milestone Tracker
          </div>

          <div class="cc-milestones-note">
            Track your committed milestones from the allocation agreement. Failure to meet milestones triggers recapture.
          </div>

          <!-- Add Milestone Form -->
          <div class="cc-milestone-entry">
            <div class="cc-milestone-entry-grid">
              <div class="cc-milestone-input-group">
                <label>Milestone Type</label>
                <select class="form-input" id="milestoneType">
                  <option value="jobs">Jobs (FTE)</option>
                  <option value="investment">Investment ($)</option>
                  <option value="wages">Compensation ($)</option>
                </select>
              </div>
              <div class="cc-milestone-input-group">
                <label>Target Year</label>
                <select class="form-input" id="milestoneYear">
                  <option value="1">Year 1</option>
                  <option value="2">Year 2</option>
                  <option value="3">Year 3</option>
                  <option value="4">Year 4</option>
                  <option value="5">Year 5</option>
                  <option value="6">Maintenance 1</option>
                  <option value="7">Maintenance 2</option>
                  <option value="8">Maintenance 3</option>
                </select>
              </div>
              <div class="cc-milestone-input-group">
                <label>Committed Target</label>
                <input type="number" class="form-input" id="milestoneTarget" placeholder="100">
              </div>
              <div class="cc-milestone-input-group">
                <label>Actual (to date)</label>
                <input type="number" class="form-input" id="milestoneActual" placeholder="0">
              </div>
            </div>
            <button class="btn btn-primary" onclick="addMilestone()">Add Milestone</button>
          </div>

          <!-- Milestones Table -->
          <div class="cc-milestone-table-wrapper">
            <table class="cc-milestone-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Type</th>
                  <th>Target</th>
                  <th>Actual</th>
                  <th>Status</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="milestoneTableBody">
                <tr class="cc-milestone-empty">
                  <td colspan="6">No milestones added. Add milestones from your allocation agreement.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Recapture Warning -->
          <div class="cc-recapture-warning" id="recaptureWarning" style="display: none;">
            <span>&#9888;</span> <strong>Recapture Risk:</strong> One or more milestones are behind target. Review immediately.
          </div>
        </div>
      </div>

      <!-- TAB: CC COMPLIANCE CALENDAR -->
      <div class="workflow-tab-content" id="tab-ccCalendar">
        <div class="cc-calendar-section">
          <div class="cc-section-header">
            <span>&#128197;</span> Compliance Calendar (8-Year Lifecycle)
          </div>

          <div class="cc-calendar-grid" id="ccCalendarGrid">
            <!-- Rendered by JavaScript -->
          </div>

          <!-- Upcoming Deadlines -->
          <div class="cc-deadlines-box">
            <div class="cc-deadlines-title">Key Deadlines</div>
            <div class="cc-deadline-item">
              <div class="cc-deadline-when">Within 30 days of approval</div>
              <div class="cc-deadline-what">Designate contact person</div>
            </div>
            <div class="cc-deadline-item">
              <div class="cc-deadline-when">1st day of 4th month after Tax Year End</div>
              <div class="cc-deadline-what">Annual Compliance Certification to GO-Biz</div>
            </div>
            <div class="cc-deadline-item">
              <div class="cc-deadline-when">Tax Return Filing</div>
              <div class="cc-deadline-what">Claim credit via Form FTB 3531</div>
            </div>
            <div class="cc-deadline-item">
              <div class="cc-deadline-when">Within 30 days of FTB IDR</div>
              <div class="cc-deadline-what">Respond to Information Document Request</div>
            </div>
            <div class="cc-deadline-item">
              <div class="cc-deadline-when">Years 6-8</div>
              <div class="cc-deadline-what">Maintenance certification (avoid recapture)</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB: CC EVIDENCE -->
      <div class="workflow-tab-content" id="tab-ccEvidence">
        <div class="cc-evidence-section">
          <div class="cc-section-header">
            <span>&#128193;</span> Evidence Vault (FTB Documentation)
          </div>

          <div class="cc-evidence-categories">
            <div class="cc-evidence-category">
              <div class="cc-evidence-category-header" onclick="toggleEvidenceCategory('jobs')">
                <span>&#128101;</span> Jobs Documentation
                <span class="cc-evidence-count" id="evidenceCountJobs">0</span>
              </div>
              <div class="cc-evidence-category-body" id="evidenceCategoryJobs">
                <div class="cc-evidence-items">
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="payroll_registers" onchange="updateEvidenceStatus('jobs', 'payroll_registers', this.checked)">
                    <span>Payroll registers</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="i9_forms" onchange="updateEvidenceStatus('jobs', 'i9_forms', this.checked)">
                    <span>I-9 forms</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="w2_forms" onchange="updateEvidenceStatus('jobs', 'w2_forms', this.checked)">
                    <span>W-2 forms</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="w4_forms" onchange="updateEvidenceStatus('jobs', 'w4_forms', this.checked)">
                    <span>W-4 forms</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="offer_letters" onchange="updateEvidenceStatus('jobs', 'offer_letters', this.checked)">
                    <span>Offer letters</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="pay_stubs" onchange="updateEvidenceStatus('jobs', 'pay_stubs', this.checked)">
                    <span>Pay stubs</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="afte_schedule" onchange="updateEvidenceStatus('jobs', 'afte_schedule', this.checked)">
                    <span>AFTE Schedule (hire date, term date, hours/weeks per tax year)</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="cc-evidence-category">
              <div class="cc-evidence-category-header" onclick="toggleEvidenceCategory('investment')">
                <span>&#128176;</span> Investment Documentation
                <span class="cc-evidence-count" id="evidenceCountInvestment">0</span>
              </div>
              <div class="cc-evidence-category-body" id="evidenceCategoryInvestment">
                <div class="cc-evidence-items">
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="invoices" onchange="updateEvidenceStatus('investment', 'invoices', this.checked)">
                    <span>Invoices</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="cancelled_checks" onchange="updateEvidenceStatus('investment', 'cancelled_checks', this.checked)">
                    <span>Cancelled checks</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="lease_agreements" onchange="updateEvidenceStatus('investment', 'lease_agreements', this.checked)">
                    <span>Lease agreements</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="general_ledger" onchange="updateEvidenceStatus('investment', 'general_ledger', this.checked)">
                    <span>General ledger</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="cc-evidence-category">
              <div class="cc-evidence-category-header" onclick="toggleEvidenceCategory('site')">
                <span>&#127970;</span> Site Documentation
                <span class="cc-evidence-count" id="evidenceCountSite">0</span>
              </div>
              <div class="cc-evidence-category-body" id="evidenceCategorySite">
                <div class="cc-evidence-items">
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="deed" onchange="updateEvidenceStatus('site', 'deed', this.checked)">
                    <span>Deed</span>
                  </label>
                  <label class="cc-evidence-item">
                    <input type="checkbox" data-doc="utility_bills" onchange="updateEvidenceStatus('site', 'utility_bills', this.checked)">
                    <span>Utility bills (proof of operations)</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- FTB Review Alert -->
          <div class="cc-ftb-alert" id="ftbReviewAlert" style="display: none;">
            <div class="cc-ftb-alert-header">
              <span>&#128680;</span> FTB Books & Records Review Detected
            </div>
            <div class="cc-ftb-alert-body">
              Respond to IDR within 30 days. This is contract compliance, not a tax audit.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LEDGER PAGE -->
    <div class="page" id="page-ledger">
      <h1 class="section-title">Audit Ledger</h1>

      <div class="ledger-controls">
        <div class="ledger-filters">
          <select class="filter-select" id="filterEventType">
            <option value="">All Event Types</option>
            <option value="FINDING">Finding</option>
            <option value="CHECKLIST_UPDATE">Checklist Update</option>
            <option value="WORKFLOW_CREATE">Workflow Create</option>
          </select>
          <select class="filter-select" id="filterPeriod">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
          </select>
        </div>

        <div class="ledger-search">
          <input type="text" placeholder="Search entries..." id="ledgerSearch">
          <button class="btn btn-secondary" onclick="loadLedgerData()">Search</button>
          <button class="btn btn-primary" onclick="showModal('newEntry')">+ New Entry</button>
        </div>
      </div>

      <div class="ledger-table">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Timestamp</th>
              <th>Actor</th>
              <th>Event Type</th>
              <th>Text</th>
              <th>Confidence</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="ledgerTableBody">
            <tr><td colspan="7"><div class="loading"><div class="loading-spinner"></div>Loading...</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Modal: New Entry -->
  <div class="modal-overlay" id="modal-newEntry">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">New Audit Entry</h2>
        <button class="modal-close" onclick="closeModal('newEntry')">&#10005;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">Confidence Level *</label>
          <select class="form-input" id="entryConfidence">
            <option value="">Select confidence level...</option>
            <option value="KNOWN_KNOWN">KNOWN_KNOWN - I know the fact and have evidence</option>
            <option value="KNOWN_UNKNOWN">KNOWN_UNKNOWN - I know there's a gap here</option>
            <option value="UNKNOWN_UNKNOWN">UNKNOWN_UNKNOWN - I don't know what I don't know</option>
          </select>
          <p class="form-hint">Declare confidence before the entry is logged (Rumsfeld Protocol)</p>
        </div>
        <div class="form-group">
          <label class="form-label">Event Type *</label>
          <select class="form-input" id="entryEventType">
            <option value="">Select event type...</option>
            <option value="FINDING">Finding</option>
            <option value="OBSERVATION">Observation</option>
            <option value="DECISION">Decision</option>
            <option value="ALERT">Alert</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Text *</label>
          <textarea class="form-input form-textarea" id="entryText" placeholder="Describe the finding, observation, or decision..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('newEntry')">Cancel</button>
        <button class="btn btn-primary" onclick="submitNewEntry()">Create Entry</button>
      </div>
    </div>
  </div>

  <!-- Modal: New Workflow -->
  <div class="modal-overlay" id="modal-newWorkflow">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h2 class="modal-title">New Client Workflow</h2>
        <button class="modal-close" onclick="closeModal('newWorkflow')">&#10005;</button>
      </div>
      <div class="modal-body">
        <!-- Workflow Type Selector -->
        <div class="form-group">
          <label class="form-label">Workflow Type *</label>
          <div class="workflow-type-selector">
            <div class="workflow-type-option selected" onclick="selectWorkflowType('residency')" data-type="residency">
              <div class="workflow-type-icon">&#127968;</div>
              <div class="workflow-type-info">
                <div class="workflow-type-name">Residency Change</div>
                <div class="workflow-type-desc">FTB audit defense for individuals leaving CA</div>
              </div>
            </div>
            <div class="workflow-type-option" onclick="selectWorkflowType('calcompetes')" data-type="calcompetes">
              <div class="workflow-type-icon">&#128176;</div>
              <div class="workflow-type-info">
                <div class="workflow-type-name">California Competes</div>
                <div class="workflow-type-desc">CCTC application & 8-year compliance</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Common Fields -->
        <div class="form-group">
          <label class="form-label" id="workflowNameLabel">Client Name *</label>
          <input type="text" class="form-input" id="workflowName" placeholder="Full legal name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Email</label>
            <input type="email" class="form-input" id="workflowEmail" placeholder="client@email.com">
          </div>
          <div class="form-group">
            <label class="form-label">Phone</label>
            <input type="tel" class="form-input" id="workflowPhone" placeholder="(555) 555-5555">
          </div>
        </div>

        <!-- Residency-specific fields -->
        <div id="residencyFields">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">From State *</label>
              <select class="form-input" id="workflowFromState">
                <option value="CA" selected>California</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">To State *</label>
              <select class="form-input" id="workflowToState">
                <option value="">Select state...</option>
                <option value="NV">Nevada</option>
                <option value="TX">Texas</option>
                <option value="FL">Florida</option>
                <option value="WA">Washington</option>
                <option value="TN">Tennessee</option>
                <option value="WY">Wyoming</option>
                <option value="SD">South Dakota</option>
                <option value="AK">Alaska</option>
                <option value="NH">New Hampshire</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Target Move Date</label>
            <input type="date" class="form-input" id="workflowMoveDate">
          </div>
        </div>

        <!-- CalCompetes-specific fields -->
        <div id="calcompetesFields" style="display: none;">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">FEIN *</label>
              <input type="text" class="form-input" id="workflowFEIN" placeholder="XX-XXXXXXX">
            </div>
            <div class="form-group">
              <label class="form-label">Tax Year End *</label>
              <select class="form-input" id="workflowTaxYearEnd">
                <option value="12-31">December 31 (Calendar)</option>
                <option value="03-31">March 31</option>
                <option value="06-30">June 30</option>
                <option value="09-30">September 30</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Business Structure *</label>
              <select class="form-input" id="workflowStructure">
                <option value="">Select...</option>
                <option value="C-Corp">C-Corporation</option>
                <option value="S-Corp">S-Corporation</option>
                <option value="LLC">LLC</option>
                <option value="Partnership">Partnership</option>
                <option value="Sole Prop">Sole Proprietorship</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Primary NAICS Code</label>
              <input type="text" class="form-input" id="workflowNAICS" placeholder="6-digit code">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Target Application Window</label>
            <select class="form-input" id="workflowAppWindow">
              <option value="">Select...</option>
              <option value="2025-07">July 21 - Aug 11, 2025</option>
              <option value="2026-01">Jan 5 - Jan 26, 2026</option>
              <option value="2026-03">Mar 2 - Mar 16, 2026</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('newWorkflow')">Cancel</button>
        <button class="btn btn-primary" onclick="createWorkflow()">Create Workflow</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ===== API CONFIGURATION =====
    const API_BASE = 'https://baycomply-api-827642717513.us-central1.run.app';
    const DEFAULT_TENANT = '00000000-0000-0000-0000-000000000001';
    const DEFAULT_USER = '00000000-0000-0000-0000-000000000001';

    // ===== LOCAL STATE =====
    let workflows = JSON.parse(localStorage.getItem('newton_workflows') || '[]');
    let currentWorkflowId = null;

    // ===== CHECKLIST TEMPLATE =====
    const CHECKLIST_TEMPLATE = {
      'formalities': {
        title: 'Formalities (Least Weight - But Required)',
        items: [
          { id: 'drivers_license', name: "Driver's License - Surrender CA, obtain new state" },
          { id: 'vehicle_registration', name: 'Vehicle Registration - All vehicles registered in new state' },
          { id: 'voter_registration', name: 'Voter Registration - Register in new state' },
          { id: 'usps_address', name: 'USPS Address Change - File Form 3575' },
          { id: 'professional_services', name: 'Professional Services - New doctors, dentists, accountants, attorneys' },
        ]
      },
      'property': {
        title: 'Residential Property (Highest Weight)',
        items: [
          { id: 'ca_property_status', name: 'CA Property - Listed for sale, rented, or disposed' },
          { id: 'homeowners_exemption', name: "Homeowner's Exemption - Removed from CA property" },
          { id: 'new_residence', name: 'New Residence - Purchased or leased in new state' },
          { id: 'residence_comparison', name: 'Residence Comparison - New home comparable or better' },
        ]
      },
      'physical_presence': {
        title: 'Physical Presence (Highest Weight)',
        items: [
          { id: 'move_date', name: 'Move Date - Documented date of physical move' },
          { id: 'day_count', name: 'Day Count - Less than 9 months in CA' },
          { id: 'visit_purpose', name: 'CA Visits - Purpose documented (vacation, business, medical)' },
          { id: 'visit_accommodations', name: 'CA Accommodations - Where you stay when visiting' },
        ]
      },
      'family_social': {
        title: 'Family & Social Connections (Highest Weight)',
        items: [
          { id: 'spouse_location', name: 'Spouse/Partner - Lives in new state' },
          { id: 'children_location', name: 'Minor Children - Reside and attend school in new state' },
          { id: 'clubs_resigned', name: 'CA Clubs - Resigned from country clubs, gyms, etc.' },
          { id: 'clubs_joined', name: 'New State Clubs - Joined clubs, organizations in new state' },
        ]
      },
      'business_employment': {
        title: 'Business & Employment (Highest/Moderate Weight)',
        items: [
          { id: 'employment_location', name: 'Employment - Primary work location in new state' },
          { id: 'business_interests', name: 'CA Business Interests - Level of participation documented' },
          { id: 'professional_licenses', name: 'Professional Licenses - Where licenses are held' },
          { id: 'remote_work', name: 'Remote Work - Physical location when working documented' },
        ]
      },
      'financial': {
        title: 'Financial & Income',
        items: [
          { id: 'bank_accounts', name: 'Bank Accounts - Opened in new state' },
          { id: 'stock_options', name: 'Stock Options/RSUs - CA portion documented' },
          { id: 'deferred_comp', name: 'Deferred Compensation - Timing and sourcing documented' },
        ]
      },
      'safe_harbor': {
        title: 'Safe Harbor Screening',
        items: [
          { id: 'employment_contract', name: 'Employment Contract - 546+ consecutive days outside CA' },
          { id: 'intangible_income', name: 'Intangible Income - Under $200K threshold verified' },
        ]
      }
    };

    // ===== API HELPER =====
    async function api(endpoint, options = {}) {
      try {
        const response = await fetch(API_BASE + endpoint, {
          headers: { 'Content-Type': 'application/json' },
          ...options
        });
        return await response.json();
      } catch (err) {
        console.error('API Error:', err);
        return null;
      }
    }

    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      document.querySelectorAll('.nav-link').forEach(link => {
        link.classList.remove('active');
        if (link.dataset.page === pageId) link.classList.add('active');
      });

      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');

      if (pageId === 'ledger') loadLedgerData();
      if (pageId === 'home') loadHomeStats();
      if (pageId === 'workflows') renderWorkflowsList();
    }

    function showWorkflowDetail(workflowId) {
      currentWorkflowId = workflowId;
      const workflow = workflows.find(w => w.id === workflowId);
      if (!workflow) return;

      document.getElementById('workflowClientName').textContent = workflow.name;

      // Handle workflow type differences
      const isCalCompetes = workflow.type === 'calcompetes';
      const residencyTabs = document.getElementById('workflowTabs');
      const calcompetesTabs = document.getElementById('workflowTabsCalCompetes');
      const headerMeta = document.querySelector('.workflow-header-meta');

      if (isCalCompetes) {
        // Show CalCompetes tabs, hide residency tabs
        residencyTabs.style.display = 'none';
        calcompetesTabs.style.display = 'flex';

        // Update header meta for CalCompetes
        headerMeta.innerHTML = `
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">FEIN</span>
            <span class="workflow-meta-value">${workflow.fein || '-'}</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Structure</span>
            <span class="workflow-meta-value">${workflow.structure || '-'}</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Tax Year End</span>
            <span class="workflow-meta-value">${workflow.taxYearEnd || '-'}</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Application Window</span>
            <span class="workflow-meta-value">${workflow.appWindow || '-'}</span>
          </div>
        `;

        // Reset to first CalCompetes tab
        calcompetesTabs.querySelectorAll('.workflow-tab').forEach(t => t.classList.remove('active'));
        calcompetesTabs.querySelector('.workflow-tab').classList.add('active');
        document.querySelectorAll('.workflow-tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-ccOverview').classList.add('active');

        // Load CalCompetes data
        loadCalCompetesData(workflow);
        renderPhase2Factors();
        renderComplianceCalendar();

      } else {
        // Show residency tabs, hide CalCompetes tabs
        residencyTabs.style.display = 'flex';
        calcompetesTabs.style.display = 'none';

        // Update header meta for residency
        headerMeta.innerHTML = `
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">From</span>
            <span class="workflow-meta-value" id="workflowFrom">${workflow.fromState}</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">To</span>
            <span class="workflow-meta-value" id="workflowTo">${workflow.toState}</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Move Date</span>
            <span class="workflow-meta-value" id="workflowMoveDate">${workflow.moveDate || '-'}</span>
          </div>
          <div class="workflow-meta-item">
            <span class="workflow-meta-label">Progress</span>
            <span class="workflow-meta-value" id="workflowProgress">0%</span>
          </div>
        `;

        const progress = calculateWorkflowProgress(workflow);
        document.getElementById('workflowProgress').textContent = progress + '%';

        renderChecklist(workflow);

        // Reset to first tab (Roadmap is default)
        residencyTabs.querySelectorAll('.workflow-tab').forEach(t => t.classList.remove('active'));
        residencyTabs.querySelector('.workflow-tab').classList.add('active');
        document.querySelectorAll('.workflow-tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById('tab-roadmap').classList.add('active');

        renderRoadmap();

        // Set default date to today
        document.getElementById('dayEntryDate').value = new Date().toISOString().split('T')[0];

        // Load detector data and run all checks
        loadDetectorData();
      }

      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.getElementById('page-workflow-detail').classList.add('active');
    }

    // ===== MODALS =====
    function showModal(modalId) {
      document.getElementById('modal-' + modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById('modal-' + modalId).classList.remove('active');
    }

    // ===== TOAST =====
    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast ' + type;
      toast.innerHTML = '<span>' + (type === 'success' ? '&#10003;' : '&#9888;') + '</span><span>' + message + '</span>';
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // ===== LOAD HOME STATS =====
    async function loadHomeStats() {
      const stats = await api('/api/stats');
      if (stats) {
        document.getElementById('statEntries').textContent = stats.entries.toLocaleString();
        document.getElementById('statWorkflows').textContent = workflows.length;
        document.getElementById('statCompliance').textContent = stats.compliance + '%';
      }
      document.getElementById('pulseWorkflows').textContent = workflows.length;
    }

    // ===== LOAD PULSE BAR =====
    async function loadPulseBar() {
      const chain = await api('/api/chain/integrity');
      if (chain) {
        document.getElementById('chainStatus').innerHTML =
          '<span class="pulse-value ' + (chain.verified ? 'verified' : 'broken') + '">' +
          (chain.verified ? 'VERIFIED' : 'BROKEN') + '</span> - ' + chain.rows.toLocaleString() + ' rows';
        document.getElementById('systemStatus').textContent = chain.verified ? 'Chain Verified' : 'CHAIN BROKEN';
      }
      document.getElementById('pulseWorkflows').textContent = workflows.length;
    }

    // ===== LOAD LEDGER =====
    async function loadLedgerData() {
      const tbody = document.getElementById('ledgerTableBody');
      tbody.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="loading-spinner"></div>Loading...</div></td></tr>';

      const entries = await api('/api/audit');

      if (!entries || entries.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color: var(--text-muted); padding: 40px;">No entries yet. Create your first audit entry.</td></tr>';
        return;
      }

      tbody.innerHTML = entries.map(entry => {
        const confidenceClass = (entry.confidence || 'KNOWN_KNOWN').toLowerCase().replace(/_/g, '-');
        return '<tr>' +
          '<td><span class="ledger-uuid">' + String(entry.uuid).substring(0, 8) + '</span></td>' +
          '<td>' + entry.timestamp + '</td>' +
          '<td>' + entry.actor + '</td>' +
          '<td><span class="ledger-event-type">' + entry.eventType + '</span></td>' +
          '<td>' + String(entry.text).substring(0, 50) + (String(entry.text).length > 50 ? '...' : '') + '</td>' +
          '<td><span class="ledger-confidence"><span class="confidence-dot ' + confidenceClass + '"></span>' + entry.confidence + '</span></td>' +
          '<td>' + entry.status + '</td>' +
        '</tr>';
      }).join('');
    }

    // ===== SUBMIT NEW ENTRY =====
    async function submitNewEntry() {
      const confidence = document.getElementById('entryConfidence').value;
      const eventType = document.getElementById('entryEventType').value;
      const text = document.getElementById('entryText').value;

      if (!confidence || !eventType || !text) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      const result = await api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: eventType,
          content: { message: text, confidence: confidence }
        })
      });

      if (result && !result.error) {
        closeModal('newEntry');
        showToast('Entry created with hash-chain verification', 'success');
        loadLedgerData();
        loadPulseBar();
        document.getElementById('entryConfidence').value = '';
        document.getElementById('entryEventType').value = '';
        document.getElementById('entryText').value = '';
      } else {
        showToast('Error: ' + (result?.error || 'Unknown error'), 'error');
      }
    }

    // ===== WORKFLOWS =====
    // Track selected workflow type
    let selectedWorkflowType = 'residency';

    function selectWorkflowType(type) {
      selectedWorkflowType = type;

      // Update UI
      document.querySelectorAll('.workflow-type-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      document.querySelector(`.workflow-type-option[data-type="${type}"]`).classList.add('selected');

      // Show/hide appropriate fields
      const residencyFields = document.getElementById('residencyFields');
      const calcompetesFields = document.getElementById('calcompetesFields');
      const nameLabel = document.getElementById('workflowNameLabel');

      if (type === 'residency') {
        residencyFields.style.display = 'block';
        calcompetesFields.style.display = 'none';
        nameLabel.textContent = 'Client Name *';
        document.getElementById('workflowName').placeholder = 'Full legal name';
      } else {
        residencyFields.style.display = 'none';
        calcompetesFields.style.display = 'block';
        nameLabel.textContent = 'Business Name *';
        document.getElementById('workflowName').placeholder = 'Legal business name (must match SOS records)';
      }
    }

    function createWorkflow() {
      const name = document.getElementById('workflowName').value;
      const email = document.getElementById('workflowEmail').value;
      const phone = document.getElementById('workflowPhone').value;

      if (!name) {
        showToast('Please fill in required fields', 'error');
        return;
      }

      let workflow;

      if (selectedWorkflowType === 'residency') {
        const fromState = document.getElementById('workflowFromState').value;
        const toState = document.getElementById('workflowToState').value;
        const moveDate = document.getElementById('workflowMoveDate').value;

        if (!toState) {
          showToast('Please select destination state', 'error');
          return;
        }

        workflow = {
          id: 'wf_' + Date.now(),
          type: 'residency',
          name,
          email,
          phone,
          fromState,
          toState,
          moveDate,
          createdAt: new Date().toISOString(),
          checklist: initializeChecklist()
        };
      } else {
        // CalCompetes workflow
        const fein = document.getElementById('workflowFEIN').value;
        const taxYearEnd = document.getElementById('workflowTaxYearEnd').value;
        const structure = document.getElementById('workflowStructure').value;
        const naics = document.getElementById('workflowNAICS').value;
        const appWindow = document.getElementById('workflowAppWindow').value;

        workflow = {
          id: 'wf_' + Date.now(),
          type: 'calcompetes',
          name,
          email,
          phone,
          fein,
          taxYearEnd,
          structure,
          naics,
          appWindow,
          createdAt: new Date().toISOString(),
          checklist: initializeCalCompetesChecklist(),
          eligibility: {},
          costBenefit: {},
          milestones: [],
          phase: 'application' // application, awarded, performance, maintenance
        };
      }

      workflows.push(workflow);
      saveWorkflows();

      // Log to audit ledger
      const logMessage = selectedWorkflowType === 'residency'
        ? 'Created residency workflow for ' + name + ' (' + workflow.fromState + ' to ' + workflow.toState + ')'
        : 'Created CalCompetes workflow for ' + name + ' (FEIN: ' + workflow.fein + ')';

      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'WORKFLOW_CREATE',
          content: {
            message: logMessage,
            confidence: 'KNOWN_KNOWN',
            workflowId: workflow.id,
            workflowType: selectedWorkflowType
          }
        })
      });

      closeModal('newWorkflow');
      showToast('Workflow created for ' + name, 'success');

      // Clear form
      document.getElementById('workflowName').value = '';
      document.getElementById('workflowEmail').value = '';
      document.getElementById('workflowPhone').value = '';
      document.getElementById('workflowMoveDate').value = '';
      document.getElementById('workflowToState').value = '';
      document.getElementById('workflowFEIN').value = '';
      document.getElementById('workflowNAICS').value = '';

      // Reset to residency type for next time
      selectWorkflowType('residency');

      showWorkflowDetail(workflow.id);
    }

    function initializeCalCompetesChecklist() {
      return {
        application: {
          contact_info: { status: 'not_started', notes: '' },
          business_info: { status: 'not_started', notes: '' },
          business_structure: { status: 'not_started', notes: '' },
          proposed_project: { status: 'not_started', notes: '' },
          project_locations: { status: 'not_started', notes: '' },
          employees: { status: 'not_started', notes: '' },
          investment: { status: 'not_started', notes: '' },
          ownership: { status: 'not_started', notes: '' },
          incentives: { status: 'not_started', notes: '' },
          litigation: { status: 'not_started', notes: '' },
          consultant: { status: 'not_started', notes: '' }
        },
        compliance: {
          annual_cert: { status: 'not_started', notes: '' },
          ftb_response: { status: 'not_started', notes: '' },
          maintenance: { status: 'not_started', notes: '' }
        }
      };
    }

    // ===== CALCOMPETES FUNCTIONS =====

    // Phase II 14 Factors
    const PHASE2_FACTORS = [
      { id: 1, name: 'Jobs Created/Retained', desc: 'Number of full-time jobs created or retained' },
      { id: 2, name: 'Compensation', desc: 'Wages and benefits provided to employees' },
      { id: 3, name: 'Investment', desc: 'Investment in real and personal property' },
      { id: 4, name: 'Duration of Commitment', desc: 'Length of time business commits to California' },
      { id: 5, name: 'Economic Impact', desc: 'Overall economic impact on the state' },
      { id: 6, name: 'Strategic Importance', desc: 'Strategic importance to the state economy' },
      { id: 7, name: 'Opportunity for Growth', desc: 'Potential for future business growth' },
      { id: 8, name: 'Extent of Poverty/Unemployment', desc: 'Location in high poverty/unemployment area' },
      { id: 9, name: 'In-State Incentives', desc: 'Other California incentives available' },
      { id: 10, name: 'Out-of-State Incentives', desc: 'Competing incentives from other states (flight risk)' },
      { id: 11, name: 'Training Opportunities', desc: 'Training and development programs for employees' },
      { id: 12, name: 'Benefit to State vs Business', desc: 'Relative benefit comparison' },
      { id: 13, name: 'Influence of Credit', desc: 'How much the credit influenced the decision' },
      { id: 14, name: 'Workforce Treatment & Fair Labor', desc: 'Includes relocation from discriminatory states' }
    ];

    // CalCompetes data store
    let calCompetesData = {
      eligibility: {
        butForTest: null,
        butForEvidence: '',
        highNeedTest: null,
        grantEligible: false,
        disqualifiers: []
      },
      ratio: {
        creditRequested: 0,
        aggEmployeeComp: 0,
        aggInvestment: 0,
        calculatedRatio: null
      },
      employees: [],
      milestones: [],
      phase2Factors: {},
      evidence: {
        jobs: {},
        investment: {},
        site: {}
      }
    };

    function loadCalCompetesData(workflow) {
      // Load saved data or initialize
      const saved = localStorage.getItem('cc_data_' + workflow.id);
      if (saved) {
        calCompetesData = JSON.parse(saved);
      } else {
        calCompetesData = {
          eligibility: {
            butForTest: null,
            butForEvidence: '',
            highNeedTest: null,
            grantEligible: false,
            disqualifiers: []
          },
          ratio: {
            creditRequested: 0,
            aggEmployeeComp: 0,
            aggInvestment: 0,
            calculatedRatio: null
          },
          employees: [],
          milestones: [],
          phase2Factors: {},
          evidence: {
            jobs: {},
            investment: {},
            site: {}
          }
        };
      }

      // Update UI with loaded data
      updateCalCompetesUI();
    }

    function saveCalCompetesData() {
      if (!currentWorkflowId) return;
      localStorage.setItem('cc_data_' + currentWorkflowId, JSON.stringify(calCompetesData));
    }

    function updateCalCompetesUI() {
      // Update stats
      document.getElementById('ccStatCredit').textContent = '$' + (calCompetesData.ratio.creditRequested || 0).toLocaleString();
      document.getElementById('ccStatRatio').textContent = calCompetesData.ratio.calculatedRatio ? calCompetesData.ratio.calculatedRatio.toFixed(4) : '-';

      const totalAfte = calCompetesData.employees.reduce((sum, e) => sum + (e.afte || 0), 0);
      document.getElementById('ccStatFtes').textContent = totalAfte.toFixed(2);
      document.getElementById('ccStatInvestment').textContent = '$' + (calCompetesData.ratio.aggInvestment || 0).toLocaleString();

      // Update ratio inputs if present
      const creditInput = document.getElementById('ccCreditRequested');
      if (creditInput && calCompetesData.ratio.creditRequested) {
        creditInput.value = calCompetesData.ratio.creditRequested;
      }
      const compInput = document.getElementById('ccAggEmployeeComp');
      if (compInput && calCompetesData.ratio.aggEmployeeComp) {
        compInput.value = calCompetesData.ratio.aggEmployeeComp;
      }
      const invInput = document.getElementById('ccAggInvestment');
      if (invInput && calCompetesData.ratio.aggInvestment) {
        invInput.value = calCompetesData.ratio.aggInvestment;
      }

      // Update eligibility
      if (calCompetesData.eligibility.butForTest) {
        document.querySelector(`input[name="butForTest"][value="${calCompetesData.eligibility.butForTest}"]`).checked = true;
        if (calCompetesData.eligibility.butForTest === 'yes') {
          document.getElementById('butForEvidence').style.display = 'block';
        }
      }
      if (calCompetesData.eligibility.highNeedTest) {
        document.querySelector(`input[name="highNeedTest"][value="${calCompetesData.eligibility.highNeedTest}"]`).checked = true;
      }

      // Update bypass notice
      updateBypassNotice();

      // Render employee table
      renderAfteTable();

      // Render milestones
      renderMilestonesTable();
    }

    function updateButForTest(value) {
      calCompetesData.eligibility.butForTest = value;
      document.getElementById('butForEvidence').style.display = value === 'yes' ? 'block' : 'none';
      updateBypassNotice();
      saveCalCompetesData();
    }

    function updateHighNeedTest(value) {
      calCompetesData.eligibility.highNeedTest = value;
      updateBypassNotice();
      saveCalCompetesData();
    }

    function updateBypassNotice() {
      const bypass = document.getElementById('ccRatioBypass');
      if (calCompetesData.eligibility.butForTest === 'yes' || calCompetesData.eligibility.highNeedTest === 'yes') {
        bypass.style.display = 'block';
      } else {
        bypass.style.display = 'none';
      }
    }

    function updateGrantEligibility() {
      const check500 = document.getElementById('grantCheck500Jobs').checked;
      const check10M = document.getElementById('grantCheck10M').checked;
      const checkHighNeed = document.getElementById('grantCheckHighNeed').checked;

      calCompetesData.eligibility.grantEligible = check500 || check10M || checkHighNeed;

      const result = document.getElementById('grantResult');
      if (calCompetesData.eligibility.grantEligible) {
        result.innerHTML = '<span class="cc-grant-type" style="color: var(--safe)">Grant</span><span class="cc-grant-note">Grant eligibility met!</span>';
      } else {
        result.innerHTML = '<span class="cc-grant-type">Credit</span><span class="cc-grant-note">Grant eligibility not met</span>';
      }

      saveCalCompetesData();
    }

    function checkDisqualifiers() {
      const dqChecks = [
        'dqRelatedParty', 'dqPreAppInvestment', 'dqPartTime',
        'dqBaseYear', 'dqWageViolation', 'dqLitigation'
      ];

      calCompetesData.eligibility.disqualifiers = dqChecks.filter(id => document.getElementById(id).checked);

      const alert = document.getElementById('disqualifierAlert');
      if (calCompetesData.eligibility.disqualifiers.length > 0) {
        alert.style.display = 'block';
      } else {
        alert.style.display = 'none';
      }

      saveCalCompetesData();
    }

    function calculateCostBenefitRatio() {
      const credit = parseFloat(document.getElementById('ccCreditRequested').value) || 0;
      const comp = parseFloat(document.getElementById('ccAggEmployeeComp').value) || 0;
      const investment = parseFloat(document.getElementById('ccAggInvestment').value) || 0;

      calCompetesData.ratio.creditRequested = credit;
      calCompetesData.ratio.aggEmployeeComp = comp;
      calCompetesData.ratio.aggInvestment = investment;

      const denominator = comp + investment;
      if (denominator === 0 || credit === 0) {
        document.getElementById('ccRatioValue').textContent = '-';
        document.getElementById('ccRatioAssessment').textContent = 'Enter values to calculate ratio';
        document.getElementById('ccRatioAssessment').className = 'cc-ratio-assessment';
        document.getElementById('ccGaugeFill').style.width = '0%';
        calCompetesData.ratio.calculatedRatio = null;
        saveCalCompetesData();
        return;
      }

      const ratio = credit / denominator;
      calCompetesData.ratio.calculatedRatio = ratio;

      document.getElementById('ccRatioValue').textContent = ratio.toFixed(4);
      document.getElementById('ccStatRatio').textContent = ratio.toFixed(4);
      document.getElementById('ccStatCredit').textContent = '$' + credit.toLocaleString();
      document.getElementById('ccStatInvestment').textContent = '$' + investment.toLocaleString();

      // Gauge fill (scale: 0 = 0%, 2.0 = 100%)
      const fillPercent = Math.min(ratio / 2.0 * 100, 100);
      const gauge = document.getElementById('ccGaugeFill');
      gauge.style.width = fillPercent + '%';

      const assessment = document.getElementById('ccRatioAssessment');
      if (ratio < 0.08) {
        gauge.style.background = 'var(--safe)';
        assessment.textContent = 'SAFE ZONE: Ratio below 0.08 is highly competitive';
        assessment.className = 'cc-ratio-assessment safe';
      } else if (ratio < 0.5) {
        gauge.style.background = 'var(--safe)';
        assessment.textContent = 'GOOD: Ratio is competitive but monitor closely';
        assessment.className = 'cc-ratio-assessment safe';
      } else if (ratio < 1.0) {
        gauge.style.background = 'var(--watch)';
        assessment.textContent = 'MODERATE RISK: Ratio may not pass Phase I cutoff';
        assessment.className = 'cc-ratio-assessment watch';
      } else {
        gauge.style.background = 'var(--action)';
        assessment.textContent = 'HIGH RISK: Ratio exceeds typical cutoffs. Consider bypass options.';
        assessment.className = 'cc-ratio-assessment danger';
      }

      saveCalCompetesData();
    }

    // AFTE Functions
    function updateAfteFields() {
      const type = document.getElementById('afteEmployeeType').value;
      document.getElementById('afteHoursGroup').style.display = type === 'hourly' ? 'block' : 'none';
      document.getElementById('afteWeeksGroup').style.display = type === 'salaried' ? 'block' : 'none';
    }

    function addAfteEmployee() {
      const name = document.getElementById('afteEmployeeName').value;
      const type = document.getElementById('afteEmployeeType').value;
      const hours = parseFloat(document.getElementById('afteHours').value) || 0;
      const weeks = parseFloat(document.getElementById('afteWeeks').value) || 0;
      const hireDate = document.getElementById('afteHireDate').value;
      const wage = parseFloat(document.getElementById('afteWage').value) || 0;

      if (!name) {
        showToast('Please enter employee name', 'error');
        return;
      }

      let afte;
      let hoursOrWeeks;
      if (type === 'hourly') {
        afte = Math.min(hours / 1750, 1.0);
        hoursOrWeeks = hours + ' hrs';
      } else {
        afte = Math.min(weeks / 50, 1.0);
        hoursOrWeeks = weeks + ' wks';
      }

      calCompetesData.employees.push({
        id: Date.now().toString(),
        name,
        type,
        hoursOrWeeks,
        afte,
        wage,
        hireDate
      });

      // Clear form
      document.getElementById('afteEmployeeName').value = '';
      document.getElementById('afteHours').value = '';
      document.getElementById('afteWeeks').value = '';
      document.getElementById('afteHireDate').value = '';
      document.getElementById('afteWage').value = '';

      renderAfteTable();
      updateAfteSummary();
      saveCalCompetesData();
      showToast('Employee added');
    }

    function removeAfteEmployee(id) {
      calCompetesData.employees = calCompetesData.employees.filter(e => e.id !== id);
      renderAfteTable();
      updateAfteSummary();
      saveCalCompetesData();
    }

    function renderAfteTable() {
      const tbody = document.getElementById('afteTableBody');
      if (calCompetesData.employees.length === 0) {
        tbody.innerHTML = '<tr class="cc-afte-empty"><td colspan="7">No employees added. Add employees above to calculate AFTE.</td></tr>';
        return;
      }

      tbody.innerHTML = calCompetesData.employees.map(e => `
        <tr>
          <td>${e.name}</td>
          <td>${e.type}</td>
          <td>${e.hoursOrWeeks}</td>
          <td>${e.afte.toFixed(2)}</td>
          <td>$${e.wage.toLocaleString()}</td>
          <td>${e.hireDate || '-'}</td>
          <td><button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="removeAfteEmployee('${e.id}')">Remove</button></td>
        </tr>
      `).join('');
    }

    function updateAfteSummary() {
      const total = calCompetesData.employees.length;
      const totalAfte = calCompetesData.employees.reduce((sum, e) => sum + e.afte, 0);
      const totalComp = calCompetesData.employees.reduce((sum, e) => sum + e.wage, 0);

      document.getElementById('afteTotalEmployees').textContent = total;
      document.getElementById('afteTotalAfte').textContent = totalAfte.toFixed(2);
      document.getElementById('afteTotalComp').textContent = '$' + totalComp.toLocaleString();
      document.getElementById('ccStatFtes').textContent = totalAfte.toFixed(2);
    }

    // Phase II Factors
    function renderPhase2Factors() {
      const container = document.getElementById('phase2FactorsContainer');
      container.innerHTML = PHASE2_FACTORS.map(f => {
        const saved = calCompetesData.phase2Factors[f.id] || { status: 'not-started', narrative: '' };
        return `
          <div class="cc-phase2-factor" id="phase2Factor${f.id}">
            <div class="cc-phase2-factor-header" onclick="togglePhase2Factor(${f.id})">
              <div class="cc-phase2-factor-num">${f.id}</div>
              <div class="cc-phase2-factor-name">${f.name}</div>
              <span class="cc-phase2-factor-status ${saved.status}">${saved.status === 'documented' ? 'Documented' : saved.status === 'weak' ? 'Weak' : 'Not Started'}</span>
            </div>
            <div class="cc-phase2-factor-body">
              <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">${f.desc}</p>
              <textarea class="cc-phase2-factor-textarea" placeholder="Document your narrative for this factor..."
                onchange="updatePhase2Factor(${f.id}, this.value)">${saved.narrative || ''}</textarea>
              <div style="margin-top: 8px; display: flex; gap: 8px;">
                <button class="btn btn-secondary" style="font-size: 11px;" onclick="setPhase2Status(${f.id}, 'weak')">Mark Weak</button>
                <button class="btn btn-primary" style="font-size: 11px;" onclick="setPhase2Status(${f.id}, 'documented')">Mark Documented</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function togglePhase2Factor(id) {
      const factor = document.getElementById('phase2Factor' + id);
      factor.classList.toggle('expanded');
    }

    function updatePhase2Factor(id, narrative) {
      if (!calCompetesData.phase2Factors[id]) {
        calCompetesData.phase2Factors[id] = { status: 'not-started', narrative: '' };
      }
      calCompetesData.phase2Factors[id].narrative = narrative;
      saveCalCompetesData();
    }

    function setPhase2Status(id, status) {
      if (!calCompetesData.phase2Factors[id]) {
        calCompetesData.phase2Factors[id] = { status: 'not-started', narrative: '' };
      }
      calCompetesData.phase2Factors[id].status = status;

      const statusEl = document.querySelector(`#phase2Factor${id} .cc-phase2-factor-status`);
      statusEl.className = 'cc-phase2-factor-status ' + status;
      statusEl.textContent = status === 'documented' ? 'Documented' : status === 'weak' ? 'Weak' : 'Not Started';

      saveCalCompetesData();
      showToast('Factor status updated');
    }

    // Milestones
    function addMilestone() {
      const type = document.getElementById('milestoneType').value;
      const year = document.getElementById('milestoneYear').value;
      const target = parseFloat(document.getElementById('milestoneTarget').value) || 0;
      const actual = parseFloat(document.getElementById('milestoneActual').value) || 0;

      if (!target) {
        showToast('Please enter a target value', 'error');
        return;
      }

      calCompetesData.milestones.push({
        id: Date.now().toString(),
        type,
        year,
        target,
        actual
      });

      document.getElementById('milestoneTarget').value = '';
      document.getElementById('milestoneActual').value = '';

      renderMilestonesTable();
      saveCalCompetesData();
      showToast('Milestone added');
    }

    function removeMilestone(id) {
      calCompetesData.milestones = calCompetesData.milestones.filter(m => m.id !== id);
      renderMilestonesTable();
      saveCalCompetesData();
    }

    function updateMilestoneActual(id, value) {
      const milestone = calCompetesData.milestones.find(m => m.id === id);
      if (milestone) {
        milestone.actual = parseFloat(value) || 0;
        renderMilestonesTable();
        saveCalCompetesData();
      }
    }

    function renderMilestonesTable() {
      const tbody = document.getElementById('milestoneTableBody');
      if (calCompetesData.milestones.length === 0) {
        tbody.innerHTML = '<tr class="cc-milestone-empty"><td colspan="6">No milestones added. Add milestones from your allocation agreement.</td></tr>';
        document.getElementById('recaptureWarning').style.display = 'none';
        return;
      }

      let hasRisk = false;
      tbody.innerHTML = calCompetesData.milestones.map(m => {
        const percent = m.target > 0 ? (m.actual / m.target * 100) : 0;
        let status, statusClass;
        if (percent >= 100) {
          status = 'On Track';
          statusClass = 'on-track';
        } else if (percent >= 75) {
          status = 'At Risk';
          statusClass = 'at-risk';
          hasRisk = true;
        } else {
          status = 'Breach Risk';
          statusClass = 'breach';
          hasRisk = true;
        }

        const typeLabel = m.type === 'jobs' ? 'FTEs' : m.type === 'investment' ? 'Investment' : 'Compensation';
        const yearLabel = parseInt(m.year) <= 5 ? 'Year ' + m.year : 'Maint ' + (parseInt(m.year) - 5);
        const prefix = m.type === 'jobs' ? '' : '$';

        return `
          <tr>
            <td>${yearLabel}</td>
            <td>${typeLabel}</td>
            <td>${prefix}${m.target.toLocaleString()}</td>
            <td>
              <input type="number" value="${m.actual}" style="width: 100px; padding: 4px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 4px; color: var(--text-primary);"
                onchange="updateMilestoneActual('${m.id}', this.value)">
            </td>
            <td><span class="cc-milestone-status ${statusClass}">${status}</span></td>
            <td><button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px;" onclick="removeMilestone('${m.id}')">Remove</button></td>
          </tr>
        `;
      }).join('');

      document.getElementById('recaptureWarning').style.display = hasRisk ? 'block' : 'none';
    }

    // Compliance Calendar
    function renderComplianceCalendar() {
      const container = document.getElementById('ccCalendarGrid');
      const years = [
        { num: 1, type: 'performance', tasks: ['Annual Certification', 'FTB 3531 Filing', 'Employment Records'] },
        { num: 2, type: 'performance', tasks: ['Annual Certification', 'FTB 3531 Filing', 'Employment Records'] },
        { num: 3, type: 'performance', tasks: ['Annual Certification', 'FTB 3531 Filing', 'Employment Records'] },
        { num: 4, type: 'performance', tasks: ['Annual Certification', 'FTB 3531 Filing', 'Employment Records'] },
        { num: 5, type: 'performance', tasks: ['Annual Certification', 'FTB 3531 Filing', 'Final Performance Review'] },
        { num: 6, type: 'maintenance', tasks: ['Maintenance Certification', 'Employment Verification'] },
        { num: 7, type: 'maintenance', tasks: ['Maintenance Certification', 'Employment Verification'] },
        { num: 8, type: 'maintenance', tasks: ['Maintenance Certification', 'Final Closeout'] }
      ];

      container.innerHTML = years.map(y => `
        <div class="cc-calendar-year">
          <div class="cc-calendar-year-title">
            Year ${y.num}
            <span class="cc-calendar-year-type ${y.type}">${y.type === 'performance' ? 'Performance' : 'Maintenance'}</span>
          </div>
          <div class="cc-calendar-tasks">
            ${y.tasks.map(t => `
              <div class="cc-calendar-task">
                <div class="cc-calendar-task-check" onclick="this.classList.toggle('complete')"></div>
                <span>${t}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    }

    // Evidence tracking
    function toggleEvidenceCategory(category) {
      const cat = document.getElementById('evidenceCategory' + category.charAt(0).toUpperCase() + category.slice(1));
      cat.parentElement.classList.toggle('expanded');
    }

    function updateEvidenceStatus(category, doc, checked) {
      if (!calCompetesData.evidence[category]) {
        calCompetesData.evidence[category] = {};
      }
      calCompetesData.evidence[category][doc] = checked;

      // Update count
      const count = Object.values(calCompetesData.evidence[category]).filter(v => v).length;
      document.getElementById('evidenceCount' + category.charAt(0).toUpperCase() + category.slice(1)).textContent = count;

      saveCalCompetesData();
    }

    function initializeChecklist() {
      const checklist = {};
      for (const [categoryId, category] of Object.entries(CHECKLIST_TEMPLATE)) {
        checklist[categoryId] = {};
        for (const item of category.items) {
          checklist[categoryId][item.id] = {
            status: 'not_started',
            confidence: '',
            notes: '',
            evidence: null,
            updatedAt: null
          };
        }
      }
      return checklist;
    }

    function saveWorkflows() {
      localStorage.setItem('newton_workflows', JSON.stringify(workflows));
    }

    function renderWorkflowsList() {
      const grid = document.getElementById('workflowsGrid');

      if (workflows.length === 0) {
        grid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">&#128203;</div>
            <div class="empty-state-title">No workflows yet</div>
            <div class="empty-state-text">Create your first client workflow to start tracking compliance.</div>
            <button class="btn btn-primary" onclick="showModal('newWorkflow')">+ New Client</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = workflows.map(w => {
        const progress = calculateWorkflowProgress(w);
        const isCalCompetes = w.type === 'calcompetes';

        // Different meta display for different workflow types
        let metaHtml;
        let typeIcon;
        if (isCalCompetes) {
          metaHtml = `FEIN: ${w.fein || '-'} | ${w.appWindow || 'No window'}`;
          typeIcon = '&#128176;'; // Money bag
        } else {
          metaHtml = `${w.fromState} &#8594; ${w.toState} ${w.moveDate ? '| ' + w.moveDate : ''}`;
          typeIcon = '&#127968;'; // House
        }

        return `
          <div class="workflow-card" onclick="showWorkflowDetail('${w.id}')">
            <div class="workflow-card-header">
              <div class="workflow-card-title">
                <span style="margin-right: 6px;">${typeIcon}</span>${w.name}
              </div>
              <span class="workflow-card-status ${progress === 100 ? 'active' : 'pending'}">${progress === 100 ? 'Complete' : 'In Progress'}</span>
            </div>
            <div class="workflow-card-meta">${metaHtml}</div>
            <div class="workflow-card-type" style="font-size: 10px; color: var(--text-muted); margin-bottom: 8px;">
              ${isCalCompetes ? 'California Competes Tax Credit' : 'Residency Change'}
            </div>
            <div class="workflow-card-progress">
              <div class="workflow-card-progress-bar" style="width: ${progress}%"></div>
            </div>
            <div class="workflow-card-stats">
              <span>${progress}% complete</span>
              <span>Created ${new Date(w.createdAt).toLocaleDateString()}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function calculateWorkflowProgress(workflow) {
      let total = 0;
      let completed = 0;
      for (const category of Object.values(workflow.checklist)) {
        for (const item of Object.values(category)) {
          total++;
          if (item.status === 'complete' || item.status === 'na') completed++;
        }
      }
      return total > 0 ? Math.round((completed / total) * 100) : 0;
    }

    function renderChecklist(workflow) {
      const container = document.getElementById('checklistContainer');
      container.innerHTML = '';

      for (const [categoryId, category] of Object.entries(CHECKLIST_TEMPLATE)) {
        const categoryData = workflow.checklist[categoryId] || {};
        const completedCount = Object.values(categoryData).filter(i => i.status === 'complete' || i.status === 'na').length;

        const categoryHtml = `
          <div class="checklist-category">
            <div class="checklist-category-header">
              <div class="checklist-category-title">${category.title}</div>
              <div class="checklist-category-count">${completedCount}/${category.items.length}</div>
            </div>
            <div class="checklist-category-body">
              ${category.items.map(item => {
                const itemData = categoryData[item.id] || { status: 'not_started', confidence: '' };
                return `
                  <div class="checklist-item">
                    <div class="checklist-item-name">${item.name}</div>
                    <div class="checklist-item-status">
                      <select class="checklist-select" onchange="updateChecklistItem('${workflow.id}', '${categoryId}', '${item.id}', 'status', this.value)">
                        <option value="not_started" ${itemData.status === 'not_started' ? 'selected' : ''}>Not Started</option>
                        <option value="in_progress" ${itemData.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                        <option value="complete" ${itemData.status === 'complete' ? 'selected' : ''}>Complete</option>
                        <option value="na" ${itemData.status === 'na' ? 'selected' : ''}>N/A</option>
                      </select>
                    </div>
                    <div class="checklist-item-confidence tooltip-container">
                      <select class="checklist-select" onchange="updateChecklistItem('${workflow.id}', '${categoryId}', '${item.id}', 'confidence', this.value)">
                        <option value="" ${!itemData.confidence ? 'selected' : ''}>Select confidence...</option>
                        <option value="KNOWN_KNOWN" ${itemData.confidence === 'KNOWN_KNOWN' ? 'selected' : ''}>KNOWN_KNOWN</option>
                        <option value="KNOWN_UNKNOWN" ${itemData.confidence === 'KNOWN_UNKNOWN' ? 'selected' : ''}>KNOWN_UNKNOWN</option>
                        <option value="UNKNOWN_UNKNOWN" ${itemData.confidence === 'UNKNOWN_UNKNOWN' ? 'selected' : ''}>UNKNOWN_UNKNOWN</option>
                      </select>
                      <div class="tooltip">
                        KNOWN_KNOWN: I have evidence<br>
                        KNOWN_UNKNOWN: I know there's a gap<br>
                        UNKNOWN_UNKNOWN: I don't know what I don't know
                      </div>
                    </div>
                    <div class="checklist-item-actions">
                      <button class="checklist-btn" onclick="uploadEvidence('${workflow.id}', '${categoryId}', '${item.id}')">&#128206; Upload</button>
                      <button class="checklist-btn primary" onclick="logChecklistItem('${workflow.id}', '${categoryId}', '${item.id}')">&#10003; Log</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
        container.innerHTML += categoryHtml;
      }
    }

    function updateChecklistItem(workflowId, categoryId, itemId, field, value) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (!workflow) return;

      if (!workflow.checklist[categoryId]) workflow.checklist[categoryId] = {};
      if (!workflow.checklist[categoryId][itemId]) {
        workflow.checklist[categoryId][itemId] = { status: 'not_started', confidence: '', notes: '' };
      }

      workflow.checklist[categoryId][itemId][field] = value;
      workflow.checklist[categoryId][itemId].updatedAt = new Date().toISOString();
      saveWorkflows();

      // Update progress display
      const progress = calculateWorkflowProgress(workflow);
      document.getElementById('workflowProgress').textContent = progress + '%';
    }

    async function logChecklistItem(workflowId, categoryId, itemId) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (!workflow) return;

      const itemData = workflow.checklist[categoryId]?.[itemId];
      const itemTemplate = CHECKLIST_TEMPLATE[categoryId]?.items.find(i => i.id === itemId);

      if (!itemData?.confidence) {
        showToast('Please select a confidence level first', 'error');
        return;
      }

      const result = await api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'CHECKLIST_UPDATE',
          content: {
            message: workflow.name + ' | ' + itemTemplate.name + ' | Status: ' + itemData.status,
            confidence: itemData.confidence,
            workflowId: workflowId,
            categoryId: categoryId,
            itemId: itemId
          }
        })
      });

      if (result && !result.error) {
        showToast('Logged to audit ledger with hash verification', 'success');
      } else {
        showToast('Error logging to ledger', 'error');
      }
    }

    function uploadEvidence(workflowId, categoryId, itemId) {
      // For now, just show a toast - file upload requires backend storage
      showToast('Evidence upload coming soon - for now, note the file in comments', 'warning');
    }

    // ===== DAY COUNTER =====
    function getDayEntries(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.dayEntries || [];
    }

    function saveDayEntries(workflowId, entries) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (workflow) {
        workflow.dayEntries = entries;
        saveWorkflows();
      }
    }

    function addDayEntry() {
      if (!currentWorkflowId) return;

      const date = document.getElementById('dayEntryDate').value;
      const location = document.getElementById('dayEntryLocation').value;
      const purpose = document.getElementById('dayEntryPurpose').value;
      const notes = document.getElementById('dayEntryNotes').value;

      if (!date) {
        showToast('Please select a date', 'error');
        return;
      }

      const entries = getDayEntries(currentWorkflowId);

      // Check for duplicate date
      if (entries.find(e => e.date === date)) {
        showToast('Entry for this date already exists', 'error');
        return;
      }

      const entry = {
        id: 'day_' + Date.now(),
        date,
        location,
        purpose,
        notes,
        createdAt: new Date().toISOString()
      };

      entries.push(entry);
      entries.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort newest first
      saveDayEntries(currentWorkflowId, entries);

      // Log to audit ledger
      logDayEntry(entry);

      // Update UI
      renderDayCounter();

      // Re-run detectors
      calculateCriticalPeriod();

      // Clear form
      document.getElementById('dayEntryDate').value = '';
      document.getElementById('dayEntryNotes').value = '';

      showToast('Day logged: ' + date + ' in ' + location, 'success');
    }

    async function logDayEntry(entry) {
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      await api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'DAY_ENTRY',
          content: {
            message: workflow.name + ' | Day logged: ' + entry.date + ' in ' + entry.location + ' (' + entry.purpose + ')',
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            dayEntry: entry
          }
        })
      });
    }

    function deleteDayEntry(entryId) {
      if (!currentWorkflowId) return;

      let entries = getDayEntries(currentWorkflowId);
      const entry = entries.find(e => e.id === entryId);
      entries = entries.filter(e => e.id !== entryId);
      saveDayEntries(currentWorkflowId, entries);

      // Log deletion to audit ledger
      if (entry) {
        api('/api/audit', {
          method: 'POST',
          body: JSON.stringify({
            tenantId: DEFAULT_TENANT,
            userId: DEFAULT_USER,
            entryType: 'DAY_ENTRY_DELETE',
            content: {
              message: 'Day entry deleted: ' + entry.date + ' in ' + entry.location,
              confidence: 'KNOWN_KNOWN',
              workflowId: currentWorkflowId,
              deletedEntry: entry
            }
          })
        });
      }

      renderDayCounter();
      showToast('Day entry deleted', 'success');
    }

    function toggleBulkEntry() {
      const checkbox = document.getElementById('bulkEntryToggle');
      const form = document.getElementById('bulkEntryForm');
      const singleForm = document.getElementById('dayEntryForm');

      if (checkbox.checked) {
        form.classList.add('active');
        singleForm.style.display = 'none';
      } else {
        form.classList.remove('active');
        singleForm.style.display = 'grid';
      }
    }

    function processBulkEntry() {
      if (!currentWorkflowId) return;

      const text = document.getElementById('bulkEntryText').value.trim();
      if (!text) {
        showToast('Please enter some date ranges', 'error');
        return;
      }

      const lines = text.split('\n');
      let addedCount = 0;
      let entries = getDayEntries(currentWorkflowId);

      for (const line of lines) {
        // Parse: YYYY-MM-DD to YYYY-MM-DD: LOCATION, PURPOSE
        const match = line.match(/(\d{4}-\d{2}-\d{2})\s*to\s*(\d{4}-\d{2}-\d{2}):\s*(\w+),?\s*(\w+)?/i);
        if (!match) continue;

        const startDate = new Date(match[1]);
        const endDate = new Date(match[2]);
        const location = match[3].toUpperCase();
        const purpose = (match[4] || 'PERSONAL').toUpperCase();

        // Generate entries for each day in range
        let current = new Date(startDate);
        while (current <= endDate) {
          const dateStr = current.toISOString().split('T')[0];

          // Skip if already exists
          if (!entries.find(e => e.date === dateStr)) {
            entries.push({
              id: 'day_' + Date.now() + '_' + addedCount,
              date: dateStr,
              location: location === 'NV' ? 'NV' : location === 'CA' ? 'CA' : location === 'INTL' ? 'INTL' : 'OTHER',
              purpose: ['PERSONAL', 'BUSINESS', 'MEDICAL', 'TRANSIT', 'VACATION'].includes(purpose) ? purpose : 'PERSONAL',
              notes: 'Bulk entry',
              createdAt: new Date().toISOString()
            });
            addedCount++;
          }
          current.setDate(current.getDate() + 1);
        }
      }

      if (addedCount > 0) {
        entries.sort((a, b) => new Date(b.date) - new Date(a.date));
        saveDayEntries(currentWorkflowId, entries);

        // Log bulk entry to audit ledger
        api('/api/audit', {
          method: 'POST',
          body: JSON.stringify({
            tenantId: DEFAULT_TENANT,
            userId: DEFAULT_USER,
            entryType: 'DAY_ENTRY_BULK',
            content: {
              message: 'Bulk day entry: ' + addedCount + ' days added',
              confidence: 'KNOWN_KNOWN',
              workflowId: currentWorkflowId,
              count: addedCount
            }
          })
        });

        renderDayCounter();
        document.getElementById('bulkEntryText').value = '';
        showToast(addedCount + ' days added via bulk entry', 'success');
      } else {
        showToast('No new days added (may be duplicates)', 'warning');
      }
    }

    function calculateDayStats(entries) {
      const currentYear = new Date().getFullYear();
      const yearEntries = entries.filter(e => new Date(e.date).getFullYear() === currentYear);

      const caDays = yearEntries.filter(e => e.location === 'CA').length;
      const otherDays = yearEntries.filter(e => e.location !== 'CA').length;
      const remaining = Math.max(0, 183 - caDays);

      let status = 'safe';
      if (caDays >= 183) {
        status = 'danger';
      } else if (caDays >= 151) {
        status = 'warning';
      } else if (caDays >= 121) {
        status = 'caution';
      }

      return { caDays, otherDays, remaining, status, year: currentYear };
    }

    function getAlertMessage(status, caDays, remaining) {
      switch (status) {
        case 'safe':
          return { icon: '&#10003;', text: 'Safe Zone: You have ' + remaining + ' days remaining before approaching the 183-day threshold.' };
        case 'caution':
          return { icon: '&#9888;', text: 'Caution: You have ' + remaining + ' days remaining. Start limiting CA visits.' };
        case 'warning':
          return { icon: '&#9888;', text: 'Warning: Only ' + remaining + ' days remaining! Strongly limit CA presence.' };
        case 'danger':
          return { icon: '&#10060;', text: 'PRESUMED CA RESIDENT: You have exceeded 183 days in California this year. Consult tax advisor immediately.' };
        default:
          return { icon: '&#10003;', text: 'No data yet. Start logging your days.' };
      }
    }

    function renderDayCounter() {
      if (!currentWorkflowId) return;

      const entries = getDayEntries(currentWorkflowId);
      const stats = calculateDayStats(entries);
      const alert = getAlertMessage(stats.status, stats.caDays, stats.remaining);

      // Update stats
      const caStatEl = document.getElementById('dayStatCA');
      caStatEl.textContent = stats.caDays;
      caStatEl.className = 'day-stat-value ' + stats.status;

      document.getElementById('dayStatOther').textContent = stats.otherDays;
      document.getElementById('dayStatRemaining').textContent = stats.remaining;
      document.getElementById('dayStatYear').textContent = stats.year;

      // Update progress bar
      const percentage = Math.min(100, Math.round((stats.caDays / 183) * 100));
      const progressFill = document.getElementById('dayProgressFill');
      progressFill.style.width = percentage + '%';
      progressFill.className = 'day-progress-fill ' + stats.status;
      progressFill.textContent = percentage > 10 ? percentage + '%' : '';
      document.getElementById('dayProgressText').textContent = stats.caDays + ' / 183 (' + percentage + '%)';

      // Update alert banner
      const banner = document.getElementById('dayAlertBanner');
      banner.className = 'day-alert-banner ' + stats.status;
      document.getElementById('dayAlertText').textContent = alert.text;
      banner.querySelector('.day-alert-icon').innerHTML = alert.icon;

      // Render entries list
      const tbody = document.getElementById('dayEntriesBody');
      if (entries.length === 0) {
        tbody.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No days logged yet. Add your first entry above.</div>';
      } else {
        tbody.innerHTML = entries.map(e => {
          const isCA = e.location === 'CA';
          return '<div class="day-entry-row">' +
            '<span>' + e.date + '</span>' +
            '<span class="day-entry-location ' + (isCA ? 'ca' : 'other') + '">' + e.location + '</span>' +
            '<span>' + e.purpose + '</span>' +
            '<span style="color: var(--text-muted);">' + (e.notes || '-') + '</span>' +
            '<button class="day-entry-delete" onclick="deleteDayEntry(\'' + e.id + '\')">&times;</button>' +
          '</div>';
        }).join('');
      }

      // Update the physical presence checklist item if exists
      updatePhysicalPresenceFactor(stats);
    }

    function updatePhysicalPresenceFactor(stats) {
      // Auto-update the day_count checklist item based on day counter stats
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow || !workflow.checklist.physical_presence) return;

      const dayCountItem = workflow.checklist.physical_presence.day_count;
      if (dayCountItem) {
        if (stats.caDays <= 183) {
          dayCountItem.status = 'complete';
          dayCountItem.confidence = 'KNOWN_KNOWN';
        } else {
          dayCountItem.status = 'in_progress';
          dayCountItem.confidence = 'KNOWN_UNKNOWN';
        }
        dayCountItem.notes = 'Auto-tracked: ' + stats.caDays + ' CA days in ' + stats.year;
        dayCountItem.updatedAt = new Date().toISOString();
        saveWorkflows();
      }
    }

    function exportDayEntries() {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const entries = getDayEntries(currentWorkflowId);

      if (entries.length === 0) {
        showToast('No entries to export', 'warning');
        return;
      }

      // Create CSV content
      const headers = ['Date', 'Location', 'Purpose', 'Notes', 'Created At'];
      const rows = entries.map(e => [e.date, e.location, e.purpose, e.notes || '', e.createdAt]);
      const csv = [headers.join(','), ...rows.map(r => r.map(v => '"' + v + '"').join(','))].join('\n');

      // Download
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = workflow.name.replace(/\s+/g, '_') + '_day_entries_' + new Date().toISOString().split('T')[0] + '.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast('Exported ' + entries.length + ' entries to CSV', 'success');
    }

    // ===== WORKFLOW TABS =====
    function showWorkflowTab(tabId) {
      // Update tab buttons
      document.querySelectorAll('.workflow-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.workflow-tab[onclick="showWorkflowTab('${tabId}')"]`).classList.add('active');

      // Update tab content
      document.querySelectorAll('.workflow-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('tab-' + tabId).classList.add('active');

      // Render content for the tab
      if (tabId === 'roadmap') renderRoadmap();
      if (tabId === 'dayCounter') renderDayCounter();
      if (tabId === 'safeHarbor') renderSafeHarbor();
      if (tabId === 'addresses') renderAddresses();
      if (tabId === 'evidence') renderEvidence();
      if (tabId === 'realization') renderRealizationEvents();
      if (tabId === 'requests') renderRequests();
      if (tabId === 'checklist') {
        const workflow = workflows.find(w => w.id === currentWorkflowId);
        if (workflow) renderChecklist(workflow);
      }
    }

    // ===== ROADMAP =====
    const ROADMAP_TASKS = {
      before: ['purchase_home', 'list_ca_home', 'schedule_movers', 'defer_income_events'],
      move: ['physical_move', 'move_family', 'personal_lease', 'surrender_keys'],
      after: ['county_assessor', 'new_bank_accounts', 'new_drivers_license', 'vehicle_registration', 'ftb_address_update', 'voter_registration'],
      ongoing: ['day_counting', 'medical_ties', 'social_orgs', 'religious_orgs'],
      annual: ['file_540nr', 'monitor_ca_income', 'manage_ca_property']
    };

    function getRoadmapData(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.roadmap || { tasks: {}, path: null };
    }

    function saveRoadmapData(workflowId, roadmap) {
      const workflow = workflows.find(w => w.id === workflowId);
      if (workflow) {
        workflow.roadmap = roadmap;
        saveWorkflows();
      }
    }

    function selectRoadmapPath(path) {
      if (!currentWorkflowId) return;

      const roadmap = getRoadmapData(currentWorkflowId);
      roadmap.path = path;
      saveRoadmapData(currentWorkflowId, roadmap);

      // Update UI
      document.getElementById('optionSafeHarbor').classList.toggle('selected', path === 'safeHarbor');
      document.getElementById('optionDomicile').classList.toggle('selected', path === 'domicile');

      // Log to audit ledger
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'ROADMAP_PATH',
          content: {
            message: workflow.name + ' | Selected path: ' + (path === 'safeHarbor' ? 'Safe Harbor' : 'Full Domicile Change'),
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            path
          }
        })
      });

      showToast('Path selected: ' + (path === 'safeHarbor' ? 'Safe Harbor' : 'Full Domicile Change'), 'success');
    }

    function toggleRoadmapPhase(header) {
      const phase = header.closest('.roadmap-phase');
      phase.classList.toggle('expanded');
    }

    function toggleTrapWarnings() {
      const panel = document.getElementById('trapWarningsPanel');
      panel.classList.toggle('expanded');
    }

    // ===== DETECTOR FUNCTIONS =====

    // 1. Transition Period Detector (Noble/Bracamonte)
    function checkTransitionPeriod() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      const addresses = workflow.addresses || [];
      const realEvents = workflow.realizationEvents || [];

      // Find earliest non-CA address (new state lease/move date)
      const newStateAddr = addresses.find(a => !a.city?.toUpperCase().includes('CA') && a.startDate);
      if (!newStateAddr) return;

      const moveDate = new Date(newStateAddr.startDate);
      const thirtyDaysAfter = new Date(moveDate);
      thirtyDaysAfter.setDate(thirtyDaysAfter.getDate() + 30);

      // Check if any realization event falls within 30 days of move
      const trapEvents = realEvents.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate >= moveDate && eventDate <= thirtyDaysAfter;
      });

      const alertEl = document.getElementById('transitionPeriodAlert');
      const alertTextEl = document.getElementById('transitionAlertText');

      if (trapEvents.length > 0) {
        alertEl.classList.add('active');
        const eventTypes = trapEvents.map(e => e.type).join(', ');
        alertTextEl.textContent = `${trapEvents.length} income event(s) (${eventTypes}) realized within 30 days of move date. You are a CA resident until physical arrival + belongings moved. Consider delaying liquidity event or accelerating physical move.`;
      } else {
        alertEl.classList.remove('active');
      }
    }

    // 2. Critical Period Day Count (Bracamonte)
    function calculateCriticalPeriod() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      const dayEntries = workflow.dayEntries || [];
      const addresses = workflow.addresses || [];
      const realEvents = workflow.realizationEvents || [];

      // Find critical period dates
      const newStateAddr = addresses.find(a => !a.city?.toUpperCase().includes('CA') && a.startDate);
      const firstRealEvent = realEvents.sort((a, b) => new Date(a.date) - new Date(b.date))[0];

      if (!newStateAddr || !firstRealEvent) {
        document.getElementById('criticalCADays').textContent = '--';
        document.getElementById('criticalNewStateDays').textContent = '--';
        document.getElementById('criticalPeriodResult').textContent = '--';
        return;
      }

      const startDate = new Date(newStateAddr.startDate);
      const endDate = new Date(firstRealEvent.date);

      // Count days in each location during critical period
      let caDays = 0;
      let newStateDays = 0;

      dayEntries.forEach(entry => {
        const entryDate = new Date(entry.date);
        if (entryDate >= startDate && entryDate <= endDate) {
          if (entry.location === 'CA') {
            caDays++;
          } else {
            newStateDays++;
          }
        }
      });

      document.getElementById('criticalCADays').textContent = caDays;
      document.getElementById('criticalNewStateDays').textContent = newStateDays;

      const resultEl = document.getElementById('criticalPeriodResult');
      const alertEl = document.getElementById('criticalPeriodAlert');

      if (caDays > newStateDays && caDays > 0) {
        resultEl.textContent = 'FAIL';
        resultEl.className = 'critical-period-value fail';
        alertEl.classList.add('active');
      } else if (newStateDays > 0) {
        resultEl.textContent = 'PASS';
        resultEl.className = 'critical-period-value pass';
        alertEl.classList.remove('active');
      } else {
        resultEl.textContent = '--';
        resultEl.className = 'critical-period-value';
        alertEl.classList.remove('active');
      }
    }

    // 3. Near and Dear Inventory Check (Bracamonte)
    function checkNearAndDear() {
      const items = ['invFurniture', 'invArtwork', 'invHeirlooms', 'invSentimental', 'invDocuments', 'invVehicles'];
      const inCA = items.filter(id => document.getElementById(id)?.value === 'CA');

      const alertEl = document.getElementById('nearAndDearAlert');
      const alertTextEl = document.getElementById('nearAndDearAlertText');

      if (inCA.length > 0) {
        alertEl.classList.add('active');
        alertTextEl.textContent = `${inCA.length} item category(s) still in CA. Items remaining in CA after move date suggest you haven't truly moved.`;
      } else {
        alertEl.classList.remove('active');
      }

      // Save to workflow
      saveInventoryData();
    }

    function saveInventoryData() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.inventory = {
        furniture: document.getElementById('invFurniture')?.value || '',
        artwork: document.getElementById('invArtwork')?.value || '',
        heirlooms: document.getElementById('invHeirlooms')?.value || '',
        sentimental: document.getElementById('invSentimental')?.value || '',
        documents: document.getElementById('invDocuments')?.value || '',
        vehicles: document.getElementById('invVehicles')?.value || ''
      };
      saveWorkflows();
    }

    // 4. Housing Comparison Detector (Bracamonte)
    function checkHousingComparison() {
      const caType = document.getElementById('caHousingType')?.value;
      const newType = document.getElementById('newHousingType')?.value;
      const caValue = parseFloat(document.getElementById('caHousingValue')?.value) || 0;
      const newValue = parseFloat(document.getElementById('newHousingValue')?.value) || 0;

      const alertEl = document.getElementById('housingComparisonAlert');

      // Trigger if owned CA home vs rented new state AND CA value > 2x new value
      if (caType === 'owned' && newType === 'rented' && caValue > (newValue * 2)) {
        alertEl.classList.add('active');
      } else {
        alertEl.classList.remove('active');
      }

      // Save to workflow
      saveHousingData();
    }

    function saveHousingData() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.housingComparison = {
        ca: {
          type: document.getElementById('caHousingType')?.value || '',
          value: document.getElementById('caHousingValue')?.value || '',
          sqft: document.getElementById('caHousingSqft')?.value || ''
        },
        newState: {
          type: document.getElementById('newHousingType')?.value || '',
          value: document.getElementById('newHousingValue')?.value || '',
          sqft: document.getElementById('newHousingSqft')?.value || ''
        }
      };
      saveWorkflows();
    }

    // 5. Employer Housing Flag (Mazer)
    function checkEmployerHousing() {
      const paidBy = document.getElementById('housingPaidBy')?.value;
      const leaseName = document.getElementById('leaseNamedParty')?.value;

      const alertEl = document.getElementById('employerHousingAlert');

      if (paidBy === 'employer' || leaseName === 'employer') {
        alertEl.classList.add('active');
      } else {
        alertEl.classList.remove('active');
      }

      // Save to workflow
      saveEmployerHousingData();
    }

    function saveEmployerHousingData() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.employerHousing = {
        paidBy: document.getElementById('housingPaidBy')?.value || '',
        leaseName: document.getElementById('leaseNamedParty')?.value || '',
        vehicleOwnership: document.getElementById('vehicleOwnership')?.value || ''
      };
      saveWorkflows();
    }

    // 6. Family Location Tracker (Mazer/Beckwith)
    function checkFamilyLocation() {
      const spouse = document.getElementById('spouseLocation')?.value;
      const children = document.getElementById('childrenLocation')?.value;

      const alertEl = document.getElementById('spousalLocationAlert');

      // Trigger if spouse is in CA (and not N/A)
      if (spouse === 'CA') {
        alertEl.classList.add('active');
      } else {
        alertEl.classList.remove('active');
      }

      // Save to workflow
      saveFamilyLocationData();
    }

    function saveFamilyLocationData() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.familyLocation = {
        spouse: document.getElementById('spouseLocation')?.value || '',
        children: document.getElementById('childrenLocation')?.value || '',
        dependents: document.getElementById('dependentsLocation')?.value || ''
      };
      saveWorkflows();
    }

    // 7. RSU Allocation Calculator
    function calculateRSUAllocation() {
      const grantDate = document.getElementById('rsuGrantDate')?.value;
      const vestDate = document.getElementById('rsuVestDate')?.value;
      const vestValue = parseFloat(document.getElementById('rsuVestValue')?.value) || 0;
      let totalDays = parseInt(document.getElementById('rsuTotalDays')?.value) || 0;
      const caDays = parseInt(document.getElementById('rsuCADays')?.value) || 0;

      // Auto-calculate total working days if dates provided and totalDays empty
      if (grantDate && vestDate && !totalDays) {
        const start = new Date(grantDate);
        const end = new Date(vestDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        // Rough estimate: ~5/7 are working days
        totalDays = Math.round(diffDays * 5 / 7);
        document.getElementById('rsuTotalDays').value = totalDays;
      }

      const nonCADays = totalDays - caDays;
      document.getElementById('rsuNonCADays').value = nonCADays > 0 ? nonCADays : 0;

      if (totalDays > 0 && caDays >= 0) {
        const allocPct = (caDays / totalDays) * 100;
        const caTaxable = vestValue * (caDays / totalDays);
        const nonCATaxable = vestValue - caTaxable;

        document.getElementById('rsuAllocPct').textContent = allocPct.toFixed(1) + '%';
        document.getElementById('rsuCATaxable').textContent = '$' + caTaxable.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('rsuNonCATaxable').textContent = '$' + nonCATaxable.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        document.getElementById('rsuVestTotal').textContent = '$' + vestValue.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
      } else {
        document.getElementById('rsuAllocPct').textContent = '--%';
        document.getElementById('rsuCATaxable').textContent = '$--';
        document.getElementById('rsuNonCATaxable').textContent = '$--';
        document.getElementById('rsuVestTotal').textContent = '$--';
      }

      // Save to workflow
      saveRSUData();
    }

    function saveRSUData() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.rsuCalculator = {
        grantDate: document.getElementById('rsuGrantDate')?.value || '',
        vestDate: document.getElementById('rsuVestDate')?.value || '',
        vestValue: document.getElementById('rsuVestValue')?.value || '',
        totalDays: document.getElementById('rsuTotalDays')?.value || '',
        caDays: document.getElementById('rsuCADays')?.value || ''
      };
      saveWorkflows();
    }

    // 8. Contract Type Warning (Mazer)
    function selectContractType(type) {
      // Update UI
      document.querySelectorAll('.contract-type-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      event.currentTarget.classList.add('selected');

      // Check if warning should show
      const alertEl = document.getElementById('contractTypeAlert');
      if (type === 'fixed' || type === 'renewable') {
        alertEl.classList.add('active');
      } else {
        alertEl.classList.remove('active');
      }

      // Save to workflow
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.contractType = type;
      saveWorkflows();
    }

    // Run all detectors when switching to a workflow
    function runAllDetectors() {
      checkTransitionPeriod();
      calculateCriticalPeriod();
      checkNearAndDear();
      checkHousingComparison();
      checkEmployerHousing();
      checkFamilyLocation();
      calculateRSUAllocation();

      // Restore contract type selection
      if (currentWorkflowId) {
        const workflow = workflows.find(w => w.id === currentWorkflowId);
        if (workflow?.contractType) {
          document.querySelectorAll('.contract-type-option').forEach(opt => {
            opt.classList.remove('selected');
          });
          // Find and select the matching option
          const options = document.querySelectorAll('.contract-type-option');
          const typeMap = ['fixed', 'renewable', 'atwill', 'permanent'];
          typeMap.forEach((t, i) => {
            if (t === workflow.contractType && options[i]) {
              options[i].classList.add('selected');
              if (t === 'fixed' || t === 'renewable') {
                document.getElementById('contractTypeAlert')?.classList.add('active');
              }
            }
          });
        }
      }
    }

    // Load saved detector data into forms
    function loadDetectorData() {
      if (!currentWorkflowId) return;
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      // Inventory
      if (workflow.inventory) {
        document.getElementById('invFurniture').value = workflow.inventory.furniture || '';
        document.getElementById('invArtwork').value = workflow.inventory.artwork || '';
        document.getElementById('invHeirlooms').value = workflow.inventory.heirlooms || '';
        document.getElementById('invSentimental').value = workflow.inventory.sentimental || '';
        document.getElementById('invDocuments').value = workflow.inventory.documents || '';
        document.getElementById('invVehicles').value = workflow.inventory.vehicles || '';
      }

      // Housing comparison
      if (workflow.housingComparison) {
        document.getElementById('caHousingType').value = workflow.housingComparison.ca?.type || '';
        document.getElementById('caHousingValue').value = workflow.housingComparison.ca?.value || '';
        document.getElementById('caHousingSqft').value = workflow.housingComparison.ca?.sqft || '';
        document.getElementById('newHousingType').value = workflow.housingComparison.newState?.type || '';
        document.getElementById('newHousingValue').value = workflow.housingComparison.newState?.value || '';
        document.getElementById('newHousingSqft').value = workflow.housingComparison.newState?.sqft || '';
      }

      // Employer housing
      if (workflow.employerHousing) {
        document.getElementById('housingPaidBy').value = workflow.employerHousing.paidBy || '';
        document.getElementById('leaseNamedParty').value = workflow.employerHousing.leaseName || '';
        document.getElementById('vehicleOwnership').value = workflow.employerHousing.vehicleOwnership || '';
      }

      // Family location
      if (workflow.familyLocation) {
        document.getElementById('spouseLocation').value = workflow.familyLocation.spouse || '';
        document.getElementById('childrenLocation').value = workflow.familyLocation.children || '';
        document.getElementById('dependentsLocation').value = workflow.familyLocation.dependents || '';
      }

      // RSU calculator
      if (workflow.rsuCalculator) {
        document.getElementById('rsuGrantDate').value = workflow.rsuCalculator.grantDate || '';
        document.getElementById('rsuVestDate').value = workflow.rsuCalculator.vestDate || '';
        document.getElementById('rsuVestValue').value = workflow.rsuCalculator.vestValue || '';
        document.getElementById('rsuTotalDays').value = workflow.rsuCalculator.totalDays || '';
        document.getElementById('rsuCADays').value = workflow.rsuCalculator.caDays || '';
      }

      // Run all checks
      runAllDetectors();
    }

    function toggleRoadmapTask(checkEl, taskId) {
      if (!currentWorkflowId) return;

      const roadmap = getRoadmapData(currentWorkflowId);
      if (!roadmap.tasks) roadmap.tasks = {};

      const currentStatus = roadmap.tasks[taskId]?.status || 'not_started';
      let newStatus;

      if (currentStatus === 'not_started') {
        newStatus = 'in_progress';
      } else if (currentStatus === 'in_progress') {
        newStatus = 'complete';
      } else {
        newStatus = 'not_started';
      }

      roadmap.tasks[taskId] = { status: newStatus, updatedAt: new Date().toISOString() };
      saveRoadmapData(currentWorkflowId, roadmap);

      // Update checkbox visual
      checkEl.className = 'roadmap-task-check ' + (newStatus === 'complete' ? 'complete' : newStatus === 'in_progress' ? 'in-progress' : '');
      checkEl.innerHTML = newStatus === 'complete' ? '&#10003;' : newStatus === 'in_progress' ? '&#8226;' : '';

      // Update dropdown
      const row = checkEl.closest('.roadmap-task');
      const select = row.querySelector('select');
      if (select) select.value = newStatus;

      // Log to audit ledger
      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const taskTitle = row.querySelector('.roadmap-task-title')?.textContent || taskId;
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'ROADMAP_TASK',
          content: {
            message: workflow.name + ' | ' + taskTitle + '  ' + newStatus.replace('_', ' '),
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            taskId,
            status: newStatus
          }
        })
      });

      renderRoadmapProgress();
    }

    function updateRoadmapTaskStatus(taskId, status) {
      if (!currentWorkflowId) return;

      const roadmap = getRoadmapData(currentWorkflowId);
      if (!roadmap.tasks) roadmap.tasks = {};

      roadmap.tasks[taskId] = { status, updatedAt: new Date().toISOString() };
      saveRoadmapData(currentWorkflowId, roadmap);

      // Update checkbox visual
      const taskRow = document.querySelector(`.roadmap-task[data-task="${taskId}"]`);
      if (taskRow) {
        const checkEl = taskRow.querySelector('.roadmap-task-check');
        checkEl.className = 'roadmap-task-check ' + (status === 'complete' ? 'complete' : status === 'in_progress' ? 'in-progress' : '');
        checkEl.innerHTML = status === 'complete' ? '&#10003;' : status === 'in_progress' ? '&#8226;' : '';
      }

      renderRoadmapProgress();
    }

    function renderRoadmapProgress() {
      if (!currentWorkflowId) return;

      const roadmap = getRoadmapData(currentWorkflowId);
      const tasks = roadmap.tasks || {};

      let totalTasks = 0;
      let completedTasks = 0;

      // Count by phase
      for (const [phase, taskIds] of Object.entries(ROADMAP_TASKS)) {
        let phaseComplete = 0;
        for (const taskId of taskIds) {
          totalTasks++;
          if (tasks[taskId]?.status === 'complete') {
            completedTasks++;
            phaseComplete++;
          }
        }
        const countEl = document.getElementById(`phase-${phase}-count`);
        if (countEl) countEl.textContent = `${phaseComplete}/${taskIds.length}`;
      }

      // Update overall progress
      const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      document.getElementById('roadmapProgressFill').style.width = percentage + '%';
      document.getElementById('roadmapProgressText').textContent = `${completedTasks} of ${totalTasks} complete`;
    }

    function renderRoadmap() {
      if (!currentWorkflowId) return;

      const roadmap = getRoadmapData(currentWorkflowId);
      const tasks = roadmap.tasks || {};

      // Update path selection
      document.getElementById('optionSafeHarbor').classList.toggle('selected', roadmap.path === 'safeHarbor');
      document.getElementById('optionDomicile').classList.toggle('selected', roadmap.path === 'domicile');

      // Update all task checkboxes and selects
      document.querySelectorAll('.roadmap-task').forEach(row => {
        const taskId = row.dataset.task;
        const status = tasks[taskId]?.status || 'not_started';

        const checkEl = row.querySelector('.roadmap-task-check');
        checkEl.className = 'roadmap-task-check ' + (status === 'complete' ? 'complete' : status === 'in_progress' ? 'in-progress' : '');
        checkEl.innerHTML = status === 'complete' ? '&#10003;' : status === 'in_progress' ? '&#8226;' : '';

        const select = row.querySelector('select');
        if (select) select.value = status;
      });

      renderRoadmapProgress();
    }

    // ===== SAFE HARBOR =====
    function getSafeHarbor(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.safeHarbor || {
        employer: '',
        contractStart: '',
        contractEnd: '',
        workLocation: '',
        annualIncome: 0,
        contractDoc: ''
      };
    }

    function saveSafeHarborContract() {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow) return;

      workflow.safeHarbor = {
        employer: document.getElementById('shEmployer').value,
        contractStart: document.getElementById('shContractStart').value,
        contractEnd: document.getElementById('shContractEnd').value,
        workLocation: document.getElementById('shWorkLocation').value,
        annualIncome: parseFloat(document.getElementById('shAnnualIncome').value) || 0,
        contractDoc: document.getElementById('shContractDoc').value
      };

      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'SAFE_HARBOR_UPDATE',
          content: {
            message: workflow.name + ' | Safe Harbor contract saved: ' + workflow.safeHarbor.employer,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            safeHarbor: workflow.safeHarbor
          }
        })
      });

      renderSafeHarbor();
      showToast('Safe Harbor contract saved', 'success');
    }

    function renderSafeHarbor() {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const sh = getSafeHarbor(currentWorkflowId);
      const dayEntries = getDayEntries(currentWorkflowId);

      // Populate form
      document.getElementById('shEmployer').value = sh.employer || '';
      document.getElementById('shContractStart').value = sh.contractStart || '';
      document.getElementById('shContractEnd').value = sh.contractEnd || '';
      document.getElementById('shWorkLocation').value = sh.workLocation || '';
      document.getElementById('shAnnualIncome').value = sh.annualIncome || '';
      document.getElementById('shContractDoc').value = sh.contractDoc || '';

      // Calculate metrics
      let daysOutsideCA = 0;
      let caVisitsThisYear = 0;
      const currentYear = new Date().getFullYear();

      if (sh.contractStart) {
        const contractStart = new Date(sh.contractStart);
        const today = new Date();
        const daysSinceStart = Math.floor((today - contractStart) / (1000 * 60 * 60 * 24));

        // Count CA days during contract period
        const caDaysDuringContract = dayEntries.filter(e => {
          const entryDate = new Date(e.date);
          return e.location === 'CA' && entryDate >= contractStart && entryDate <= today;
        }).length;

        daysOutsideCA = Math.max(0, daysSinceStart - caDaysDuringContract);
      }

      // CA visits this year
      caVisitsThisYear = dayEntries.filter(e => {
        return e.location === 'CA' && new Date(e.date).getFullYear() === currentYear;
      }).length;

      // Update metrics display
      document.getElementById('shDaysOutside').textContent = daysOutsideCA;
      const daysProgress = Math.min(100, Math.round((daysOutsideCA / 546) * 100));
      document.getElementById('shDaysProgress').style.width = daysProgress + '%';

      const daysStatus = daysOutsideCA >= 546 ? 'pass' : 'pending';
      document.getElementById('shDaysStatus').textContent = daysOutsideCA >= 546 ? 'PASS' : 'TRACKING';
      document.getElementById('shDaysStatus').className = 'safe-harbor-metric-status ' + daysStatus;
      document.getElementById('shDaysProgress').style.background = daysOutsideCA >= 546 ? 'var(--safe)' : 'var(--accent)';

      document.getElementById('shCAVisits').textContent = caVisitsThisYear;
      const visitsProgress = Math.min(100, Math.round((caVisitsThisYear / 45) * 100));
      document.getElementById('shVisitsProgress').style.width = visitsProgress + '%';

      const visitsStatus = caVisitsThisYear <= 45 ? 'pass' : 'fail';
      document.getElementById('shVisitsStatus').textContent = caVisitsThisYear <= 45 ? 'PASS' : 'FAIL';
      document.getElementById('shVisitsStatus').className = 'safe-harbor-metric-status ' + visitsStatus;
      document.getElementById('shVisitsProgress').style.background = caVisitsThisYear <= 45 ? 'var(--safe)' : 'var(--action)';

      const income = sh.annualIncome || 0;
      document.getElementById('shIntangibleIncome').textContent = '$' + income.toLocaleString();
      const incomeProgress = Math.min(100, Math.round((income / 200000) * 100));
      document.getElementById('shIncomeProgress').style.width = incomeProgress + '%';

      const incomeStatus = income <= 200000 ? 'pass' : 'fail';
      document.getElementById('shIncomeStatus').textContent = income <= 200000 ? 'PASS' : 'FAIL';
      document.getElementById('shIncomeStatus').className = 'safe-harbor-metric-status ' + incomeStatus;
      document.getElementById('shIncomeProgress').style.background = income <= 200000 ? 'var(--safe)' : 'var(--action)';

      // Overall badge
      const allPass = daysOutsideCA >= 546 && caVisitsThisYear <= 45 && income <= 200000;
      const anyFail = caVisitsThisYear > 45 || income > 200000;
      const badge = document.getElementById('safeHarborBadge');

      if (allPass) {
        badge.textContent = 'ELIGIBLE';
        badge.className = 'safe-harbor-badge eligible';
      } else if (anyFail) {
        badge.textContent = 'INELIGIBLE';
        badge.className = 'safe-harbor-badge ineligible';
      } else {
        badge.textContent = 'PENDING REVIEW';
        badge.className = 'safe-harbor-badge pending';
      }

      // Update requirements icons
      const reqIcons = document.querySelectorAll('#shRequirements .safe-harbor-requirement-icon');
      const reqStatuses = [
        daysOutsideCA >= 546 ? 'pass' : 'pending',
        caVisitsThisYear <= 45 ? 'pass' : 'fail',
        income <= 200000 ? 'pass' : 'fail',
        'pending' // Tax avoidance - manual verification
      ];
      const reqSymbols = { pass: '&#10003;', fail: '&#10005;', pending: '?' };

      reqIcons.forEach((icon, i) => {
        icon.className = 'safe-harbor-requirement-icon ' + reqStatuses[i];
        icon.innerHTML = reqSymbols[reqStatuses[i]];
      });
    }

    // ===== ADDRESSES =====
    function getAddresses(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.addresses || [];
    }

    function addAddress() {
      if (!currentWorkflowId) return;

      const startDate = document.getElementById('addrStartDate').value;
      const endDate = document.getElementById('addrEndDate').value;
      const street = document.getElementById('addrStreet').value;
      const city = document.getElementById('addrCity').value;

      if (!startDate || !street || !city) {
        showToast('Please fill in required fields', 'error');
        return;
      }

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.addresses) workflow.addresses = [];

      const address = {
        id: 'addr_' + Date.now(),
        startDate,
        endDate: endDate || null,
        street,
        city,
        type: city.toLowerCase().includes('ca') || city.toLowerCase().includes('california') ? 'secondary' : 'primary',
        createdAt: new Date().toISOString()
      };

      workflow.addresses.push(address);
      workflow.addresses.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'ADDRESS_ADD',
          content: {
            message: workflow.name + ' | Address added: ' + street + ', ' + city,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            address
          }
        })
      });

      // Clear form
      document.getElementById('addrStartDate').value = '';
      document.getElementById('addrEndDate').value = '';
      document.getElementById('addrStreet').value = '';
      document.getElementById('addrCity').value = '';

      renderAddresses();

      // Re-run detectors
      checkTransitionPeriod();
      calculateCriticalPeriod();

      showToast('Address added', 'success');
    }

    function deleteAddress(addrId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.addresses = workflow.addresses.filter(a => a.id !== addrId);
      saveWorkflows();
      renderAddresses();
      showToast('Address deleted', 'success');
    }

    function renderAddresses() {
      if (!currentWorkflowId) return;

      const addresses = getAddresses(currentWorkflowId);
      const container = document.getElementById('addressTimeline');

      if (addresses.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No addresses recorded yet.</div>';
        return;
      }

      container.innerHTML = addresses.map(a => {
        const isCurrent = !a.endDate;
        const isCA = a.city.toLowerCase().includes('ca') || a.city.toLowerCase().includes('california');
        return `
          <div class="address-entry">
            <div class="address-entry-dates">
              <div ${isCurrent ? 'class="address-entry-current"' : ''}>${a.startDate}</div>
              <div>${a.endDate || 'Present'}</div>
            </div>
            <div class="address-entry-info">
              <div class="address-entry-street">${a.street}</div>
              <div class="address-entry-city">${a.city}</div>
            </div>
            <span class="address-entry-type ${isCA ? 'secondary' : 'primary'}">${isCA ? 'CA' : 'Non-CA'}</span>
            <button class="day-entry-delete" onclick="deleteAddress('${a.id}')">&times;</button>
          </div>
        `;
      }).join('');
    }

    // ===== EVIDENCE REPOSITORY =====
    function getEvidence(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.evidence || [];
    }

    function handleEvidenceUpload(event) {
      const file = event.target.files[0];
      if (!file || !currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.evidence) workflow.evidence = [];

      // For now, just store metadata (actual file storage would need backend)
      const evidence = {
        id: 'ev_' + Date.now(),
        name: file.name,
        size: file.size,
        type: file.type,
        category: 'records',
        status: 'pending',
        createdAt: new Date().toISOString()
      };

      workflow.evidence.push(evidence);
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'EVIDENCE_UPLOAD',
          content: {
            message: workflow.name + ' | Evidence uploaded: ' + file.name,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            evidence
          }
        })
      });

      renderEvidence();
      showToast('Evidence added: ' + file.name, 'success');
      event.target.value = '';
    }

    function deleteEvidence(evId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.evidence = workflow.evidence.filter(e => e.id !== evId);
      saveWorkflows();
      renderEvidence();
      showToast('Evidence deleted', 'success');
    }

    function filterEvidence(category) {
      document.querySelectorAll('.evidence-category').forEach(c => c.classList.remove('active'));
      document.querySelector(`.evidence-category[onclick="filterEvidence('${category}')"]`).classList.add('active');
      renderEvidence(category);
    }

    function renderEvidence(filterCat = 'all') {
      if (!currentWorkflowId) return;

      const evidence = getEvidence(currentWorkflowId);
      const filtered = filterCat === 'all' ? evidence : evidence.filter(e => e.category === filterCat);

      // Update counts
      document.getElementById('evidenceTotal').textContent = evidence.length;
      document.getElementById('evidenceVerified').textContent = evidence.filter(e => e.status === 'verified').length;
      document.getElementById('evCatAll').textContent = evidence.length + ' items';
      document.getElementById('evCatOfficial').textContent = evidence.filter(e => e.category === 'official').length + ' items';
      document.getElementById('evCatRecords').textContent = evidence.filter(e => e.category === 'records').length + ' items';
      document.getElementById('evCatDigital').textContent = evidence.filter(e => e.category === 'digital').length + ' items';
      document.getElementById('evCatThirdparty').textContent = evidence.filter(e => e.category === 'thirdparty').length + ' items';

      const container = document.getElementById('evidenceList');
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No evidence uploaded yet.</div>';
        return;
      }

      container.innerHTML = filtered.map(e => {
        const icon = e.type?.includes('pdf') ? '&#128196;' : e.type?.includes('image') ? '&#128247;' : '&#128193;';
        const sizeKB = Math.round(e.size / 1024);
        return `
          <div class="evidence-item">
            <div class="evidence-item-icon">${icon}</div>
            <div class="evidence-item-info">
              <div class="evidence-item-name">${e.name}</div>
              <div class="evidence-item-meta">${sizeKB}KB | ${new Date(e.createdAt).toLocaleDateString()}</div>
            </div>
            <span class="evidence-item-category">${e.category}</span>
            <span class="evidence-item-status ${e.status}">${e.status}</span>
            <button class="day-entry-delete" onclick="deleteEvidence('${e.id}')">&times;</button>
          </div>
        `;
      }).join('');
    }

    // ===== REALIZATION EVENTS =====
    function getRealizationEvents(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.realizationEvents || [];
    }

    function addRealizationEvent() {
      if (!currentWorkflowId) return;

      const date = document.getElementById('realEventDate').value;
      const type = document.getElementById('realEventType').value;
      const amount = parseFloat(document.getElementById('realEventAmount').value) || 0;
      const desc = document.getElementById('realEventDesc').value;

      if (!date || !amount) {
        showToast('Please fill in date and amount', 'error');
        return;
      }

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.realizationEvents) workflow.realizationEvents = [];

      const event = {
        id: 'real_' + Date.now(),
        date,
        type,
        amount,
        description: desc,
        createdAt: new Date().toISOString()
      };

      workflow.realizationEvents.push(event);
      workflow.realizationEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'REALIZATION_EVENT',
          content: {
            message: workflow.name + ' | ' + type + ': $' + amount.toLocaleString(),
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            event
          }
        })
      });

      // Clear form
      document.getElementById('realEventDate').value = '';
      document.getElementById('realEventAmount').value = '';
      document.getElementById('realEventDesc').value = '';

      renderRealizationEvents();

      // Re-run detectors
      checkTransitionPeriod();
      calculateCriticalPeriod();

      showToast('Realization event added', 'success');
    }

    function deleteRealizationEvent(eventId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.realizationEvents = workflow.realizationEvents.filter(e => e.id !== eventId);
      saveWorkflows();
      renderRealizationEvents();
      showToast('Event deleted', 'success');
    }

    function renderRealizationEvents() {
      if (!currentWorkflowId) return;

      const events = getRealizationEvents(currentWorkflowId);
      const container = document.getElementById('realizationTimeline');

      if (events.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No realization events recorded.</div>';
        return;
      }

      const typeLabels = {
        'RSU_VEST': 'RSU Vest',
        'STOCK_SALE': 'Stock Sale',
        'OPTION_EXERCISE': 'Option Exercise',
        'BONUS': 'Bonus',
        'DEFERRED_COMP': 'Deferred Comp',
        'OTHER': 'Other'
      };

      const typeClasses = {
        'RSU_VEST': 'rsu',
        'STOCK_SALE': 'sale',
        'OPTION_EXERCISE': 'stock',
        'BONUS': 'stock',
        'DEFERRED_COMP': 'rsu',
        'OTHER': 'stock'
      };

      container.innerHTML = events.map(e => `
        <div class="timeline-event ${e.type === 'STOCK_SALE' ? 'realized' : ''}">
          <div class="timeline-event-header">
            <span class="timeline-event-date">${e.date}</span>
            <span class="timeline-event-type ${typeClasses[e.type] || 'stock'}">${typeLabels[e.type] || e.type}</span>
          </div>
          <div class="timeline-event-title">${e.description || typeLabels[e.type]}</div>
          <div class="timeline-event-amount">$${e.amount.toLocaleString()}</div>
          <button class="day-entry-delete" style="position:absolute;top:12px;right:12px;" onclick="deleteRealizationEvent('${e.id}')">&times;</button>
        </div>
      `).join('');
    }

    // ===== THIRD-PARTY REQUESTS =====
    function getRequests(workflowId) {
      const workflow = workflows.find(w => w.id === workflowId);
      return workflow?.requests || [];
    }

    function addRequest() {
      if (!currentWorkflowId) return;

      const entity = document.getElementById('reqEntity').value;
      const type = document.getElementById('reqType').value;
      const dateSent = document.getElementById('reqDateSent').value;
      const status = document.getElementById('reqStatus').value;

      if (!entity || !type) {
        showToast('Please fill in entity and type', 'error');
        return;
      }

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      if (!workflow.requests) workflow.requests = [];

      const request = {
        id: 'req_' + Date.now(),
        entity,
        type,
        dateSent: dateSent || null,
        status,
        createdAt: new Date().toISOString()
      };

      workflow.requests.push(request);
      saveWorkflows();

      // Log to audit ledger
      api('/api/audit', {
        method: 'POST',
        body: JSON.stringify({
          tenantId: DEFAULT_TENANT,
          userId: DEFAULT_USER,
          entryType: 'REQUEST_ADD',
          content: {
            message: workflow.name + ' | Request added: ' + entity + ' - ' + type,
            confidence: 'KNOWN_KNOWN',
            workflowId: currentWorkflowId,
            request
          }
        })
      });

      // Clear form
      document.getElementById('reqEntity').value = '';
      document.getElementById('reqDateSent').value = '';

      renderRequests();
      showToast('Request added', 'success');
    }

    function updateRequestStatus(reqId, newStatus) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      const request = workflow.requests.find(r => r.id === reqId);
      if (request) {
        request.status = newStatus;
        request.updatedAt = new Date().toISOString();
        saveWorkflows();
        renderRequests();
      }
    }

    function deleteRequest(reqId) {
      if (!currentWorkflowId) return;

      const workflow = workflows.find(w => w.id === currentWorkflowId);
      workflow.requests = workflow.requests.filter(r => r.id !== reqId);
      saveWorkflows();
      renderRequests();
      showToast('Request deleted', 'success');
    }

    function renderRequests() {
      if (!currentWorkflowId) return;

      const requests = getRequests(currentWorkflowId);
      const container = document.getElementById('requestsList');

      if (requests.length === 0) {
        container.innerHTML = '<div style="padding: 24px; text-align: center; color: var(--text-muted);">No requests tracked yet.</div>';
        return;
      }

      const typeLabels = {
        'EMPLOYMENT_LETTER': 'Employment Letter',
        'BANK_STATEMENT': 'Bank Statement',
        'UTILITY_RECORDS': 'Utility Records',
        'MEDICAL_RECORDS': 'Medical Records',
        'MEMBERSHIP': 'Membership',
        'OTHER': 'Other'
      };

      container.innerHTML = requests.map(r => `
        <div class="request-item">
          <div>
            <div class="request-item-entity">${r.entity}</div>
            <div class="request-item-type">${typeLabels[r.type] || r.type}</div>
          </div>
          <span class="request-item-date">${r.dateSent || 'Not sent'}</span>
          <select class="checklist-select" style="width:100px" onchange="updateRequestStatus('${r.id}', this.value)">
            <option value="PENDING" ${r.status === 'PENDING' ? 'selected' : ''}>Pending</option>
            <option value="SENT" ${r.status === 'SENT' ? 'selected' : ''}>Sent</option>
            <option value="RECEIVED" ${r.status === 'RECEIVED' ? 'selected' : ''}>Received</option>
            <option value="OVERDUE" ${r.status === 'OVERDUE' ? 'selected' : ''}>Overdue</option>
          </select>
          <span class="request-item-status ${r.status.toLowerCase()}">${r.status}</span>
          <button class="day-entry-delete" onclick="deleteRequest('${r.id}')">&times;</button>
        </div>
      `).join('');
    }

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', () => {
      loadHomeStats();
      loadPulseBar();
    });
  </script>
</body>
</html>
